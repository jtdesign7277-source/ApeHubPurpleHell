<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Chat | ApeHub</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #111118;
      --bg-card: rgba(255, 255, 255, 0.03);
      --bg-card-hover: rgba(255, 255, 255, 0.06);
      --text-primary: #fff;
      --text-secondary: rgba(255, 255, 255, 0.6);
      --text-muted: rgba(255, 255, 255, 0.4);
      --border-color: rgba(255, 255, 255, 0.15);
      --border-light: rgba(255, 255, 255, 0.1);
      --accent: #a855f7;
      --accent-glow: rgba(168, 85, 247, 0.3);
      --nav-bg: rgba(10, 10, 15, 0.95);
      --card-bg: #16161d;
      --input-bg: rgba(255, 255, 255, 0.08);
    }

    [data-theme="light"] {
      --bg-primary: #f8f9fa;
      --bg-secondary: #ffffff;
      --bg-card: rgba(0, 0, 0, 0.04);
      --bg-card-hover: rgba(0, 0, 0, 0.08);
      --text-primary: #000000;
      --text-secondary: #333333;
      --text-muted: #555555;
      --border-color: rgba(0, 0, 0, 0.15);
      --border-light: rgba(0, 0, 0, 0.1);
      --accent: #7c3aed;
      --accent-glow: rgba(124, 58, 237, 0.15);
      --nav-bg: rgba(255, 255, 255, 0.95);
      --card-bg: #ffffff;
      --input-bg: #f0f0f5;
    }

    body {
      background: var(--bg-primary);
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Instrument Sans', sans-serif;
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
      transition: background 0.3s ease, color 0.3s ease;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
      padding: 0;
      padding-bottom: calc(100px + env(safe-area-inset-bottom));
    }

    /* Top Bar */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 24px;
      padding-top: calc(12px + env(safe-area-inset-top));
    }

    .page-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .page-title span {
      color: var(--accent);
    }

    .online-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .online-dot {
      width: 6px;
      height: 6px;
      background: #00d775;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Feed Container */
    .feed-container {
      padding: 0 16px;
    }

    /* Post Card */
    .post-card {
      padding: 16px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .post-card.new-post {
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .post-header {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .post-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #a855f7 0%, #6366f1 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 700;
      color: #fff;
      flex-shrink: 0;
    }

    .post-avatar.asshole { background: linear-gradient(135deg, #ff4757 0%, #c0392b 100%); }
    .post-avatar.gambler { background: linear-gradient(135deg, #f7931a 0%, #e67e22 100%); }
    .post-avatar.woman { background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%); }
    .post-avatar.cocky { background: linear-gradient(135deg, #00d775 0%, #27ae60 100%); }
    .post-avatar.ape { background: linear-gradient(135deg, #3b82f6 0%, #2980b9 100%); }

    .post-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .post-content {
      flex: 1;
      min-width: 0;
    }

    .post-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .post-username {
      font-size: 14px;
      font-weight: 600;
      color: #5b9bd5;
    }

    .post-handle {
      font-size: 13px;
      color: #7eb8e6;
    }

    .post-dot {
      width: 3px;
      height: 3px;
      background: var(--text-muted);
      border-radius: 50%;
    }

    .post-time {
      font-size: 13px;
      color: var(--text-muted);
    }

    .post-text {
      font-size: 15px;
      line-height: 1.5;
      color: var(--text-primary);
      margin-bottom: 12px;
      word-wrap: break-word;
    }

    .post-text .ticker {
      color: var(--accent);
      font-weight: 600;
    }

    .post-text .hashtag {
      color: #3b82f6;
    }

    /* Post Actions */
    .post-actions {
      display: flex;
      align-items: center;
      gap: 24px;
    }

    .action-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 13px;
      cursor: pointer;
      padding: 8px 0;
      transition: color 0.15s, transform 0.1s;
      -webkit-tap-highlight-color: transparent;
    }

    .action-btn svg {
      width: 18px;
      height: 18px;
      transition: transform 0.15s;
    }

    .action-btn:active {
      transform: scale(0.95);
    }

    .action-btn.reply:hover,
    .action-btn.reply:active {
      color: #3b82f6;
    }

    .action-btn.like:hover,
    .action-btn.like:active {
      color: #00d775;
    }

    .action-btn.like.active {
      color: #00d775;
    }

    .action-btn.dislike:hover,
    .action-btn.dislike:active {
      color: #ff4757;
    }

    .action-btn.dislike.active {
      color: #ff4757;
    }

    /* Reply Section */
    .reply-section {
      display: none;
      margin-top: 12px;
    }

    .reply-section.open {
      display: block;
    }

    .reply-input-container {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }

    .reply-input {
      flex: 1;
      background: var(--input-bg);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      padding: 10px 16px;
      font-size: 14px;
      color: var(--text-primary);
      outline: none;
      resize: none;
      font-family: inherit;
    }

    .reply-input:focus {
      border-color: #a855f7;
    }

    .reply-send-btn {
      background: rgba(168, 85, 247, 0.15);
      border: 2px solid #a855f7;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      transition: all 0.2s;
    }

    .reply-send-btn:hover {
      background: rgba(168, 85, 247, 0.25);
    }

    .reply-send-btn svg {
      width: 16px;
      height: 16px;
      color: #a855f7;
    }

    /* Replies */
    .replies-container {
      margin-top: 12px;
    }

    .reply-card {
      display: flex;
      gap: 10px;
      padding: 10px 0;
      border-top: 1px solid var(--border-light);
    }

    .reply-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 600;
      color: #fff;
      flex-shrink: 0;
    }

    .reply-content {
      flex: 1;
    }

    .reply-meta {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }

    .reply-username {
      font-size: 13px;
      font-weight: 600;
      color: #5b9bd5;
    }

    .reply-time {
      font-size: 12px;
      color: var(--text-muted);
    }

    .reply-text {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    /* Floating Action Button */
    .fab {
      position: fixed;
      bottom: calc(90px + env(safe-area-inset-bottom));
      right: 24px;
      width: 56px;
      height: 56px;
      background: rgba(168, 85, 247, 0.15);
      border: 2px solid #a855f7;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(168, 85, 247, 0.3);
      transition: all 0.3s;
      z-index: 100;
      -webkit-tap-highlight-color: transparent;
    }

    .fab:hover {
      background: rgba(168, 85, 247, 0.25);
      transform: scale(1.05);
    }

    .fab:active {
      transform: scale(0.95);
    }

    .fab svg {
      width: 24px;
      height: 24px;
      color: #a855f7;
      transition: transform 0.3s;
    }

    .fab.open svg {
      transform: rotate(45deg);
    }

    /* Compose Modal */
    .compose-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
      z-index: 200;
    }

    .compose-overlay.open {
      opacity: 1;
      visibility: visible;
    }

    .compose-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      width: calc(100% - 32px);
      max-width: 400px;
      margin: 0;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      padding: 0;
      opacity: 0;
      visibility: hidden;
      transition: all 0.25s ease;
      z-index: 201;
    }

    .compose-modal.open {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
      visibility: visible;
    }

    .compose-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color);
    }

    .compose-cancel {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 15px;
      cursor: pointer;
      padding: 8px;
    }

    .compose-submit {
      background: #a855f7;
      border: none;
      border-radius: 20px;
      padding: 8px 20px;
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .compose-submit:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .compose-body {
      display: flex;
      gap: 12px;
      padding: 16px 20px;
    }

    .compose-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #a855f7 0%, #6366f1 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 700;
      color: #fff;
      flex-shrink: 0;
    }

    .compose-input {
      flex: 1;
      background: transparent;
      border: none;
      font-size: 16px;
      color: var(--text-primary);
      outline: none;
      resize: none;
      min-height: 80px;
      font-family: inherit;
      line-height: 1.5;
    }

    .compose-input::placeholder {
      color: var(--text-muted);
    }

    .compose-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.15);
    }

    .compose-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .attach-btn {
      background: none;
      border: none;
      color: var(--accent);
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .attach-btn:hover {
      background: rgba(168, 85, 247, 0.15);
    }

    .attach-btn svg {
      width: 22px;
      height: 22px;
    }

    .attach-input {
      display: none;
    }

    .image-preview {
      position: relative;
      margin: 12px 20px;
      border-radius: 12px;
      overflow: hidden;
      display: none;
    }

    .image-preview.active {
      display: block;
    }

    .image-preview img {
      width: 100%;
      max-height: 200px;
      object-fit: cover;
      border-radius: 12px;
      border: 1px solid var(--border-color);
    }

    .remove-image {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0, 0, 0, 0.7);
      border: none;
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .remove-image:hover {
      background: rgba(255, 71, 87, 0.9);
    }

    .remove-image svg {
      width: 16px;
      height: 16px;
    }

    .char-count {
      font-size: 12px;
      color: var(--text-muted);
    }

    .char-count.warning {
      color: #f59e0b;
    }

    .char-count.danger {
      color: #ff4757;
    }

    .post-image {
      margin-top: 12px;
      border-radius: 12px;
      overflow: hidden;
    }

    .post-image img {
      width: 100%;
      max-height: 300px;
      object-fit: cover;
      border-radius: 12px;
      border: 1px solid var(--border-color);
    }

    /* Bottom Nav */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-primary);
      border-top: 1px solid rgba(255, 255, 255, 0.6);
      display: flex;
      justify-content: space-around;
      padding: 12px 0 28px;
      max-width: 500px;
      margin: 0 auto;
      z-index: 50;
    }

    .bottom-nav {
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      color: var(--text-muted);
      text-decoration: none;
      font-size: 11px;
      transition: color 0.2s;
    }

    .nav-item.active {
      color: var(--accent);
    }

    .nav-item svg {
      width: 24px;
      height: 24px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 24px;
      color: var(--text-muted);
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    .empty-state h3 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-secondary);
    }

    .empty-state p {
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Top Bar -->
    <div class="top-bar">
      <h1 class="page-title">Ape<span>Chat</span></h1>
      <div class="online-badge">
        <div class="online-dot"></div>
        <span id="online-count">187 online</span>
      </div>
    </div>

    <!-- Feed -->
    <div class="feed-container" id="feed">
      <!-- Posts will be dynamically inserted here -->
    </div>
  </div>

  <!-- Floating Action Button -->
  <button class="fab" id="fab" onclick="toggleCompose()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <line x1="12" y1="5" x2="12" y2="19"></line>
      <line x1="5" y1="12" x2="19" y2="12"></line>
    </svg>
  </button>

  <!-- Compose Modal -->
  <div class="compose-overlay" id="compose-overlay" onclick="toggleCompose()"></div>
  <div class="compose-modal" id="compose-modal">
    <div class="compose-header">
      <button class="compose-cancel" onclick="toggleCompose()">Cancel</button>
      <button class="compose-submit" id="compose-submit" onclick="submitPost()" disabled>Post</button>
    </div>
    <div class="compose-body">
      <div class="compose-avatar">J</div>
      <textarea class="compose-input" id="compose-input" placeholder="What's happening in the market?" maxlength="280" oninput="updateCharCount()"></textarea>
    </div>
    <div class="image-preview" id="image-preview">
      <img id="preview-img" src="" alt="Preview">
      <button class="remove-image" onclick="removeAttachment()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="compose-footer">
      <div class="compose-actions">
        <input type="file" id="attach-input" class="attach-input" accept="image/*" onchange="handleAttachment(event)">
        <label for="attach-input" class="attach-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
          </svg>
        </label>
      </div>
      <div class="char-count" id="char-count">0 / 280</div>
    </div>
  </div>

  <!-- Bottom Nav -->
  <nav class="bottom-nav">
    <a href="dashboard.html" class="nav-item">
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 3L2 12h3v8h6v-6h2v6h6v-8h3L12 3z"/>
      </svg>
      <span>Home</span>
    </a>
    <a href="news.html" class="nav-item">
      <svg viewBox="0 0 16 16" fill="currentColor">
        <path d="M8 0C8 4.418 4.418 8 0 8C4.418 8 8 11.582 8 16C8 11.582 11.582 8 16 8C11.582 8 8 4.418 8 0Z"/>
      </svg>
      <span>News</span>
    </a>
    <a href="charts.html" class="nav-item">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M6 4v4M6 14v6M6 8h0M6 14h0"/>
        <rect x="4" y="8" width="4" height="6" rx="1" fill="currentColor"/>
        <path d="M12 2v6M12 12v10M12 8h0M12 12h0"/>
        <rect x="10" y="8" width="4" height="4" rx="1"/>
        <path d="M18 6v4M18 16v4M18 10h0M18 16h0"/>
        <rect x="16" y="10" width="4" height="6" rx="1" fill="currentColor"/>
      </svg>
      <span>Charts</span>
    </a>
    <a href="markets.html" class="nav-item">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <circle cx="12" cy="12" r="5"/>
        <ellipse cx="12" cy="12" rx="10" ry="3" transform="rotate(-20 12 12)"/>
      </svg>
      <span>Markets</span>
    </a>
    <a href="chat.html" class="nav-item active">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2C6.48 2 2 6.48 2 12c0 1.85.5 3.58 1.36 5.08L2 22l4.92-1.36C8.42 21.5 10.15 22 12 22c5.52 0 10-4.48 10-10S17.52 2 12 2z"/>
      </svg>
      <span>Chat</span>
    </a>
  </nav>

  <script>
    // Max 222 AI community members
    const MAX_COMMUNITY_SIZE = 222;

    // Current user (real user) - will be updated from localStorage
    const currentUser = {
      name: 'User',
      handle: '@user',
      avatar: 'U',
      avatarType: 'initial',
      type: 'normal'
    };

    // Load user info from localStorage
    function loadCurrentUser() {
      const firstName = localStorage.getItem('userFirstName') || 'User';
      const lastName = localStorage.getItem('userLastName') || '';
      const email = localStorage.getItem('userEmail') || '';
      const savedAvatar = JSON.parse(localStorage.getItem('userAvatar') || 'null');
      
      console.log('Loading user avatar:', savedAvatar);
      
      currentUser.name = firstName + (lastName ? ' ' + lastName : '');
      // Use email username as handle (before @) to match how posts are created
      const emailHandle = email ? email.split('@')[0] : firstName.toLowerCase();
      currentUser.handle = '@' + emailHandle;
      
      console.log('Current user handle:', currentUser.handle);
      
      if (savedAvatar && savedAvatar.value) {
        if (savedAvatar.type === 'emoji') {
          currentUser.avatar = savedAvatar.value;
          currentUser.avatarType = 'emoji';
        } else if (savedAvatar.type === 'image' || savedAvatar.type === 'boring' || savedAvatar.type === 'dicebear' || savedAvatar.type === 'trading' || savedAvatar.type === 'multiavatar') {
          currentUser.avatar = savedAvatar.value;
          currentUser.avatarType = 'image';
          console.log('Avatar set to image:', currentUser.avatar);
        } else {
          // Unknown type but has value - treat as image
          currentUser.avatar = savedAvatar.value;
          currentUser.avatarType = 'image';
          console.log('Avatar unknown type, treating as image:', savedAvatar.type);
        }
      } else {
        currentUser.avatar = firstName.charAt(0).toUpperCase();
        currentUser.avatarType = 'initial';
        console.log('No avatar found, using initial:', currentUser.avatar);
      }
      
      // Update compose avatar
      updateComposeAvatar();
    }
    
    function updateComposeAvatar() {
      const composeAvatar = document.querySelector('.compose-avatar');
      if (composeAvatar) {
        if (currentUser.avatarType === 'image') {
          composeAvatar.innerHTML = `<img src="${currentUser.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
        } else if (currentUser.avatarType === 'emoji') {
          composeAvatar.textContent = currentUser.avatar;
        } else {
          composeAvatar.textContent = currentUser.avatar;
        }
      }
    }
    
    function getUserAvatarHTML() {
      if (currentUser.avatarType === 'image') {
        return `<img src="${currentUser.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
      }
      return currentUser.avatar;
    }

    // ============================================
    // 200 BOT SYSTEM - REALISTIC AI SIMULATION
    // ============================================
    
    // Bot usernames - trading themed (200 unique)
    const BOT_USERNAMES = [
      'DiamondDave', 'CryptoKing99', 'BearishBob', 'MoonShotMike', 'TendieQueen', 'ChartMaster', 'DipBuyer420', 
      'OptionsWiz', 'SwingTraderX', 'BullRunBenny', 'GreenCandle', 'RedDayRay', 'FOMOFred', 'HodlHank', 
      'PaperHandsPete', 'RocketRider', 'TheTrendIsUrFriend', 'CallsOnly', 'PutsGuy', 'YoloYoda', 
      'VolatilityVince', 'ThetaGang', 'GammaGang', 'SPYder', 'QQQueenB', 'NasdaqNate', 'DowJonesDan',
      'MarginCallMike', 'ShortSqueezer', 'LongTermLarry', 'ScalpKing', 'PreMarketPro', 'AfterHoursAce',
      'EarningsEddie', 'DividendDude', 'GrowthGuru', 'ValueVictor', 'MomentumMax', 'BreakoutBrad',
      'SupportSally', 'ResistanceRick', 'FibonacciFrank', 'MACDManny', 'RSIRandy', 'BollingerBill',
      'VWAPVicky', 'IchimokuIke', 'ElliottWaveEd', 'PatternPaul', 'CandleChris', 'DojiDan',
      'HammerHenry', 'EngulfingEvan', 'MorningStar99', 'EveningStar42', 'TripleTopTom', 'DoubleBottom',
      'HeadShoulders', 'FlagPattern', 'WedgeTrade', 'ChannelChad', 'TrendlineTina', 'GapTrader',
      'VolumeViking', 'LiquidityLuke', 'OrderFlowOscar', 'DarkPoolDave', 'SmartMoney', 'DumbMoney420',
      'RetailRicky', 'InstitutionalIvy', 'AlgoAndy', 'QuantQueen', 'BacktestBob', 'LiveTraderLeo',
      'PaperTrader', 'SimulatorSam', 'RealMoneyRon', 'CashGangCarl', 'AllInAlex', 'HedgedHarry',
      'NakedOptions', 'CoveredCalls', 'IronCondor', 'StrangleSteve', 'StraddleSue', 'ButterflyBeth',
      'CalendarSpread', 'VerticalVic', 'DiagonalDiana', 'CreditSpread', 'DebitDebbie', 'RatioRalph',
      'JadeLizard', 'BrokenWingBob', 'ZebraTrade', 'ComboTrader', 'SyntheticSal', 'ConversionCarl',
      'ReversalRay', 'BoxSpread', 'JellyRoll', 'RiskReversal', 'CollarCarol', 'ProtectivePut',
      'MarriedPut', 'CashSecured', 'WheelStrategy', 'PMCCPete', 'LEAPsLarry', 'WeeklyWarrior',
      'DailyDegen', 'ZeroDTE', 'ExpirationEve', 'AssignmentAndy', 'ExerciseEmma', 'RolloverRob',
      'GreeksGeek', 'DeltaDan', 'ThetaThad', 'VegaVince', 'GammaGary', 'RhoRhonda',
      'ImpliedIvan', 'HistoricalHank', 'SkewSteve', 'SmileSally', 'TermStructure', 'VolSurface',
      'MeanReversion', 'TrendFollow', 'BreakoutBetty', 'FadeThMove', 'BuyTheDip', 'SellTheRip',
      'CatchKnife', 'BottomFisher', 'TopPicker', 'ScalperSteve', 'PositionPete', 'SwingKing',
      'DayTraderDan', 'IntraDayIra', 'OvernightOllie', 'MultiDayMike', 'WeekTrader', 'MonthlyMel',
      'QuarterlyQuinn', 'YearlyYvonne', 'DecadeDave', 'LongHaul', 'ShortTerm', 'MidTermMary',
      'MacroMike', 'MicroMary', 'SectorSam', 'IndustryIvy', 'CompanyCarl', 'IndexIrene',
      'ETFEddie', 'MutualFundMike', 'HedgeFundHank', 'PrivateEquity', 'VentureVic', 'AngelAmy',
      'CrowdFund', 'ICOIvan', 'TokenTom', 'CoinCarl', 'NFTNancy', 'DeFiDave', 'YieldFarmer',
      'StakeSteve', 'MineMax', 'HashHenry', 'BlockBob', 'ChainChris', 'NodeNate', 'ValidatorVic',
      'ProofOfWork', 'ProofOfStake', 'ConsensusCarl', 'ForkFred', 'AirdropAndy', 'BountyBob',
      'WhitepaperWill', 'RoadmapRon', 'TokenomicsTom', 'MarketCapMike', 'VolumeVince', 'LiqPoolLarry',
      'SlippageSam', 'GasGary', 'BridgeBob', 'WrappedWill', 'PeggedPete', 'StableSue',
      'AlgoStable', 'FiatFred', 'RampRicky', 'OffRampOllie', 'CustodyCarl', 'WalletWill',
      'HotWallet', 'ColdStorage', 'SeedPhrase', 'PrivateKey', 'PublicAddr', 'TxHash',
      'BlockExplorer', 'ChainAnalysis', 'OnChainOscar', 'OffChainOllie', 'Layer1Larry', 'Layer2Leo',
      'RollupRon', 'SidechainSam', 'PlasmaPatty', 'ShardingSheryl', 'StateChan', 'PayChan',
      'LightningLarry', 'RaidenRay', 'PolygonPete', 'ArbitrumAndy', 'OptimismOllie', 'zkSyncZack',
      'StarkSteve', 'LoopringLeo', 'ImmutableIvy', 'OMGCarl', 'BobaTrader', 'MetisMike'
    ];
    
    // Display names with optional emojis
    const DISPLAY_STYLES = ['plain', 'emoji', 'emoji_end'];
    const EMOJIS = ['ðŸ’Ž', 'ðŸš€', 'ðŸ“ˆ', 'ðŸ’°', 'ðŸ”¥', 'âš¡', 'ðŸŽ¯', 'ðŸ’ª', 'ðŸ¦', 'ðŸ‚', 'ðŸ»', 'ðŸ‘‘', 'âœ¨', 'ðŸ’µ'];
    
    // Bios
    const BIOS = [
      'buy high sell low', 'not financial advice', 'full time degen', 'charts dont lie',
      'diamond hands only', 'in it for the tech', 'NFA DYOR', 'professional bag holder',
      'tendies or bust', 'born to trade', 'sleep is overrated', 'money printer go brrr',
      'trust the process', 'scared money dont make money', 'risk it for the biscuit',
      'options enthusiast', 'swing trader', 'day trader', 'long term investor',
      'crypto native', 'degen since 2020', 'stonks only go up', 'bears r fuk'
    ];
    
    // Generate 200 bot profiles
    const BOTS = BOT_USERNAMES.map((username, i) => {
      // All bots use the fun 3D cartoon avataaars style
      const avatarUrl = `https://api.dicebear.com/7.x/avataaars/svg?seed=${username}&size=120&backgroundColor=b6e3f4,c0aede,d1d4f9,ffd5dc,ffdfbf,65c9ff,8be9fd,9c88ff,ff6b9d,ffeaa7&mouth=smile,twinkle,default&eyes=happy,default,wink&clothesColor=3c4f5c,65c9ff,5199e4,25557c,e6e6e6,929598,a7ffc4,ffdeb5,ffafb9,ffffb1,ff488e,ff5c5c,b1e2ff`;
      
      const style = DISPLAY_STYLES[Math.floor(Math.random() * DISPLAY_STYLES.length)];
      const emoji = EMOJIS[Math.floor(Math.random() * EMOJIS.length)];
      let displayName = username.replace(/([A-Z])/g, ' $1').trim().replace(/(\d+)/g, '');
      if (style === 'emoji') displayName = emoji + ' ' + displayName;
      if (style === 'emoji_end') displayName = displayName + ' ' + emoji;
      
      // Power users (20% post more frequently)
      const frequency = i < 40 ? 'high' : (i < 100 ? 'medium' : 'low');
      
      const joinDate = new Date(Date.now() - Math.random() * 730 * 24 * 60 * 60 * 1000);
      
      return {
        id: `bot_${i.toString().padStart(3, '0')}`,
        username: username,
        handle: `@${username.toLowerCase()}`,
        displayName: displayName,
        avatarUrl: avatarUrl,
        bio: BIOS[Math.floor(Math.random() * BIOS.length)],
        followers: Math.floor(Math.random() * 5000) + 50,
        following: Math.floor(Math.random() * 500) + 20,
        joined: joinDate.toISOString().split('T')[0],
        frequency: frequency
      };
    });
    
    // ============================================
    // POST CONTENT TEMPLATES - REALISTIC
    // ============================================
    
    const POST_TEMPLATES = {
      // MARKET COMMENTARY (30%)
      market: [
        '$BTC looking strong at this level ðŸ‘€', 'anyone else seeing this setup on ETH?',
        'this dip is free money lol', 'not touching anything until after FOMC',
        '$SPY just broke resistance', 'ES looking weak here', 'NQ holding up better than expected',
        '$NVDA going crazy today', 'semis leading the market rn', 'tech looking heavy',
        'financials finally waking up', 'XLF breakout incoming', 'energy sector looks cooked',
        'bonds selling off hard', 'TLT getting destroyed', '10yr at 4.5 is wild',
        'VIX too low imo', 'put/call ratio at extremes', 'breadth looking sus',
        'small caps lagging badly', 'IWM needs to catch up', 'rotation out of growth',
        'value having a moment', 'cyclicals leading', 'defensives catching a bid',
        '$AAPL holding 250 nicely', '$TSLA below 200 is crazy', '$AMZN breakout soon?',
        '$GOOGL undervalued here', '$META printing money', '$MSFT cloud numbers insane',
        'mag 7 carrying the market again', 'equal weight getting crushed', 'concentration risk is real',
        'china stocks looking interesting', 'emerging markets bouncing', 'japan breaking out',
        'DXY strength killing everything', 'gold at ATH makes sense', 'silver lagging',
        'oil cant catch a bid', 'nat gas at multiyear lows', 'uranium still running'
      ],
      // WINS/LOSSES (20%)
      wins: [
        'up 12% today lets gooo ðŸš€', 'just got stopped out. pain.', 'finally green after 3 red days',
        'small win but ill take it +$340', 'hit my target closed the trade', 'best trade of the week',
        'account at ATH rn', 'revenge traded and actually won lol', 'caught that move perfectly',
        'shouldve sized up', 'took profits too early but whatever', 'letting winners run for once',
        'down 2% today could be worse', 'flat day hate this chop', 'gave back all my gains smh',
        'stopped out twice in a row', 'overtraded today losing my edge', 'need to take a break',
        'worst week in months', 'blew my monthly gains in one day', 'humbled again',
        '+$2k day not bad', '+500 on that scalp', 'closed for +15%', 'locked in profits',
        'up 50% on this position', 'my calls are printing', 'puts finally paying off',
        'held through the dip and won', 'averaged down and it worked', 'got lucky tbh'
      ],
      // QUESTIONS (15%)  
      questions: [
        'whats everyones PT on this?', 'am i crazy or is this a head and shoulders?',
        'anyone still holding?', 'thoughts on entering here?', 'too late to buy?',
        'should i take profits?', 'hold through earnings?', 'anyone playing earnings?',
        'whats the catalyst?', 'why is this pumping?', 'why is this dumping?',
        'is this the bottom?', 'is this the top?', 'where do we go from here?',
        'anyone have a target?', 'stop loss where?', 'position size recommendations?',
        'calls or puts?', 'weekly or monthly?', 'ITM or OTM?',
        'anyone else in this trade?', 'how long you holding?', 'exit strategy?',
        'what am i missing here?', 'is this a trap?', 'bull trap or real breakout?',
        'bear trap?', 'dead cat bounce?', 'capitulation soon?'
      ],
      // CASUAL/SOCIAL (20%)
      casual: [
        'gm', 'gn', 'another day another dollar', 'coffee and charts â˜•', 'wen lambo',
        'this is the way', 'lets get this bread', 'time to make some money',
        'market open soon ðŸ‘€', 'premarket looking spicy', 'AH action interesting',
        'slow day huh', 'this chop is killing me', 'need some volatility',
        'taking the day off', 'touching grass today', 'mental health day',
        'back from vacation what did i miss', 'just woke up anything happen?',
        'charts looking boring', 'nothing to trade rn', 'sitting on hands',
        'cash gang for now', 'waiting for a setup', 'patience paying off',
        'love this community', 'learn something new everyday', 'still learning',
        'trading is hard', 'getting better tho', 'small progress', 'one day at a time',
        'lfg ðŸš€', 'wagmi', 'ngmi', 'bullish af', 'bearish vibes', 'idk man',
        'lol', 'lmao', 'bruh', 'bro what', 'wild', 'insane', 'crazy day'
      ],
      // REPLIES (15%)
      replies: [
        'facts', 'this is the move', 'idk man looks risky', 'lmaooo', 'same', 'W',
        'bro what ðŸ˜‚', 'real', 'fr fr', 'no cap', 'true', 'agreed', 'disagree but ok',
        'interesting take', 'hadnt thought of that', 'good point', 'fair enough',
        'nah', 'yes', 'maybe', 'depends', 'need more info', 'show the chart',
        'position or ban', 'proof?', 'source?', 'trust me bro', 'in bro we trust',
        'nice trade', 'congrats', 'gg', 'rip', 'F', 'L', 'massive W',
        'this aged well', 'this aged badly', 'told you so', 'called it',
        'copium', 'hopium', 'based', 'cringe', 'valid', 'underrated comment'
      ]
    };
    
    // Combine all templates with weights
    function getRandomPostContent() {
      const rand = Math.random() * 100;
      let templates;
      if (rand < 30) templates = POST_TEMPLATES.market;
      else if (rand < 50) templates = POST_TEMPLATES.wins;
      else if (rand < 65) templates = POST_TEMPLATES.questions;
      else if (rand < 85) templates = POST_TEMPLATES.casual;
      else templates = POST_TEMPLATES.replies;
      
      let text = templates[Math.floor(Math.random() * templates.length)];
      
      // 40% chance to be lowercase
      if (Math.random() < 0.4) text = text.toLowerCase();
      
      // 5% chance of minor typo
      if (Math.random() < 0.05) {
        const typos = [
          [' the ', ' teh '], [' and ', ' adn '], ['ing ', 'ig '], 
          ['tion', 'toin'], [' to ', ' ot '], ['this', 'tihs']
        ];
        const typo = typos[Math.floor(Math.random() * typos.length)];
        text = text.replace(typo[0], typo[1]);
      }
      
      return text;
    }
    
    // Get random bot (weighted by frequency)
    function getRandomBot() {
      const rand = Math.random();
      let pool;
      if (rand < 0.6) pool = BOTS.filter(b => b.frequency === 'high');
      else if (rand < 0.9) pool = BOTS.filter(b => b.frequency === 'medium');
      else pool = BOTS.filter(b => b.frequency === 'low');
      return pool[Math.floor(Math.random() * pool.length)];
    }
    
    // Format time ago
    function formatTimeAgo(timestamp) {
      const now = Date.now();
      const diff = now - timestamp;
      const mins = Math.floor(diff / 60000);
      const hrs = Math.floor(diff / 3600000);
      if (mins < 1) return 'now';
      if (mins < 60) return `${mins}m`;
      if (hrs < 24) return `${hrs}h`;
      return `${Math.floor(hrs / 24)}d`;
    }
    
    // Generate random engagement
    function generateEngagement() {
      const rand = Math.random();
      let likes, dislikes;
      if (rand < 0.05) {
        // Viral post (5%)
        likes = Math.floor(Math.random() * 150) + 50;
        dislikes = Math.floor(Math.random() * 15);
      } else if (rand < 0.3) {
        // Popular post (25%)
        likes = Math.floor(Math.random() * 40) + 10;
        dislikes = Math.floor(Math.random() * 8);
      } else {
        // Normal post (70%)
        likes = Math.floor(Math.random() * 15) + 1;
        dislikes = Math.floor(Math.random() * 4);
      }
      return { likes, dislikes };
    }
    
    // Generate bot post
    function generateBotPost() {
      const bot = getRandomBot();
      const content = getRandomPostContent();
      const engagement = generateEngagement();
      
      return {
        id: nextPostId++,
        user: {
          name: bot.displayName,
          handle: bot.handle,
          avatar: bot.avatarUrl,
          avatarType: 'image',
          type: 'normal',
          isBot: true
        },
        text: content,
        time: 'now',
        timestamp: Date.now(),
        likes: engagement.likes,
        dislikes: engagement.dislikes,
        liked: false,
        disliked: false,
        replies: []
      };
    }
    
    // Generate reply to a post
    function generateBotReply(parentPost) {
      const bot = getRandomBot();
      const replyContent = POST_TEMPLATES.replies[Math.floor(Math.random() * POST_TEMPLATES.replies.length)];
      
      return {
        user: {
          name: bot.displayName,
          handle: bot.handle,
          avatar: bot.avatarUrl,
          avatarType: 'image',
          type: 'normal',
          isBot: true
        },
        text: Math.random() < 0.4 ? replyContent.toLowerCase() : replyContent,
        time: 'now',
        timestamp: Date.now()
      };
    }
    
    // Calculate next post interval based on time of day
    function getNextPostInterval() {
      const hour = new Date().getHours();
      let baseMin, baseMax;
      
      if (hour >= 9 && hour < 16) {
        // Market hours - faster
        baseMin = 5 * 60 * 1000;  // 5 min
        baseMax = 8 * 60 * 1000;  // 8 min
      } else if (hour >= 0 && hour < 6) {
        // Night - slower
        baseMin = 15 * 60 * 1000; // 15 min
        baseMax = 20 * 60 * 1000; // 20 min
      } else {
        // Normal hours
        baseMin = 8 * 60 * 1000;  // 8 min
        baseMax = 12 * 60 * 1000; // 12 min
      }
      
      // Add randomness (+/- 2 min)
      const jitter = (Math.random() - 0.5) * 4 * 60 * 1000;
      return Math.floor(Math.random() * (baseMax - baseMin) + baseMin + jitter);
    }
    
    // Schedule next bot post
    function scheduleBotPost() {
      const interval = getNextPostInterval();
      console.log(`Next bot post in ${Math.round(interval / 60000)} minutes`);
      
      setTimeout(() => {
        const newPost = generateBotPost();
        posts.unshift(newPost);
        
        // Insert into DOM
        const feed = document.getElementById('feed');
        const newPostHTML = renderPostHTML(newPost);
        feed.insertAdjacentHTML('afterbegin', newPostHTML);
        document.getElementById(`post-${newPost.id}`).classList.add('new-post');
        
        // Maybe add replies later
        maybeScheduleReplies(newPost);
        
        savePosts();
        scheduleBotPost(); // Schedule next
      }, interval);
    }
    
    // Maybe schedule replies to a post
    function maybeScheduleReplies(post) {
      const rand = Math.random();
      let replyCount = 0;
      
      if (rand < 0.6) return; // 60% get no replies
      if (rand < 0.9) replyCount = Math.floor(Math.random() * 3) + 1; // 30% get 1-3
      else replyCount = Math.floor(Math.random() * 5) + 4; // 10% get 4-8
      
      for (let i = 0; i < replyCount; i++) {
        const delay = (Math.random() * 29 + 1) * 60 * 1000; // 1-30 min delay
        setTimeout(() => {
          const reply = generateBotReply(post);
          const postIndex = posts.findIndex(p => p.id === post.id);
          if (postIndex !== -1) {
            posts[postIndex].replies.push(reply);
            
            // Update DOM
            const repliesContainer = document.getElementById(`replies-${post.id}`);
            const replyCountEl = document.getElementById(`reply-count-${post.id}`);
            if (repliesContainer) {
              const replyHTML = renderReplyHTML(reply, post.id);
              repliesContainer.insertAdjacentHTML('beforeend', replyHTML);
            }
            if (replyCountEl) {
              replyCountEl.textContent = posts[postIndex].replies.length;
            }
            savePosts();
          }
        }, delay);
      }
    }
    
    // Render single reply HTML
    function renderReplyHTML(reply, postId) {
      let avatarContent = reply.user.avatar;
      if (reply.user.avatarType === 'image') {
        avatarContent = `<img src="${reply.user.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
      }
      return `
        <div class="reply-card">
          <div class="reply-avatar">${avatarContent}</div>
          <div class="reply-content">
            <div class="reply-meta">
              <span class="reply-username">${reply.user.name}</span>
              <span class="reply-time">${reply.time}</span>
            </div>
            <div class="reply-text">${reply.text}</div>
          </div>
        </div>
      `;
    }

    // Initial posts
    let posts = [];
    let nextPostId = 1;

    function initializePosts() {
      const savedPosts = localStorage.getItem('apehub_posts_v4');
      if (savedPosts) {
        posts = JSON.parse(savedPosts);
        nextPostId = posts.length > 0 ? Math.max(...posts.map(p => p.id)) + 1 : 1;
        // Start bot simulation
        scheduleBotPost();
        return;
      }

      // Generate initial feed with bot posts
      const initialCount = 20;
      for (let i = 0; i < initialCount; i++) {
        const post = generateBotPost();
        post.id = i + 1;
        post.timestamp = Date.now() - (i * 180000); // Space out by 3 min each
        post.time = formatTimeAgo(post.timestamp);
        
        // Add some replies to older posts
        if (i > 5 && Math.random() < 0.4) {
          const replyCount = Math.floor(Math.random() * 3) + 1;
          for (let j = 0; j < replyCount; j++) {
            post.replies.push(generateBotReply(post));
          }
        }
        
        posts.push(post);
      }
      
      nextPostId = initialCount + 1;
      savePosts();
      scheduleBotPost();
    }

    // Render all posts (only called once on init)
    function renderPosts() {
      const feed = document.getElementById('feed');
      
      if (posts.length === 0) {
        feed.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            </svg>
            <h3>No posts yet</h3>
            <p>Be the first to share something!</p>
          </div>
        `;
        return;
      }

      feed.innerHTML = posts.map(post => renderPostHTML(post)).join('');
    }

    // Render single post HTML
    function renderPostHTML(post) {
      const avatarClass = post.user.type && post.user.type !== 'normal' ? post.user.type : '';
      const isCurrentUser = post.user.handle === currentUser.handle;
      let avatarContent = post.user.avatar;
      
      // For current user's posts, use their latest saved avatar
      if (isCurrentUser) {
        avatarContent = currentUser.avatarType === 'image' 
          ? `<img src="${currentUser.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">` 
          : currentUser.avatar;
      } else if (post.user.avatarType === 'image') {
        // For other users with image avatars
        avatarContent = `<img src="${post.user.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
      }
      
      return `
        <div class="post-card" id="post-${post.id}">
          <div class="post-header">
            <div class="post-avatar ${avatarClass}">${avatarContent}</div>
            <div class="post-content">
              <div class="post-meta">
                <span class="post-username">${post.user.name}</span>
                <span class="post-handle">${post.user.handle}</span>
                <div class="post-dot"></div>
                <span class="post-time">${post.time}</span>
              </div>
              <div class="post-text">${formatPostText(post.text)}</div>
              ${post.image ? `<div class="post-image"><img src="${post.image}" alt="Post image"></div>` : ''}
              <div class="post-actions">
                <button class="action-btn reply" onclick="toggleReply(${post.id})">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                  </svg>
                  <span id="reply-count-${post.id}">${post.replies.length || ''}</span>
                </button>
                <button class="action-btn like ${post.liked ? 'active' : ''}" id="like-btn-${post.id}" onclick="toggleLike(${post.id})">
                  <svg viewBox="0 0 24 24" fill="${post.liked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
                    <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/>
                  </svg>
                  <span id="like-count-${post.id}">${post.likes}</span>
                </button>
                <button class="action-btn dislike ${post.disliked ? 'active' : ''}" id="dislike-btn-${post.id}" onclick="toggleDislike(${post.id})">
                  <svg viewBox="0 0 24 24" fill="${post.disliked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
                    <path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"/>
                  </svg>
                  <span id="dislike-count-${post.id}">${post.dislikes}</span>
                </button>
              </div>
              
              <div class="reply-section" id="reply-section-${post.id}">
                <div class="reply-input-container">
                  <input type="text" class="reply-input" id="reply-input-${post.id}" placeholder="Post your reply..." onkeypress="handleReplyKeypress(event, ${post.id})">
                  <button class="reply-send-btn" onclick="submitReply(${post.id})">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="22" y1="2" x2="11" y2="13"></line>
                      <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                  </button>
                </div>
              </div>
              
              <div class="replies-container" id="replies-${post.id}">
                ${post.replies.map(reply => {
                  const isCurrentUserReply = reply.user.handle === currentUser.handle;
                  let replyAvatarContent = reply.user.avatar;
                  // For current user's replies, use their latest saved avatar
                  if (isCurrentUserReply) {
                    replyAvatarContent = currentUser.avatarType === 'image' 
                      ? `<img src="${currentUser.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">` 
                      : currentUser.avatar;
                  } else if (reply.user.avatarType === 'image') {
                    replyAvatarContent = `<img src="${reply.user.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
                  }
                  return `
                  <div class="reply-card">
                    <div class="reply-avatar">${replyAvatarContent}</div>
                    <div class="reply-content">
                      <div class="reply-meta">
                        <span class="reply-username">${reply.user.name}</span>
                        <span class="reply-time">${reply.time}</span>
                      </div>
                      <div class="reply-text">${reply.text}</div>
                    </div>
                  </div>
                `}).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Format post text with tickers and hashtags
    function formatPostText(text) {
      return text
        .replace(/\$([A-Z]+)/g, '<span class="ticker">$$$1</span>')
        .replace(/#(\w+)/g, '<span class="hashtag">#$1</span>');
    }

    // Toggle compose modal
    function toggleCompose() {
      const overlay = document.getElementById('compose-overlay');
      const modal = document.getElementById('compose-modal');
      const fab = document.getElementById('fab');
      const input = document.getElementById('compose-input');
      
      overlay.classList.toggle('open');
      modal.classList.toggle('open');
      fab.classList.toggle('open');
      
      if (modal.classList.contains('open')) {
        setTimeout(() => input.focus(), 300);
      } else {
        input.value = '';
        updateCharCount();
      }
    }

    // Update character count
    function updateCharCount() {
      const input = document.getElementById('compose-input');
      const count = document.getElementById('char-count');
      const submit = document.getElementById('compose-submit');
      const length = input.value.length;
      
      count.textContent = `${length} / 280`;
      count.classList.remove('warning', 'danger');
      
      if (length > 250) {
        count.classList.add('danger');
      } else if (length > 200) {
        count.classList.add('warning');
      }
      
      updateSubmitButton();
    }

    // Attached image data
    let attachedImage = null;

    // Handle file attachment
    function handleAttachment(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (!file.type.startsWith('image/')) {
        alert('Please select an image file');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        attachedImage = e.target.result;
        const preview = document.getElementById('image-preview');
        const previewImg = document.getElementById('preview-img');
        previewImg.src = attachedImage;
        preview.classList.add('active');
        updateSubmitButton();
      };
      reader.readAsDataURL(file);
    }

    // Remove attachment
    function removeAttachment() {
      attachedImage = null;
      const preview = document.getElementById('image-preview');
      preview.classList.remove('active');
      document.getElementById('attach-input').value = '';
      updateSubmitButton();
    }

    // Update submit button state
    function updateSubmitButton() {
      const input = document.getElementById('compose-input');
      const submit = document.getElementById('compose-submit');
      const hasText = input.value.trim().length > 0;
      const hasImage = attachedImage !== null;
      submit.disabled = !hasText && !hasImage;
    }

    // Submit new post
    function submitPost() {
      const input = document.getElementById('compose-input');
      const text = input.value.trim();
      
      if (!text && !attachedImage) return;
      
      const newPost = {
        id: nextPostId++,
        user: {
          name: currentUser.name,
          handle: currentUser.handle,
          avatar: currentUser.avatar,
          avatarType: currentUser.avatarType,
          type: currentUser.type
        },
        text: text,
        image: attachedImage,
        time: 'now',
        timestamp: Date.now(),
        likes: 0,
        dislikes: 0,
        liked: false,
        disliked: false,
        replies: []
      };
      
      posts.unshift(newPost);
      
      // Insert at top of feed with animation
      const feed = document.getElementById('feed');
      const newPostHTML = renderPostHTML(newPost);
      feed.insertAdjacentHTML('afterbegin', newPostHTML);
      document.getElementById(`post-${newPost.id}`).classList.add('new-post');
      
      // Clear attachment
      attachedImage = null;
      document.getElementById('image-preview').classList.remove('active');
      document.getElementById('attach-input').value = '';
      
      toggleCompose();
      savePosts();
    }

    // Toggle like - NO full re-render
    function toggleLike(postId) {
      const post = posts.find(p => p.id === postId);
      if (!post) return;
      
      const likeBtn = document.getElementById(`like-btn-${postId}`);
      const likeCount = document.getElementById(`like-count-${postId}`);
      const dislikeBtn = document.getElementById(`dislike-btn-${postId}`);
      const dislikeCount = document.getElementById(`dislike-count-${postId}`);
      
      if (post.liked) {
        post.liked = false;
        post.likes--;
        likeBtn.classList.remove('active');
        likeBtn.querySelector('svg').setAttribute('fill', 'none');
      } else {
        if (post.disliked) {
          post.disliked = false;
          post.dislikes--;
          dislikeBtn.classList.remove('active');
          dislikeBtn.querySelector('svg').setAttribute('fill', 'none');
          dislikeCount.textContent = post.dislikes;
        }
        post.liked = true;
        post.likes++;
        likeBtn.classList.add('active');
        likeBtn.querySelector('svg').setAttribute('fill', 'currentColor');
      }
      
      likeCount.textContent = post.likes;
      savePosts();
    }

    // Toggle dislike - NO full re-render
    function toggleDislike(postId) {
      const post = posts.find(p => p.id === postId);
      if (!post) return;
      
      const dislikeBtn = document.getElementById(`dislike-btn-${postId}`);
      const dislikeCount = document.getElementById(`dislike-count-${postId}`);
      const likeBtn = document.getElementById(`like-btn-${postId}`);
      const likeCount = document.getElementById(`like-count-${postId}`);
      
      if (post.disliked) {
        post.disliked = false;
        post.dislikes--;
        dislikeBtn.classList.remove('active');
        dislikeBtn.querySelector('svg').setAttribute('fill', 'none');
      } else {
        if (post.liked) {
          post.liked = false;
          post.likes--;
          likeBtn.classList.remove('active');
          likeBtn.querySelector('svg').setAttribute('fill', 'none');
          likeCount.textContent = post.likes;
        }
        post.disliked = true;
        post.dislikes++;
        dislikeBtn.classList.add('active');
        dislikeBtn.querySelector('svg').setAttribute('fill', 'currentColor');
      }
      
      dislikeCount.textContent = post.dislikes;
      savePosts();
    }

    // Toggle reply section - NO re-render
    function toggleReply(postId) {
      const section = document.getElementById(`reply-section-${postId}`);
      const input = document.getElementById(`reply-input-${postId}`);
      
      section.classList.toggle('open');
      if (section.classList.contains('open')) {
        input.focus();
      }
    }

    // Handle reply keypress
    function handleReplyKeypress(event, postId) {
      if (event.key === 'Enter') {
        submitReply(postId);
      }
    }

    // Submit reply - targeted update
    function submitReply(postId) {
      const input = document.getElementById(`reply-input-${postId}`);
      const text = input.value.trim();
      
      if (!text) return;
      
      const post = posts.find(p => p.id === postId);
      if (!post) return;
      
      const newReply = {
        user: {
          name: currentUser.name,
          handle: currentUser.handle,
          avatar: currentUser.avatar,
          avatarType: currentUser.avatarType,
          type: currentUser.type
        },
        text: text,
        time: 'now'
      };
      
      post.replies.push(newReply);
      
      // Update replies container
      const repliesContainer = document.getElementById(`replies-${postId}`);
      let replyAvatarContent = newReply.user.avatar;
      if (newReply.user.avatarType === 'image') {
        replyAvatarContent = `<img src="${newReply.user.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
      }
      repliesContainer.innerHTML += `
        <div class="reply-card">
          <div class="reply-avatar">${replyAvatarContent}</div>
          <div class="reply-content">
            <div class="reply-meta">
              <span class="reply-username">${newReply.user.name}</span>
              <span class="reply-time">${newReply.time}</span>
            </div>
            <div class="reply-text">${newReply.text}</div>
          </div>
        </div>
      `;
      
      // Update reply count
      const replyCount = document.getElementById(`reply-count-${postId}`);
      replyCount.textContent = post.replies.length;
      
      // Hide reply input section
      const section = document.getElementById(`reply-section-${postId}`);
      section.classList.remove('open');
      
      input.value = '';
      savePosts();
    }

    // Save posts to localStorage
    function savePosts() {
      localStorage.setItem('apehub_posts_v4', JSON.stringify(posts));
    }

    // Update online count (randomize between 150-222)
    function updateOnlineCount() {
      const count = Math.floor(Math.random() * (MAX_COMMUNITY_SIZE - 150)) + 150;
      document.getElementById('online-count').textContent = `${count} online`;
    }

    // Initialize
    console.log('ApeChat initializing...');
    loadCurrentUser();
    
    // Clear old posts versions and check for corruption
    localStorage.removeItem('apehub_posts_v3'); // Old version
    try {
      const savedPosts = localStorage.getItem('apehub_posts_v4');
      if (savedPosts) {
        JSON.parse(savedPosts);
      }
    } catch(e) {
      console.log('Clearing corrupted posts data');
      localStorage.removeItem('apehub_posts_v4');
    }
    
    initializePosts();
    console.log('Posts loaded:', posts.length);
    renderPosts();
    console.log('Posts rendered');
    updateOnlineCount();
    
    // Periodically update online count
    setInterval(updateOnlineCount, 30000);

    // Apply saved theme
    const savedTheme = localStorage.getItem('apehub_theme') || 'dark';
    document.documentElement.setAttribute('data-theme', savedTheme);
  </script>
</body>
</html>
