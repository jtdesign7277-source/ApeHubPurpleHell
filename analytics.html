<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Analytics | ApeHub</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="portfolio-effects.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="portfolio-effects.js"></script>
  <style>
      :root {
        --bg-primary: #0a0a0f;
        --bg-secondary: #111118;
        --bg-card: rgba(255, 255, 255, 0.03);
        --bg-card-hover: rgba(255, 255, 255, 0.06);
        --text-primary: #fff;
        --text-secondary: rgba(255, 255, 255, 0.6);
        --text-muted: rgba(255, 255, 255, 0.4);
        --border-color: rgba(255, 255, 255, 0.15);
        --border-light: rgba(255, 255, 255, 0.1);
        --accent: #a855f7;
        --accent-glow: rgba(168, 85, 247, 0.3);
        --nav-bg: rgba(10, 10, 15, 0.95);
        --card-bg: #16161d;
        --color-up: #00d775;
        --color-down: #ff4757;
      }

      [data-theme="light"] {
        --bg-primary: #f8f8fa;
        --bg-secondary: #fff;
        --bg-card: rgba(0, 0, 0, 0.03);
        --bg-card-hover: rgba(0, 0, 0, 0.06);
        --text-primary: #18181b;
        --text-secondary: rgba(24, 24, 27, 0.6);
        --text-muted: rgba(24, 24, 27, 0.4);
        --border-color: rgba(24, 24, 27, 0.12);
        --border-light: rgba(24, 24, 27, 0.08);
        --accent: #a855f7;
        --accent-glow: rgba(168, 85, 247, 0.13);
        --nav-bg: rgba(255, 255, 255, 0.95);
        --card-bg: #fff;
        --color-up: #16a34a;
        --color-down: #dc2626;
      }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: var(--bg-primary);
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Instrument Sans', sans-serif;
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
      padding-bottom: 100px;
    }

    /* Header */
    .analytics-header {
      display: flex;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-light);
      position: sticky;
      top: 0;
      background: var(--bg-primary);
      z-index: 100;
    }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      background: none;
      border: none;
      color: var(--accent);
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      padding: 8px 0;
      text-decoration: none;
    }

    .back-btn svg {
      width: 20px;
      height: 20px;
    }

    .header-title {
      flex: 1;
      text-align: center;
      font-size: 17px;
      font-weight: 600;
      margin-right: 60px;
      color: rgba(255, 255, 255, 0.7);
    }

    /* Chart Type Tabs */
    .chart-tabs {
      display: flex;
      gap: 4px;
      padding: 16px 20px;
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      margin: 0 20px;
    }

    .chart-tab {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      padding: 8px 12px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.15s ease;
    }

    .chart-tab svg {
      width: 14px;
      height: 14px;
      opacity: 0.5;
      transition: opacity 0.15s;
    }

    .chart-tab:hover {
      color: var(--text-secondary);
      background: rgba(255,255,255,0.04);
    }

    .chart-tab:hover svg {
      opacity: 0.7;
    }

    .chart-tab.active {
      background: rgba(168, 85, 247, 0.15);
      color: var(--accent);
    }

    .chart-tab.active svg {
      opacity: 1;
      stroke: var(--accent);
    }

    /* Portfolio Summary Card */
    .portfolio-summary {
      margin: 16px 20px 16px;
      padding: 14px 16px;
      background: var(--card-bg);
      border-radius: 12px;
      border: 1px solid var(--border-light);
    }

    .summary-label {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 4px;
    }

    .summary-value {
      font-size: 26px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .summary-change {
      font-size: 13px;
      font-weight: 600;
      color: var(--color-up);
    }

    .summary-change.down {
      color: var(--color-down);
    }

    /* Chart Container */
    .chart-container {
      margin: 0 20px 24px;
      padding: 20px;
      background: var(--card-bg);
      border-radius: 16px;
      border: 1px solid var(--border-light);
    }

    .chart-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 20px;
      color: var(--text-primary);
    }

    .chart-wrapper {
      position: relative;
      height: 280px;
    }

    /* Time Frame Tabs */
    .timeframe-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .timeframe-tab {
      padding: 6px 12px;
      border: 1px solid var(--border-color);
      background: transparent;
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      border-radius: 16px;
      transition: all 0.2s;
    }

    .timeframe-tab:hover {
      border-color: var(--accent);
      color: var(--text-primary);
    }

    .timeframe-tab.active {
      background: transparent;
      border-color: var(--accent);
      color: var(--accent);
      box-shadow: 0 0 8px var(--accent-glow);
    }

    /* Holdings Breakdown */
    .holdings-section {
      padding: 0 20px;
    }

    .holdings-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--text-primary);
    }

    .holding-item {
      display: flex;
      align-items: center;
      padding: 16px;
      background: var(--card-bg);
      border-radius: 12px;
      margin-bottom: 8px;
      border: 1px solid var(--border-light);
    }

    .holding-color {
      width: 12px;
      height: 12px;
      border-radius: 3px;
      margin-right: 12px;
    }

    .holding-info {
      flex: 1;
    }

    .holding-symbol {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .holding-name {
      font-size: 13px;
      color: var(--text-muted);
    }

    .holding-value {
      text-align: right;
    }

    .holding-amount {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .holding-percent {
      font-size: 13px;
      color: var(--text-secondary);
    }

    /* Professional Pie Chart Card */
    .pro-pie-card {
      margin: 0 16px;
      background: linear-gradient(180deg, #12121a 0%, #0f0f14 100%);
      border-radius: 16px;
      border: 1px solid rgba(51, 51, 71, 0.5);
      overflow: hidden;
    }

    .pro-pie-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid rgba(51, 51, 71, 0.5);
      background: rgba(0,0,0,0.2);
    }

    .pro-pie-header-title {
      color: #e2e8f0;
      font-weight: 600;
      font-size: 14px;
    }

    .market-open-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 4px;
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.2);
    }

    .market-open-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #22c55e;
      animation: pulse 2s infinite;
    }

    .market-open-text {
      color: #22c55e;
      font-size: 12px;
      font-weight: 500;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .pro-pie-content {
      padding: 20px 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: flex-start;
    }

    /* SVG Pie Chart Container */
    .svg-pie-container {
      position: relative;
      width: 140px;
      height: 140px;
      flex-shrink: 0;
    }

    .svg-pie-chart {
      transform: rotate(-90deg);
      width: 140px;
      height: 140px;
    }

    .svg-pie-slice {
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .svg-pie-slice.dimmed {
      opacity: 0.3;
    }

    .svg-pie-center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      pointer-events: none;
    }

    .pie-center-icon {
      width: 22px;
      height: 22px;
      border-radius: 4px;
      margin: 0 auto 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 8px;
    }

    .pie-center-value {
      font-size: 12px;
      font-weight: 600;
      color: white;
    }

    .pie-center-label {
      font-size: 9px;
      color: #64748b;
    }

    /* Interactive Legend */
    .pro-pie-legend {
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1;
      min-width: 140px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .legend-item:hover,
    .legend-item.active {
      background: rgba(51, 65, 85, 0.4);
    }

    .legend-dot {
      display: none;
    }

    .legend-logo {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 10px;
      flex-shrink: 0;
    }

    .legend-info {
      flex: 1;
      min-width: 0;
      overflow: hidden;
    }

    .legend-symbol {
      font-weight: 600;
      color: white;
      font-size: 13px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .legend-name {
      color: #64748b;
      font-size: 11px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .legend-values {
      text-align: right;
      flex-shrink: 0;
      padding-left: 4px;
    }

    .legend-amount {
      font-weight: 600;
      color: white;
      font-size: 13px;
      white-space: nowrap;
    }

    .legend-pct {
      color: #64748b;
      font-size: 11px;
    }

    /* Detail Panel */
    .pie-detail-panel {
      width: 100%;
      flex-basis: 100%;
      border-radius: 12px;
      border: 1px solid rgba(51, 51, 71, 0.3);
      background: rgba(15, 15, 20, 0.5);
      transition: all 0.2s ease;
      overflow: hidden;
    }

    .pie-detail-panel.has-data {
      border-color: rgba(71, 85, 105, 0.4);
      background: rgba(30, 41, 59, 0.3);
    }

    .detail-empty {
      padding: 24px 20px;
      text-align: center;
    }

    .detail-empty-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: rgba(51, 65, 85, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 12px;
    }

    .detail-empty-title {
      color: #64748b;
      font-size: 13px;
      font-weight: 500;
    }

    .detail-empty-subtitle {
      color: #475569;
      font-size: 11px;
      margin-top: 4px;
    }

    .detail-content {
      padding: 16px;
      display: none;
    }

    .pie-detail-panel.has-data .detail-content {
      display: block;
    }

    .pie-detail-panel.has-data .detail-empty {
      display: none;
    }

    .detail-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(71, 85, 105, 0.3);
    }

    .detail-logo {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 12px;
    }

    .detail-title {
      font-weight: 600;
      color: white;
      font-size: 14px;
    }

    .detail-sector {
      color: #64748b;
      font-size: 11px;
    }

    .detail-stats {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .detail-stat-row {
      display: flex;
      justify-content: space-between;
    }

    .detail-stat-label {
      color: #64748b;
      font-size: 11px;
    }

    .detail-stat-value {
      color: white;
      font-size: 12px;
      font-weight: 500;
    }

    .detail-stat-value.positive {
      color: #22c55e;
    }

    .detail-stat-value.negative {
      color: #ef4444;
    }

    .detail-return-box {
      margin-top: 8px;
      padding: 10px;
      border-radius: 8px;
    }

    .detail-return-box.positive {
      background: rgba(34, 197, 94, 0.1);
    }

    .detail-return-box.negative {
      background: rgba(239, 68, 68, 0.1);
    }

    .return-box-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .return-box-label {
      font-size: 10px;
    }

    .return-box-label.positive {
      color: rgba(34, 197, 94, 0.7);
    }

    .return-box-label.negative {
      color: rgba(239, 68, 68, 0.7);
    }

    .return-box-percent {
      font-size: 12px;
      font-weight: 600;
    }

    .return-box-percent.positive {
      color: #22c55e;
    }

    .return-box-percent.negative {
      color: #ef4444;
    }

    .return-box-amount {
      font-size: 16px;
      font-weight: bold;
    }

    .return-box-amount.positive {
      color: #22c55e;
    }

    .return-box-amount.negative {
      color: #ef4444;
    }

    .detail-buttons {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .detail-btn {
      flex: 1;
      padding: 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid;
    }

    .detail-btn.buy {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
      border-color: rgba(34, 197, 94, 0.3);
    }

    .detail-btn.sell {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
      border-color: rgba(239, 68, 68, 0.3);
    }

    /* Pro Pie Footer */
    .pro-pie-footer {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      padding: 14px 16px;
      background: rgba(0,0,0,0.3);
      border-top: 1px solid rgba(51, 51, 71, 0.5);
    }

    .footer-stat {
      flex: 1;
      min-width: 70px;
    }

    .footer-stat-label {
      font-size: 10px;
      color: #475569;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .footer-stat-value {
      font-size: 14px;
      font-weight: 600;
      color: white;
      margin-top: 2px;
    }

    .footer-stat-value.positive {
      color: #22c55e;
    }

    .footer-stat-value.negative {
      color: #ef4444;
    }

    /* Table View - Professional Stock Table */
    .table-container {
      margin: 0 16px;
      background: linear-gradient(145deg, #12121a 0%, #0f0f17 100%);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4), 0 10px 40px rgba(0, 0, 0, 0.5);
    }

    .table-header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      background: rgba(255, 255, 255, 0.02);
    }

    .table-title {
      font-size: 0.95rem;
      font-weight: 600;
      color: #e2e8f0;
    }

    .market-status {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 0.7rem;
      font-weight: 500;
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }

    .market-status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
      animation: market-pulse 2s infinite;
    }

    @keyframes market-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .holdings-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .holdings-table thead {
      background: rgba(0, 0, 0, 0.3);
    }

    .holdings-table th {
      padding: 12px 12px;
      text-align: left;
      font-size: 0.65rem;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      white-space: nowrap;
    }

    .holdings-table th.text-right,
    .holdings-table td.text-right {
      text-align: right;
    }

    .holdings-table td {
      padding: 14px 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      vertical-align: middle;
    }

    .holdings-table tbody tr {
      transition: background 0.2s;
    }

    .holdings-table tbody tr:hover {
      background: rgba(99, 102, 241, 0.05);
    }

    .holdings-table tbody tr:last-child td {
      border-bottom: none;
    }

    /* Stock identity cell */
    .stock-identity {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .stock-logo {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: linear-gradient(135deg, #1e1e2e, #2a2a3e);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.65rem;
      color: #ffffff;
      border: 1px solid rgba(255, 255, 255, 0.1);
      flex-shrink: 0;
    }

    .stock-info {
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .stock-symbol-text {
      font-weight: 600;
      font-size: 0.9rem;
      color: #f1f5f9;
    }

    .stock-shares {
      font-size: 0.75rem;
      color: #64748b;
      margin-top: 1px;
    }

    /* Value cell */
    .value-cell {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .current-value {
      font-weight: 600;
      font-size: 0.9rem;
      color: #f1f5f9;
    }

    .cost-basis {
      font-size: 0.7rem;
      color: #64748b;
      margin-top: 1px;
    }

    /* Gain/Loss cell */
    .gain-loss-cell {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .gain-amount {
      font-weight: 600;
      font-size: 0.85rem;
    }

    .gain-percent-badge {
      font-size: 0.7rem;
      margin-top: 2px;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .gain-amount.positive,
    .gain-percent-badge.positive {
      color: #22c55e;
    }

    .gain-percent-badge.positive {
      background: rgba(34, 197, 94, 0.15);
    }

    .gain-amount.negative,
    .gain-percent-badge.negative {
      color: #ef4444;
    }

    .gain-percent-badge.negative {
      background: rgba(239, 68, 68, 0.15);
    }

    /* Mini sparkline */
    .sparkline-cell {
      width: 60px;
    }

    .mini-sparkline {
      width: 100%;
      height: 24px;
    }

    .sparkline-path {
      fill: none;
      stroke-width: 1.5;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .sparkline-path.positive { stroke: #22c55e; }
    .sparkline-path.negative { stroke: #ef4444; }

    /* Table footer */
    .table-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.06);
      background: rgba(0, 0, 0, 0.2);
      flex-wrap: wrap;
      gap: 12px;
    }

    .table-summary {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }

    .summary-stat {
      display: flex;
      flex-direction: column;
    }

    .summary-stat-label {
      font-size: 0.65rem;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .summary-stat-value {
      font-size: 0.95rem;
      font-weight: 600;
      color: #f1f5f9;
      margin-top: 2px;
    }

    .summary-stat-value.positive { color: #22c55e; }
    .summary-stat-value.negative { color: #ef4444; }

    /* Top performer row glow */
    .holdings-table tbody tr.top-performer {
      background: linear-gradient(90deg, rgba(34, 197, 94, 0.08) 0%, transparent 60%);
    }

    .holdings-table tbody tr.top-performer .stock-logo {
      box-shadow: 0 0 12px rgba(34, 197, 94, 0.4);
    }

    /* Worst performer row */
    .holdings-table tbody tr.worst-performer {
      background: linear-gradient(90deg, rgba(239, 68, 68, 0.05) 0%, transparent 60%);
    }

    /* Bottom Nav */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 12px 0;
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
      background: var(--nav-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid var(--border-light);
      z-index: 1000;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      color: var(--text-muted);
      text-decoration: none;
      font-size: 10px;
      font-weight: 500;
      transition: color 0.2s;
    }

    .nav-item:hover {
      color: var(--text-secondary);
    }

    .nav-item.active {
      color: rgba(168, 85, 247, 0.55);
    }

    .nav-item svg {
      width: 24px;
      height: 24px;
    }

    /* Predictions Tab Styles */
    .nav-item.predictions .nav-icon-wrapper {
      position: relative;
    }
    .nav-item.predictions .nav-icon {
      font-size: 20px;
    }
    .nav-live-dot {
      position: absolute;
      top: -2px;
      right: -6px;
      width: 8px;
      height: 8px;
      background: #10b981;
      border-radius: 50%;
      border: 2px solid #0a0a0f;
      animation: live-pulse 2s ease-in-out infinite;
    }
    @keyframes live-pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.2); }
    }
    .nav-item.predictions.active {
      color: #a855f7;
    }
    .nav-item.predictions.active .nav-icon {
      filter: drop-shadow(0 0 8px rgba(168, 85, 247, 0.6));
    }

    /* Hidden views */
    .chart-view {
      display: none;
    }

    .chart-view.active {
      display: block;
    }

    /* === CHART ANIMATIONS === */
    
    /* Pie Chart - 3D scale + rotate entrance */
    @keyframes pie-enter {
      0% { 
        transform: scale(0.3) rotateY(-25deg); 
        opacity: 0; 
        filter: blur(8px);
      }
      60% {
        transform: scale(1.02) rotateY(3deg);
        filter: blur(0);
      }
      100% { 
        transform: scale(1) rotateY(0deg); 
        opacity: 1; 
      }
    }
    
    #pie-view.active .chart-wrapper {
      animation: pie-enter 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
      transform-style: preserve-3d;
      perspective: 1000px;
    }
    
    #pie-view.active .chart-container {
      animation: fadeSlideUp 0.4s ease-out forwards;
    }
    
    /* Bar Chart - staggered bars growing up */
    @keyframes bar-container-enter {
      0% { opacity: 0; transform: translateY(20px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    
    #bar-view.active .chart-container {
      animation: bar-container-enter 0.4s ease-out forwards;
    }
    
    #bar-view.active .chart-wrapper {
      animation: pie-enter 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
      animation-delay: 0.1s;
      opacity: 0;
    }
    
    /* Line Chart - draw effect */
    @keyframes line-draw {
      0% { 
        opacity: 0;
        transform: scaleX(0);
        transform-origin: left center;
      }
      100% { 
        opacity: 1;
        transform: scaleX(1);
      }
    }
    
    #line-view.active .chart-container {
      animation: fadeSlideUp 0.4s ease-out forwards;
    }
    
    #line-view.active .chart-wrapper {
      animation: line-draw 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
      animation-delay: 0.15s;
      opacity: 0;
    }
    
    /* Table - staggered row fade in */
    @keyframes fadeSlideUp {
      0% { 
        opacity: 0; 
        transform: translateY(15px); 
      }
      100% { 
        opacity: 1; 
        transform: translateY(0); 
      }
    }
    
    @keyframes tableRowEnter {
      0% { 
        opacity: 0; 
        transform: translateX(-10px); 
      }
      100% { 
        opacity: 1; 
        transform: translateX(0); 
      }
    }
    
    #table-view.active .table-container {
      animation: fadeSlideUp 0.35s ease-out forwards;
    }
    
    #table-view.active .holdings-table tbody tr {
      opacity: 0;
      animation: tableRowEnter 0.3s ease-out forwards;
    }
    
    #table-view.active .holdings-table tbody tr:nth-child(1) { animation-delay: 0.1s; }
    #table-view.active .holdings-table tbody tr:nth-child(2) { animation-delay: 0.15s; }
    #table-view.active .holdings-table tbody tr:nth-child(3) { animation-delay: 0.2s; }
    #table-view.active .holdings-table tbody tr:nth-child(4) { animation-delay: 0.25s; }
    #table-view.active .holdings-table tbody tr:nth-child(5) { animation-delay: 0.3s; }
    #table-view.active .holdings-table tbody tr:nth-child(6) { animation-delay: 0.35s; }
    #table-view.active .holdings-table tbody tr:nth-child(7) { animation-delay: 0.4s; }
    #table-view.active .holdings-table tbody tr:nth-child(8) { animation-delay: 0.45s; }
    
    /* Holdings breakdown animation */
    #pie-view.active .holding-item {
      opacity: 0;
      animation: fadeSlideUp 0.35s ease-out forwards;
    }
    
    #pie-view.active .holding-item:nth-child(1) { animation-delay: 0.3s; }
    #pie-view.active .holding-item:nth-child(2) { animation-delay: 0.38s; }
    #pie-view.active .holding-item:nth-child(3) { animation-delay: 0.46s; }
    #pie-view.active .holding-item:nth-child(4) { animation-delay: 0.54s; }
    #pie-view.active .holding-item:nth-child(5) { animation-delay: 0.62s; }
    
    /* Holdings title */
    #pie-view.active .holdings-title {
      opacity: 0;
      animation: fadeSlideUp 0.3s ease-out forwards;
      animation-delay: 0.25s;
    }
    
    /* Portfolio summary subtle pulse on load */
    @keyframes summaryPulse {
      0% { box-shadow: 0 0 0 0 rgba(168, 85, 247, 0); }
      50% { box-shadow: 0 0 20px 2px rgba(168, 85, 247, 0.15); }
      100% { box-shadow: 0 0 0 0 rgba(168, 85, 247, 0); }
    }
    
    .portfolio-summary {
      animation: summaryPulse 2s ease-in-out;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Chart Type Tabs -->
    <div class="chart-tabs">
      <button class="chart-tab active" data-view="table">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2"/>
          <path d="M3 9h18"/>
          <path d="M3 15h18"/>
          <path d="M9 3v18"/>
        </svg>
        Table
      </button>
      <button class="chart-tab" data-view="pie">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21.21 15.89A10 10 0 1 1 8 2.83"/>
          <path d="M22 12A10 10 0 0 0 12 2v10z"/>
        </svg>
        Pie
      </button>
    </div>

    <!-- Portfolio Summary -->
    <div class="portfolio-summary">
      <div class="summary-label">Portfolio Value</div>
      <div class="summary-value" id="total-value">$0.00</div>
      <div class="summary-change" id="total-change">+$0.00 (+0.00%)</div>
    </div>

    <!-- Pie Chart View -->
    <div class="chart-view" id="pie-view">
      <div class="pro-pie-card">
        <div class="pro-pie-header">
          <span class="pro-pie-header-title">Allocation Breakdown</span>
        </div>
        
        <div class="pro-pie-content">
          <!-- SVG Pie Chart -->
          <div class="svg-pie-container">
            <svg class="svg-pie-chart" viewBox="0 0 140 140" id="svgPieChart">
              <circle cx="70" cy="70" r="52" fill="none" stroke="rgba(255,255,255,0.03)" stroke-width="20"/>
              <!-- Slices will be generated by JS -->
            </svg>
            <div class="svg-pie-center" id="pieCenterContent">
              <div class="pie-center-value" id="pieCenterValue">$0.00</div>
              <div class="pie-center-label" id="pieCenterLabel">Total Value</div>
            </div>
          </div>
          
          <!-- Interactive Legend -->
          <div class="pro-pie-legend" id="proPieLegend">
            <!-- Legend items generated by JS -->
          </div>
          
          <!-- Detail Panel -->
          <div class="pie-detail-panel" id="pieDetailPanel">
            <div class="detail-empty">
              <div class="detail-empty-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#475569" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"/>
                </svg>
              </div>
              <div class="detail-empty-title">Tap on chart or legend</div>
              <div class="detail-empty-subtitle">View stock details</div>
            </div>
            <div class="detail-content" id="pieDetailContent">
              <!-- Detail content generated by JS -->
            </div>
          </div>
        </div>
        
        <div class="pro-pie-footer" id="proPieFooter">
          <!-- Footer stats generated by JS -->
        </div>
      </div>
    </div>

    <!-- Bar Chart View -->
    <div class="chart-view" id="bar-view">
      <div class="chart-container">
        <div class="chart-title">Holdings by Value</div>
        <div class="chart-wrapper">
          <canvas id="barChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Line Chart View -->
    <div class="chart-view" id="line-view">
      <div class="chart-container">
        <div class="chart-title">Portfolio Value Over Time</div>
        <div class="timeframe-tabs">
          <button class="timeframe-tab" data-period="1D">1D</button>
          <button class="timeframe-tab" data-period="1W">1W</button>
          <button class="timeframe-tab active" data-period="1M">1M</button>
          <button class="timeframe-tab" data-period="YTD">YTD</button>
          <button class="timeframe-tab" data-period="1Y">1Y</button>
          <button class="timeframe-tab" data-period="ALL">All</button>
        </div>
        <div class="chart-wrapper">
          <canvas id="lineChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Table View -->
    <div class="chart-view active" id="table-view">
      <div class="table-container">
        <div class="table-header-bar">
          <div class="table-title">Your Positions</div>
        </div>
        <table class="holdings-table">
          <thead>
            <tr>
              <th>Stock</th>
              <th class="text-right">Value</th>
              <th class="text-right">Gain/Loss</th>
              <th>7D</th>
            </tr>
          </thead>
          <tbody id="table-body"></tbody>
        </table>
        <div class="table-footer">
          <div class="table-summary" id="table-summary"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Nav -->
  <nav class="bottom-nav">
    <a href="dashboard.html" class="nav-item active">
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 3L2 12h3v8h6v-6h2v6h6v-8h3L12 3z"/>
      </svg>
      <span>Home</span>
    </a>
    <a href="news.html" class="nav-item">
      <svg viewBox="0 0 16 16" fill="currentColor">
        <path d="M8 0C8 4.418 4.418 8 0 8C4.418 8 8 11.582 8 16C8 11.582 11.582 8 16 8C11.582 8 8 4.418 8 0Z"/>
      </svg>
      <span>News</span>
    </a>
    <a href="predictions.html" class="nav-item predictions">
      <div class="nav-icon-wrapper">
        <span class="nav-icon">ðŸ”®</span>
      </div>
      <span>Predict</span>
    </a>
    <a href="charts.html" class="nav-item">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M9 5v4"/>
        <rect x="7" y="9" width="4" height="6" rx="0.5" fill="currentColor"/>
        <path d="M9 15v4"/>
        <path d="M15 3v2"/>
        <rect x="13" y="5" width="4" height="8" rx="0.5"/>
        <path d="M15 13v6"/>
      </svg>
      <span>Charts</span>
    </a>
    <a href="chat.html" class="nav-item">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2C6.48 2 2 6.48 2 12c0 1.85.5 3.58 1.36 5.08L2 22l4.92-1.36C8.42 21.5 10.15 22 12 22c5.52 0 10-4.48 10-10S17.52 2 12 2z"/>
      </svg>
      <span>Chat</span>
    </a>
  </nav>

  <script>
    // Finnhub API for live prices
    const FINNHUB_API_KEY = 'd5c3ijpr01qsbmgib7u0d5c3ijpr01qsbmgib7ug';
    
    // Chart colors
    const COLORS = [
      '#a855f7', // Purple
      '#3b82f6', // Blue
      '#10b981', // Green
      '#f59e0b', // Amber
      '#ef4444', // Red
      '#8b5cf6', // Violet
      '#06b6d4', // Cyan
      '#f97316', // Orange
      '#ec4899', // Pink
      '#14b8a6', // Teal
    ];

    // Load watchlist from localStorage (same format as dashboard.html)
    function loadWatchlist() {
      try {
        return JSON.parse(localStorage.getItem('watchlist')) || [];
      } catch (e) {
        return [];
      }
    }

    // Load positions (shares/avgCost) from localStorage
    function loadPositions() {
      try {
        return JSON.parse(localStorage.getItem('positions')) || {};
      } catch (e) {
        return {};
      }
    }

    // Fetch live price from Finnhub
    async function fetchLivePrice(symbol) {
      try {
        const response = await fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${FINNHUB_API_KEY}`);
        const data = await response.json();
        if (data.c && data.c > 0) {
          return {
            price: data.c,
            change: data.d || 0,
            changePercent: data.dp || 0
          };
        }
      } catch (e) {
        console.error(`Failed to fetch price for ${symbol}:`, e);
      }
      return null;
    }

    let watchlist = loadWatchlist();
    let positions = loadPositions();
    let holdingsData = [];
    let totalValue = 0;
    let totalCost = 0;
    let barChart, lineChart;
    let hoveredSliceIndex = null;

    // Calculate and render portfolio data
    async function initializePortfolio() {
      // Show loading state
      document.getElementById('total-value').textContent = 'Loading...';
      document.getElementById('total-change').textContent = '';
      
      // Filter to only stocks with positions (shares > 0)
      const stocksWithPositions = watchlist.filter(stock => {
        const position = positions[stock.symbol];
        return position && position.shares > 0;
      });

      if (stocksWithPositions.length === 0) {
        document.getElementById('total-value').textContent = '$0.00';
        document.getElementById('total-change').textContent = 'No holdings yet';
        document.getElementById('holdings-list').innerHTML = '<div class="holdings-title">Holdings Breakdown</div><div style="color: var(--text-muted); padding: 20px; text-align: center;">Add shares to your watchlist to see analytics</div>';
        return;
      }

      // Fetch live prices for all positions
      const pricePromises = stocksWithPositions.map(async (stock, i) => {
        // Small delay to avoid rate limiting
        await new Promise(r => setTimeout(r, i * 100));
        const liveData = await fetchLivePrice(stock.symbol);
        return {
          stock,
          liveData
        };
      });

      const results = await Promise.all(pricePromises);
      
      totalValue = 0;
      totalCost = 0;
      
      holdingsData = results.map((result, i) => {
        const { stock, liveData } = result;
        const position = positions[stock.symbol];
        const shares = position.shares;
        const avgCost = position.avgCost || stock.price;
        
        // Use live price if available, otherwise fall back to stored price
        const currentPrice = liveData ? liveData.price : stock.price;
        const priceChangePercent = liveData ? liveData.changePercent : (stock.changePercent || 0);
        
        const value = shares * currentPrice;
        const cost = shares * avgCost;
        const change = value - cost;
        const changePercent = cost > 0 ? ((change / cost) * 100) : 0;
        
        totalValue += value;
        totalCost += cost;
        
        return {
          symbol: stock.symbol,
          name: stock.name || stock.symbol,
          shares: shares,
          avgCost: avgCost,
          currentPrice: currentPrice,
          priceChangePercent: priceChangePercent,
          value: value,
          change: change,
          changePercent: changePercent,
          color: COLORS[i % COLORS.length]
        };
      }).sort((a, b) => b.value - a.value);

      const totalChange = totalValue - totalCost;
      const totalChangePercent = totalCost > 0 ? ((totalChange / totalCost) * 100) : 0;

      // Update summary with slot machine effect
      if (typeof createSlotMachineValue === 'function' && totalValue > 0) {
        createSlotMachineValue('total-value', totalValue);
      } else {
        document.getElementById('total-value').textContent = '$' + totalValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }
      const changeEl = document.getElementById('total-change');
      const sign = totalChange >= 0 ? '+' : '';
      changeEl.textContent = `${sign}$${Math.abs(totalChange).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} (${sign}${totalChangePercent.toFixed(2)}%)`;
      changeEl.classList.remove('down');
      if (totalChange < 0) {
        changeEl.classList.add('down');
      }

      // Render all views
      renderProPieChart();
      renderTable();
      renderCharts();
    }

    // Professional SVG Pie Chart Functions
    function getSlicePath(startPercent, endPercent, isHovered) {
      const radius = isHovered ? 55 : 52;
      const innerRadius = 32;
      const centerX = 70;
      const centerY = 70;
      const startAngle = (startPercent / 100) * 360 - 90;
      const endAngle = (endPercent / 100) * 360 - 90;
      
      const startX = centerX + radius * Math.cos((startAngle * Math.PI) / 180);
      const startY = centerY + radius * Math.sin((startAngle * Math.PI) / 180);
      const endX = centerX + radius * Math.cos((endAngle * Math.PI) / 180);
      const endY = centerY + radius * Math.sin((endAngle * Math.PI) / 180);
      
      const innerStartX = centerX + innerRadius * Math.cos((endAngle * Math.PI) / 180);
      const innerStartY = centerY + innerRadius * Math.sin((endAngle * Math.PI) / 180);
      const innerEndX = centerX + innerRadius * Math.cos((startAngle * Math.PI) / 180);
      const innerEndY = centerY + innerRadius * Math.sin((startAngle * Math.PI) / 180);
      
      const largeArcFlag = endPercent - startPercent > 50 ? 1 : 0;
      
      return `M ${startX} ${startY} A ${radius} ${radius} 0 ${largeArcFlag} 1 ${endX} ${endY} L ${innerStartX} ${innerStartY} A ${innerRadius} ${innerRadius} 0 ${largeArcFlag} 0 ${innerEndX} ${innerEndY} Z`;
    }

    function updatePieHoverState(index) {
      hoveredSliceIndex = index;
      
      // Update slice styles
      document.querySelectorAll('.svg-pie-slice').forEach((slice, i) => {
        if (index !== null && i !== index) {
          slice.classList.add('dimmed');
        } else {
          slice.classList.remove('dimmed');
        }
        // Update path for hover effect
        const h = holdingsData[i];
        if (h) {
          slice.setAttribute('d', getSlicePath(h.startPercent, h.endPercent, i === index));
        }
      });
      
      // Update legend items
      document.querySelectorAll('.legend-item').forEach((item, i) => {
        if (index === i) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });
      
      // Update center content
      const centerValue = document.getElementById('pieCenterValue');
      const centerLabel = document.getElementById('pieCenterLabel');
      const centerContent = document.getElementById('pieCenterContent');
      
      if (index !== null && holdingsData[index]) {
        const h = holdingsData[index];
        // Add icon
        centerContent.innerHTML = `
          <div class="pie-center-icon" style="background: ${h.color}">${h.symbol.slice(0, 2)}</div>
          <div class="pie-center-value">$${h.value.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
          <div class="pie-center-label">${((h.value / totalValue) * 100).toFixed(1)}%</div>
        `;
      } else {
        centerContent.innerHTML = `
          <div class="pie-center-value">$${totalValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
          <div class="pie-center-label">Total Value</div>
        `;
      }
      
      // Update detail panel
      const panel = document.getElementById('pieDetailPanel');
      const detailContent = document.getElementById('pieDetailContent');
      
      if (index !== null && holdingsData[index]) {
        const h = holdingsData[index];
        panel.classList.add('has-data');
        
        const gainAmount = h.change;
        const gainClass = h.changePercent >= 0 ? 'positive' : 'negative';
        const gainSign = h.changePercent >= 0 ? '+' : '';
        
        detailContent.innerHTML = `
          <div class="detail-header">
            <div class="detail-logo" style="background: ${h.color}">${h.symbol.slice(0, 2)}</div>
            <div>
              <div class="detail-title">${h.symbol}</div>
              <div class="detail-sector">${h.name}</div>
            </div>
          </div>
          <div class="detail-stats">
            <div class="detail-stat-row">
              <span class="detail-stat-label">Price</span>
              <span class="detail-stat-value">$${h.currentPrice.toFixed(2)}</span>
            </div>
            <div class="detail-stat-row">
              <span class="detail-stat-label">Today</span>
              <span class="detail-stat-value ${h.priceChangePercent >= 0 ? 'positive' : 'negative'}">${h.priceChangePercent >= 0 ? '+' : ''}${h.priceChangePercent.toFixed(1)}%</span>
            </div>
            <div class="detail-stat-row">
              <span class="detail-stat-label">Shares</span>
              <span class="detail-stat-value">${h.shares.toLocaleString()}</span>
            </div>
            <div class="detail-stat-row">
              <span class="detail-stat-label">Avg Cost</span>
              <span class="detail-stat-value">$${h.avgCost.toFixed(2)}</span>
            </div>
            <div class="detail-return-box ${gainClass}">
              <div class="return-box-header">
                <span class="return-box-label ${gainClass}">Total Return</span>
                <span class="return-box-percent ${gainClass}">${gainSign}${h.changePercent.toFixed(1)}%</span>
              </div>
              <div class="return-box-amount ${gainClass}">${gainSign}$${Math.abs(gainAmount).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
            </div>
          </div>
        `;
      } else {
        panel.classList.remove('has-data');
      }
    }

    function renderProPieChart() {
      if (holdingsData.length === 0) {
        document.getElementById('svgPieChart').innerHTML = `
          <circle cx="70" cy="70" r="52" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="20"/>
        `;
        document.getElementById('pieCenterContent').innerHTML = `
          <div class="pie-center-value">$0.00</div>
          <div class="pie-center-label">No Holdings</div>
        `;
        document.getElementById('proPieLegend').innerHTML = '<div style="text-align: center; color: #64748b; padding: 16px; font-size: 11px;">Add positions to see allocation</div>';
        document.getElementById('proPieFooter').innerHTML = '';
        return;
      }
      
      // Calculate percentages and cumulative values
      let cumulativePercent = 0;
      holdingsData.forEach(h => {
        h.percent = (h.value / totalValue) * 100;
        h.startPercent = cumulativePercent;
        cumulativePercent += h.percent;
        h.endPercent = cumulativePercent;
      });
      
      // Render SVG slices
      const svg = document.getElementById('svgPieChart');
      svg.innerHTML = `
        <circle cx="70" cy="70" r="52" fill="none" stroke="rgba(255,255,255,0.03)" stroke-width="20"/>
        ${holdingsData.map((h, i) => `
          <path 
            class="svg-pie-slice" 
            data-index="${i}"
            d="${getSlicePath(h.startPercent, h.endPercent, false)}" 
            fill="${h.color}"
          />
        `).join('')}
      `;
      
      // Add event listeners to slices
      document.querySelectorAll('.svg-pie-slice').forEach(slice => {
        slice.addEventListener('mouseenter', () => updatePieHoverState(parseInt(slice.dataset.index)));
        slice.addEventListener('mouseleave', () => updatePieHoverState(null));
        slice.addEventListener('touchstart', (e) => {
          e.preventDefault();
          updatePieHoverState(parseInt(slice.dataset.index));
        });
      });
      
      // Update center content
      document.getElementById('pieCenterContent').innerHTML = `
        <div class="pie-center-value">$${totalValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
        <div class="pie-center-label">Total Value</div>
      `;
      
      // Render legend
      const legend = document.getElementById('proPieLegend');
      legend.innerHTML = holdingsData.map((h, i) => `
        <div class="legend-item" data-index="${i}">
          <div class="legend-dot" style="background: ${h.color}"></div>
          <div class="legend-logo" style="background: ${h.color}">${h.symbol.slice(0, 2)}</div>
          <div class="legend-info">
            <div class="legend-symbol">${h.symbol}</div>
            <div class="legend-name">${h.name}</div>
          </div>
          <div class="legend-values">
            <div class="legend-amount">$${h.value.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
            <div class="legend-pct">${h.percent.toFixed(1)}%</div>
          </div>
        </div>
      `).join('');
      
      // Add event listeners to legend items
      document.querySelectorAll('.legend-item').forEach(item => {
        item.addEventListener('mouseenter', () => updatePieHoverState(parseInt(item.dataset.index)));
        item.addEventListener('mouseleave', () => updatePieHoverState(null));
        item.addEventListener('click', () => {
          const idx = parseInt(item.dataset.index);
          updatePieHoverState(hoveredSliceIndex === idx ? null : idx);
        });
      });
      
      // Render footer stats
      const totalChange = totalValue - totalCost;
      const totalChangePercent = totalCost > 0 ? ((totalChange / totalCost) * 100) : 0;
      const changeClass = totalChange >= 0 ? 'positive' : 'negative';
      const changeSign = totalChange >= 0 ? '+' : '';
      
      // Calculate win rate
      const winners = holdingsData.filter(h => h.changePercent > 0).length;
      const winRate = holdingsData.length > 0 ? ((winners / holdingsData.length) * 100).toFixed(1) : '0';
      
      document.getElementById('proPieFooter').innerHTML = `
        <div class="footer-stat">
          <div class="footer-stat-label">Total Value</div>
          <div class="footer-stat-value">$${totalValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
        </div>
        <div class="footer-stat">
          <div class="footer-stat-label">Cost Basis</div>
          <div class="footer-stat-value" style="color: #cbd5e1">$${totalCost.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
        </div>
        <div class="footer-stat">
          <div class="footer-stat-label">Total Gain</div>
          <div class="footer-stat-value ${changeClass}">${changeSign}$${Math.abs(totalChange).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
        </div>
        <div class="footer-stat">
          <div class="footer-stat-label">Return</div>
          <div class="footer-stat-value ${changeClass}">${changeSign}${totalChangePercent.toFixed(1)}%</div>
        </div>
        <div class="footer-stat">
          <div class="footer-stat-label">Win Rate</div>
          <div class="footer-stat-value">${winRate}%</div>
        </div>
      `;
    }

    // Render holdings list (kept for backwards compatibility)
    function renderHoldingsList() {
      // Now handled by renderProPieChart
    }

    // Render table
    function renderTable() {
      const tbody = document.getElementById('table-body');
      const summaryEl = document.getElementById('table-summary');
      
      if (holdingsData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-muted); padding: 20px;">No holdings to display</td></tr>';
        summaryEl.innerHTML = '';
        return;
      }

      // Find top and worst performers
      const sortedByGain = [...holdingsData].sort((a, b) => b.changePercent - a.changePercent);
      const topSymbol = sortedByGain[0]?.symbol;
      const worstSymbol = sortedByGain[sortedByGain.length - 1]?.symbol;

      // Generate mini sparkline path (random but consistent for demo)
      function generateSparkline(isPositive, seed) {
        const points = [];
        let y = 16;
        for (let i = 0; i <= 7; i++) {
          const change = (Math.sin(seed + i * 0.8) * 6) + (isPositive ? -i * 1.2 : i * 1.2);
          y = Math.max(4, Math.min(28, 16 + change));
          points.push(`${i * 8.5},${y}`);
        }
        return 'M' + points.join(' L');
      }

      tbody.innerHTML = holdingsData.map((h, i) => {
        const isTop = h.symbol === topSymbol && h.changePercent > 0;
        const isWorst = h.symbol === worstSymbol && h.changePercent < 0;
        const gainSign = h.changePercent >= 0 ? '+' : '';
        const gainClass = h.changePercent >= 0 ? 'positive' : 'negative';
        const sparkPath = generateSparkline(h.changePercent >= 0, i * 3.7);
        const rowClass = isTop ? 'top-performer' : (isWorst ? 'worst-performer' : '');
        
        return `
        <tr class="${rowClass}">
          <td>
            <div class="stock-identity">
              <div class="stock-logo" style="background: linear-gradient(135deg, ${h.color}33, ${h.color}66);">${h.symbol.slice(0,2)}</div>
              <div class="stock-info">
                <span class="stock-symbol-text">${h.symbol}</span>
                <span class="stock-shares">${h.shares.toLocaleString()} shares @ $${h.avgCost.toFixed(2)}</span>
              </div>
            </div>
          </td>
          <td class="text-right">
            <div class="value-cell">
              <span class="current-value">$${h.value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
              <span class="cost-basis">$${(h.shares * h.avgCost).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} cost</span>
            </div>
          </td>
          <td class="text-right">
            <div class="gain-loss-cell">
              <span class="gain-amount ${gainClass}">${gainSign}$${Math.abs(h.change).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
              <span class="gain-percent-badge ${gainClass}">${gainSign}${h.changePercent.toFixed(1)}%</span>
            </div>
          </td>
          <td class="sparkline-cell">
            <svg class="mini-sparkline" viewBox="0 0 60 32">
              <path class="sparkline-path ${gainClass}" d="${sparkPath}"/>
            </svg>
          </td>
        </tr>
      `}).join('');

      // Update footer summary
      const totalChange = totalValue - totalCost;
      const totalChangePercent = totalCost > 0 ? ((totalChange / totalCost) * 100) : 0;
      const changeSign = totalChange >= 0 ? '+' : '';
      const changeClass = totalChange >= 0 ? 'positive' : 'negative';

      summaryEl.innerHTML = `
        <div class="summary-stat">
          <span class="summary-stat-label">Total Value</span>
          <span class="summary-stat-value">$${totalValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
        </div>
        <div class="summary-stat">
          <span class="summary-stat-label">Total Gain</span>
          <span class="summary-stat-value ${changeClass}">${changeSign}$${Math.abs(totalChange).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
        </div>
        <div class="summary-stat">
          <span class="summary-stat-label">Return</span>
          <span class="summary-stat-value ${changeClass}">${changeSign}${totalChangePercent.toFixed(1)}%</span>
        </div>
      `;
    }

    // Chart.js defaults
    Chart.defaults.color = 'rgba(255, 255, 255, 0.6)';
    Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';

    // Render all charts
    function renderCharts() {
      if (holdingsData.length === 0) return;

      // Destroy existing charts if they exist
      if (barChart) barChart.destroy();
      if (lineChart) lineChart.destroy();

      // Bar Chart
      const barCtx = document.getElementById('barChart').getContext('2d');
      barChart = new Chart(barCtx, {
        type: 'bar',
        data: {
          labels: holdingsData.map(h => h.symbol),
          datasets: [{
            label: 'Value',
            data: holdingsData.map(h => h.value),
            backgroundColor: holdingsData.map(h => h.color + '20'),
            borderColor: holdingsData.map(h => h.color),
            borderWidth: 2,
            borderRadius: 0,
            borderSkipped: false,
            barPercentage: 0.4,
            categoryPercentage: 0.6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const h = holdingsData[context.dataIndex];
                  return [
                    `Value: $${h.value.toLocaleString('en-US', { minimumFractionDigits: 2 })}`,
                    `Shares: ${h.shares.toLocaleString()}`,
                    `Price: $${h.currentPrice.toFixed(2)}`,
                    `P/L: ${h.changePercent >= 0 ? '+' : ''}${h.changePercent.toFixed(2)}%`
                  ];
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(128, 128, 128, 0.15)'
              },
              ticks: {
                color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim() || 'rgba(255,255,255,0.6)',
                callback: function(value) {
                  return '$' + value.toLocaleString();
                }
              }
            },
            x: {
              grid: {
                display: false
              },
              ticks: {
                color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim() || 'rgba(255,255,255,0.6)'
              }
            }
          }
        }
      });

      // Line Chart (historical data based on actual purchase dates)
      let currentTimeframe = '1M';
      
      // Get earliest purchase date from all positions
      function getEarliestPurchaseDate() {
        let earliest = new Date();
        Object.values(positions).forEach(pos => {
          if (pos.firstPurchase) {
            const date = new Date(pos.firstPurchase);
            if (date < earliest) earliest = date;
          }
          if (pos.history) {
            pos.history.forEach(h => {
              const date = new Date(h.date);
              if (date < earliest) earliest = date;
            });
          }
        });
        return earliest;
      }

      // Build cumulative value over time based on purchase history
      function buildPortfolioTimeline() {
        const timeline = [];
        const purchaseEvents = [];
        
        // Collect all purchase events from all positions
        Object.entries(positions).forEach(([symbol, pos]) => {
          if (pos.history) {
            pos.history.forEach(h => {
              purchaseEvents.push({
                date: new Date(h.date),
                symbol: symbol,
                shares: h.shares,
                price: h.price
              });
            });
          } else if (pos.firstPurchase) {
            // Legacy position without history array
            purchaseEvents.push({
              date: new Date(pos.firstPurchase),
              symbol: symbol,
              shares: pos.shares,
              price: pos.avgCost
            });
          }
        });
        
        // Sort by date
        purchaseEvents.sort((a, b) => a.date - b.date);
        
        return purchaseEvents;
      }
      
      function generateHistoricalData(period) {
        let days, dateFormat;
        const now = new Date();
        const earliestPurchase = getEarliestPurchaseDate();
        const purchaseEvents = buildPortfolioTimeline();
        
        switch(period) {
          case '1D':
            days = 1;
            dateFormat = { hour: 'numeric', minute: '2-digit' };
            break;
          case '1W':
            days = 7;
            dateFormat = { weekday: 'short' };
            break;
          case '1M':
            days = 30;
            dateFormat = { month: 'short', day: 'numeric' };
            break;
          case 'YTD':
            const jan1 = new Date(now.getFullYear(), 0, 1);
            days = Math.floor((now - jan1) / (1000 * 60 * 60 * 24));
            dateFormat = { month: 'short', day: 'numeric' };
            break;
          case '1Y':
            days = 365;
            dateFormat = { month: 'short', year: '2-digit' };
            break;
          case 'ALL':
            // Calculate days from earliest purchase
            days = Math.max(Math.floor((now - earliestPurchase) / (1000 * 60 * 60 * 24)), 30);
            dateFormat = { month: 'short', year: '2-digit' };
            break;
          default:
            days = 30;
            dateFormat = { month: 'short', day: 'numeric' };
        }
        
        const data = [];
        const pointCount = Math.min(days, period === '1D' ? 24 : period === '1W' ? 7 : period === '1M' ? 30 : 60);
        const step = days / pointCount;
        
        // Calculate starting cost basis for the period
        let startingCost = 0;
        const periodStart = new Date(now);
        periodStart.setDate(periodStart.getDate() - days);
        
        purchaseEvents.forEach(event => {
          if (event.date <= periodStart) {
            startingCost += event.shares * event.price;
          }
        });
        
        // Generate data points
        for (let i = pointCount; i >= 0; i--) {
          const date = new Date();
          if (period === '1D') {
            date.setHours(date.getHours() - i);
          } else {
            date.setDate(date.getDate() - Math.floor(i * step));
          }
          
          // Calculate portfolio value at this point
          let cumulativeCost = startingCost;
          purchaseEvents.forEach(event => {
            if (event.date > periodStart && event.date <= date) {
              cumulativeCost += event.shares * event.price;
            }
          });
          
          // Apply market movement simulation based on cost basis
          const daysSinceStart = Math.floor((date - periodStart) / (1000 * 60 * 60 * 24));
          const progress = daysSinceStart / days;
          
          // Simulate growth from cost basis to current value
          const growthFactor = totalCost > 0 ? (totalValue / totalCost) : 1;
          const currentGrowth = 1 + (growthFactor - 1) * progress;
          
          // Add some daily volatility
          const volatility = period === '1D' ? 0.002 : period === '1W' ? 0.005 : 0.01;
          const noise = (Math.random() - 0.5) * volatility * cumulativeCost;
          
          let value = cumulativeCost * currentGrowth + noise;
          
          // Ensure we end at actual current value
          if (i === 0) value = totalValue;
          
          data.push({
            date: date.toLocaleDateString('en-US', dateFormat),
            value: Math.max(value, 0)
          });
        }
        return data;
      }

      function updateLineChart(period) {
        currentTimeframe = period;
        const historicalData = generateHistoricalData(period);
        
        lineChart.data.labels = historicalData.map(d => d.date);
        lineChart.data.datasets[0].data = historicalData.map(d => d.value);
        lineChart.update();
      }

      const historicalData = generateHistoricalData(currentTimeframe);
      const lineCtx = document.getElementById('lineChart').getContext('2d');
      lineChart = new Chart(lineCtx, {
        type: 'line',
        data: {
          labels: historicalData.map(d => d.date),
          datasets: [{
            data: historicalData.map(d => d.value),
            borderColor: '#a855f7',
            backgroundColor: 'rgba(168, 85, 247, 0.1)',
            fill: true,
            tension: 0.4,
            pointRadius: 0,
            pointHoverRadius: 6,
            pointHoverBackgroundColor: '#a855f7',
            pointHoverBorderColor: '#fff',
            pointHoverBorderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return '$' + context.parsed.y.toLocaleString('en-US', { minimumFractionDigits: 2 });
                }
              }
            }
          },
          scales: {
            y: {
              grid: {
                color: 'rgba(128, 128, 128, 0.15)'
              },
              ticks: {
                color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim() || 'rgba(255,255,255,0.6)',
                callback: function(value) {
                  if (value >= 1000) {
                    return '$' + (value / 1000).toFixed(0) + 'K';
                  }
                  return '$' + value.toFixed(0);
                }
              }
            },
            x: {
              grid: {
                display: false
              },
              ticks: {
                color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim() || 'rgba(255,255,255,0.6)',
                maxTicksLimit: 6
              }
            }
          },
          interaction: {
            intersect: false,
            mode: 'index'
          }
        }
      });
    }

    // Tab switching with animation re-trigger
    document.querySelectorAll('.chart-tab').forEach(tab => {
      tab.addEventListener('click', function() {
        const view = this.dataset.view;
        const targetView = document.getElementById(view + '-view');
        
        // Update active tab
        document.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        
        // Hide all views
        document.querySelectorAll('.chart-view').forEach(v => v.classList.remove('active'));
        
        // Force animation restart by removing and re-adding class
        targetView.style.animation = 'none';
        targetView.offsetHeight; // Trigger reflow
        targetView.style.animation = null;
        
        // Show target view with fresh animations
        targetView.classList.add('active');
      });
    });

    // Timeframe tab switching
    document.querySelectorAll('.timeframe-tab').forEach(tab => {
      tab.addEventListener('click', function() {
        const period = this.dataset.period;
        
        // Update active tab
        document.querySelectorAll('.timeframe-tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        
        // Update line chart
        updateLineChart(period);
      });
    });

    // Apply saved theme
    const savedTheme = localStorage.getItem('apehub_theme') || 'dark';
    document.documentElement.setAttribute('data-theme', savedTheme);

    // Initialize on page load
    initializePortfolio();
  </script>
</body>
</html>