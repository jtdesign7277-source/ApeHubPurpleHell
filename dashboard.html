<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Dashboard | ApeHub</title>
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #111118;
      --bg-card: rgba(255, 255, 255, 0.03);
      --bg-card-hover: rgba(255, 255, 255, 0.06);
      --bg-solid: #1a1a24;
      --text-primary: #fff;
      --text-secondary: rgba(255, 255, 255, 0.6);
      --text-muted: rgba(255, 255, 255, 0.4);
      --border-color: rgba(255, 255, 255, 0.15);
      --border-light: rgba(255, 255, 255, 0.1);
      --accent: #a855f7;
      --accent-glow: rgba(168, 85, 247, 0.3);
      --nav-bg: rgba(10, 10, 15, 0.95);
      --card-bg: #16161d;
      --input-bg: rgba(255, 255, 255, 0.08);
      --color-up: #00d775;
      --color-down: #ff4757;
    }

    [data-theme="light"] {
      --bg-primary: #f8f9fa;
      --bg-secondary: #ffffff;
      --bg-card: rgba(0, 0, 0, 0.04);
      --bg-card-hover: rgba(0, 0, 0, 0.08);
      --bg-solid: #ffffff;
      --text-primary: #000000;
      --text-secondary: #333333;
      --text-muted: #555555;
      --border-color: rgba(0, 0, 0, 0.15);
      --border-light: rgba(0, 0, 0, 0.1);
      --accent: #7c3aed;
      --accent-glow: rgba(124, 58, 237, 0.15);
      --nav-bg: rgba(255, 255, 255, 0.95);
      --card-bg: #ffffff;
      --input-bg: #f0f0f5;
      --color-up: #16a34a;
      --color-down: #dc2626;
    }

    body {
      background: var(--bg-primary);
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Instrument Sans', sans-serif;
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
      transition: background 0.3s ease, color 0.3s ease;
    }

    /* ============================================
       MAIN CONTAINER
       ============================================ */
    .dashboard-container {
      max-width: 500px;
      margin: 0 auto;
      padding: 0;
      padding-bottom: 140px;
    }

    /* ============================================
       TOP BAR - Logo Left, Welcome Right
       ============================================ */
    .top-bar {
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* ============================================
       MARKET STATUS HEADER (Yahoo Finance Style)
       ============================================ */
    .market-header {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 24px 6px;
    }

    .market-header-icon {
      font-size: 12px;
    }

    .market-header-text {
      font-size: 10px;
      font-weight: 600;
      color: var(--text-primary);
      letter-spacing: 0.3px;
    }

    /* Futures Cards Container */
    .futures-container {
      display: flex;
      gap: 6px;
      padding: 0 16px 12px;
      overflow-x: hidden;
    }

    .futures-card {
      flex: 1 1 0;
      min-width: 0;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 6px 6px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .futures-name {
      font-size: 11px;
      font-weight: 500;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .futures-chart {
      display: none;
    }

    .futures-chart svg {
      width: 100%;
      height: 100%;
    }

    .futures-chart .chart-line {
      fill: none;
      stroke-width: 1;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .futures-chart .chart-line.up {
      stroke: var(--color-up);
    }

    .futures-chart .chart-line.down {
      stroke: var(--color-down);
    }

    .futures-chart .zero-line {
      stroke: var(--text-muted);
      stroke-width: 0.5;
      stroke-dasharray: 2, 2;
    }

    .futures-price {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      font-variant-numeric: tabular-nums;
    }

    .futures-change {
      font-size: 13px;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }

    .futures-change.up {
      color: var(--color-up);
    }

    .futures-change.down {
      color: var(--color-down);
    }

    /* Clock Section */
    .clock-section {
      padding: 8px 24px 16px;
    }

    .clock-left {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .time-row {
      display: flex;
      align-items: baseline;
      gap: 6px;
    }

    .current-time {
      font-size: 24px;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
      letter-spacing: -1px;
      color: var(--text-primary);
    }

    .time-period {
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 500;
    }

    .market-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .countdown {
      font-size: 11px;
      font-weight: 600;
      color: #a855f7;
      font-variant-numeric: tabular-nums;
    }

    .countdown-label {
      font-size: 11px;
      color: var(--text-muted);
    }

    .apehub-logo {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .apehub-logo:hover {
      opacity: 0.7;
    }

    .apehub-logo span {
      color: #a855f7;
    }

    .welcome {
      font-size: 15px;
      font-weight: 500;
      color: var(--text-secondary);
      text-align: right;
      cursor: pointer;
      transition: all 0.2s ease;
      padding: 8px 12px;
      border-radius: 12px;
      margin: -8px -12px;
      display: flex;
      align-items: center;
      gap: 4px;
      background: transparent;
      border: 1px solid transparent;
    }

    .welcome-arrow {
      opacity: 0.5;
      transition: transform 0.2s ease, opacity 0.2s ease;
    }

    .welcome:hover .welcome-arrow {
      opacity: 1;
      transform: translateX(2px);
    }

    .welcome:hover {
      color: #7c3aed;
      background: rgba(124, 58, 237, 0.05);
      border-color: rgba(124, 58, 237, 0.4);
    }

    .welcome:active {
      transform: scale(0.98);
    }

    .welcome span {
      color: #a855f7;
      font-weight: 600;
    }

    /* ============================================
       USER PROFILE PANEL
       ============================================ */
    .profile-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .profile-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .profile-panel {
      position: fixed;
      top: 0;
      right: -100%;
      width: 100%;
      max-width: 380px;
      height: 100%;
      background: var(--bg-primary);
      z-index: 1000;
      transition: right 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      display: flex;
      flex-direction: column;
      border-left: 1px solid var(--border-color);
    }

    .profile-panel.active {
      right: 0;
    }

    .profile-header {
      padding: 20px 20px 16px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: flex-end;
      align-items: center;
    }

    .profile-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .profile-close {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--bg-card);
      border: none;
      color: var(--text-primary);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      right: 0;
      top: 0;
      transition: all 0.2s ease;
    }

    .profile-close:hover {
      background: var(--bg-card-hover);
    }

    .profile-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px 20px;
    }

    .profile-avatar-section {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 12px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      margin-bottom: 16px;
      position: relative;
    }

    .profile-avatar {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: rgba(34, 197, 94, 0.15);
      border: 2px solid #22c55e;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      font-weight: 600;
      color: #22c55e;
      flex-shrink: 0;
      box-shadow: 0 0 16px rgba(34, 197, 94, 0.5), inset 0 0 8px rgba(34, 197, 94, 0.15);
    }

    .profile-user-info {
      display: flex;
      flex-direction: column;
    }

    .profile-name {
      font-size: 17px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .profile-handle {
      font-size: 13px;
      color: var(--text-muted);
    }

    .profile-info-section {
      margin-bottom: 16px;
    }

    .profile-info-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .profile-info-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 0;
      border-bottom: 1px solid var(--border-light);
    }

    .profile-info-item:last-child {
      border-bottom: none;
    }

    .profile-info-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: rgba(0, 215, 117, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-up);
      font-size: 18px;
      border: 1px solid rgba(0, 215, 117, 0.3);
      box-shadow: 0 0 8px rgba(0, 215, 117, 0.2);
    }

    .profile-info-content {
      flex: 1;
    }

    .profile-info-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .profile-info-value {
      font-size: 15px;
      font-weight: 500;
      color: var(--text-primary);
    }

    /* ============================================
       SUPPORT CHAT WIDGET
       ============================================ */
    .support-section {
      background: rgba(0, 215, 117, 0.1);
      border: 1px solid rgba(0, 215, 117, 0.2);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 24px;
      box-shadow: 0 0 12px rgba(0, 215, 117, 0.15);
    }

    .support-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .support-icon {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: linear-gradient(135deg, #3a8c6e, #2d6b54);
      box-shadow: 0 0 8px rgba(58, 140, 110, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .support-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .support-subtitle {
      font-size: 13px;
      color: var(--text-muted);
    }

    .chat-messages {
      max-height: 200px;
      overflow-y: auto;
      margin-bottom: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .chat-message {
      padding: 12px 14px;
      border-radius: 16px;
      max-width: 85%;
      font-size: 14px;
      line-height: 1.4;
    }

    .chat-message.support {
      background: var(--bg-card);
      color: var(--text-primary);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }

    .chat-message.user {
      background: rgba(0, 215, 117, 0.1);
      border: 2px solid var(--color-up);
      color: #fff;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
      box-shadow: 0 0 12px rgba(0, 215, 117, 0.4), inset 0 0 8px rgba(0, 215, 117, 0.1);
    }

    .chat-message-time {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .chat-input-row {
      display: flex;
      gap: 8px;
    }

    .chat-input {
      flex: 1;
      background: var(--input-bg);
      border: 1px solid var(--border-color);
      border-radius: 24px;
      padding: 12px 16px;
      color: var(--text-primary);
      font-size: 14px;
      outline: none;
      transition: all 0.2s ease;
    }

    .chat-input:focus {
      border-color: var(--color-up);
      background: rgba(0, 215, 117, 0.15);
      box-shadow: 0 0 12px rgba(0, 215, 117, 0.3);
    }

    .chat-input::placeholder {
      color: var(--text-muted);
    }

    .chat-send {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: #3a8c6e;
      border: none;
      color: #fff;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      box-shadow: 0 0 8px rgba(58, 140, 110, 0.2);
    }

    .chat-send:hover {
      background: #4a9d7e;
      transform: scale(1.05);
      box-shadow: 0 0 12px rgba(58, 140, 110, 0.3);
    }

    .chat-send:active {
      transform: scale(0.95);
    }

    .profile-logout {
      width: 100%;
      padding: 16px;
      background: rgba(0, 215, 117, 0.1);
      border: 2px solid var(--color-up);
      border-radius: 12px;
      color: var(--color-up);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 0 12px rgba(0, 215, 117, 0.4), inset 0 0 8px rgba(0, 215, 117, 0.1);
    }

    .profile-logout:hover {
      background: rgba(0, 215, 117, 0.2);
      box-shadow: 0 0 20px rgba(0, 215, 117, 0.6), inset 0 0 12px rgba(0, 215, 117, 0.2);
    }

    /* Theme Toggle */
    .theme-section {
      margin-bottom: 16px;
    }

    .theme-toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 0;
    }

    .theme-toggle-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .theme-toggle-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: rgba(168, 85, 247, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .theme-toggle-label {
      font-size: 15px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .theme-toggle-sublabel {
      font-size: 12px;
      color: var(--text-muted);
    }

    .theme-switch {
      position: relative;
      width: 52px;
      height: 28px;
    }

    .theme-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .theme-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--border-color);
      border-radius: 28px;
      transition: all 0.3s ease;
    }

    .theme-slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 3px;
      bottom: 3px;
      background: var(--text-primary);
      border-radius: 50%;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .theme-switch input:checked + .theme-slider {
      background: #a855f7;
    }

    .theme-switch input:checked + .theme-slider:before {
      transform: translateX(24px);
    }

    .theme-icons {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 16px;
    }

    .theme-icon-dark, .theme-icon-light {
      opacity: 0.4;
      transition: opacity 0.3s ease;
    }

    [data-theme="dark"] .theme-icon-dark,
    [data-theme="light"] .theme-icon-light {
      opacity: 1;
    }

    .market-price {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .market-change {
      font-size: 14px;
      font-weight: 600;
    }

    .market-change.up {
      color: var(--color-up);
    }

    .market-change.down {
      color: var(--color-down);
    }

    /* ============================================
       WATCHLIST SECTION
       ============================================ */
    .watchlist-section {
      padding: 20px 24px 24px;
    }

    .wl-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }

    .wl-title-section {
      flex: 1;
    }

    .wl-list-name {
      font-size: 10px;
      font-weight: 600;
      color: var(--text-muted);
      letter-spacing: 1.5px;
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .wl-total-value {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 2px;
      cursor: pointer;
    }

    .wl-value-row {
      display: flex;
      align-items: baseline;
      gap: 10px;
    }

    .wl-total-amount {
      font-size: 26px;
      font-weight: 600;
      color: var(--text-primary);
      letter-spacing: -1px;
    }

    .wl-today-change {
      font-size: 13px;
      font-weight: 600;
      color: var(--color-up);
    }

    .wl-today-change.down {
      color: var(--color-down);
    }

    .wl-alltime-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .wl-alltime-change {
      font-size: 13px;
      font-weight: 600;
      color: var(--color-up);
    }

    .wl-alltime-change.down {
      color: var(--color-down);
    }

    .wl-change-label {
      font-size: 12px;
      font-weight: 400;
      color: var(--text-muted);
    }

    .wl-divider {
      height: 1px;
      background: rgba(255, 255, 255, 0.1);
      margin-top: 8px;
    }

    /* Portfolio View Tabs */
    .portfolio-tabs {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .portfolio-tab {
      padding: 6px 14px;
      border: 1px solid var(--border-color);
      background: transparent;
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      border-radius: 14px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .portfolio-tab:hover {
      border-color: #7c3aed;
      color: var(--text-primary);
    }

    .portfolio-tab.active {
      background: transparent;
      border-color: #7c3aed;
      color: #7c3aed;
    }

    .portfolio-tab svg {
      width: 12px;
      height: 12px;
    }

    /* Gunmetal shiny stars for hidden values */
    .hidden-stars {
      background: linear-gradient(135deg, #2a2d33 0%, #4a4f5a 25%, #6b7280 50%, #4a4f5a 75%, #2a2d33 100%);
      background-size: 200% 200%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: gunmetalShine 3s ease-in-out infinite;
      text-shadow: none;
      font-weight: 400;
      letter-spacing: 2px;
    }

    @keyframes gunmetalShine {
      0%, 100% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
    }

    .wl-header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .wl-eye-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 8px;
      transition: all 0.2s;
    }

    .wl-eye-btn:hover {
      color: var(--text-secondary);
    }

    .wl-eye-btn .eye-open {
      display: block;
    }

    .wl-eye-btn .eye-closed {
      display: none;
    }

    .wl-eye-btn.hidden .eye-open {
      display: none;
    }

    .wl-eye-btn.hidden .eye-closed {
      display: block;
    }

    /* Watchlist collapse toggle */
    .wl-collapse-row {
      display: flex;
      justify-content: center;
      padding: 8px 0;
    }

    .wl-collapse-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px 16px;
      transition: all 0.3s;
    }

    .wl-collapse-btn:hover {
      color: var(--text-secondary);
    }

    .wl-collapse-btn.collapsed {
      transform: rotate(180deg);
    }

    /* ============================================
       SEARCH BAR
       ============================================ */
    .wl-search-container {
      position: relative;
      margin-bottom: 24px;
      padding-top: 0;
    }
    
    .wl-search-container::before {
      display: none;
    }

    .wl-search-input {
      width: 100%;
      padding: 14px 20px;
      padding-left: 48px;
      padding-right: 48px;
      border: none;
      border-radius: 14px;
      font-size: 15px;
      background: var(--input-bg);
      color: var(--text-primary);
      outline: none;
      transition: all 0.2s;
    }

    .wl-search-input::placeholder {
      color: var(--text-muted);
    }

    .wl-search-input:focus {
      background: var(--bg-card-hover);
      box-shadow: 0 0 0 2px var(--accent-glow);
    }

    .wl-search-icon {
      position: absolute;
      left: 18px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      pointer-events: none;
      margin-top: 0;
    }

    .wl-search-clear {
      position: absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
      border-radius: 50%;
      display: none;
      transition: color 0.2s;
    }

    .wl-search-clear:hover {
      color: var(--text-primary);
    }

    .wl-search-clear.visible {
      display: block;
    }

    /* ============================================
       SEARCH RESULTS DROPDOWN
       ============================================ */
    .wl-search-results {
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      right: 0;
      background: var(--bg-solid);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      max-height: 400px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
    }

    .wl-search-results.visible {
      display: block;
    }

    .wl-search-result {
      display: grid;
      grid-template-columns: 1fr auto auto auto;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      border-bottom: 1px solid var(--border-light);
      cursor: pointer;
      transition: background 0.2s;
    }

    .wl-search-result:last-child {
      border-bottom: none;
    }

    .wl-search-result:hover {
      background: var(--bg-card-hover);
    }

    .wl-result-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .wl-result-symbol {
      font-weight: 700;
      font-size: 15px;
      color: var(--text-primary);
    }

    .wl-result-name {
      font-size: 13px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .wl-result-sparkline {
      width: 80px;
      height: 30px;
    }

    .wl-result-price-col {
      text-align: right;
      min-width: 70px;
    }

    .wl-result-price {
      font-weight: 600;
      font-size: 15px;
      color: var(--text-primary);
    }

    .wl-result-change {
      font-size: 12px;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 4px;
      margin-top: 4px;
      display: inline-block;
    }

    .wl-result-change.up {
      background: var(--color-up);
      color: #000;
    }

    .wl-result-change.down {
      background: #ff4757;
      color: #fff;
    }

    /* Star button */
    .wl-star-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 4px;
    }

    .wl-star-btn:hover {
      background: rgba(255, 215, 0, 0.15);
    }

    .wl-star-btn svg {
      width: 22px;
      height: 22px;
      transition: all 0.2s;
    }

    .wl-star-btn .star-empty {
      color: var(--text-muted);
    }

    .wl-star-btn .star-filled {
      color: #FFD700;
      display: none;
    }

    .wl-star-btn.active .star-empty {
      display: none;
    }

    .wl-star-btn.active .star-filled {
      display: block;
    }

    /* No results */
    .wl-no-results {
      padding: 30px;
      text-align: center;
      color: var(--text-muted);
      font-size: 14px;
    }

    /* ============================================
       WATCHLIST LABEL
       ============================================ */
    .watchlist-label-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .watchlist-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      letter-spacing: 1.5px;
      text-transform: uppercase;
    }

    /* ============================================
       STOCK LIST (Main Watchlist)
       ============================================ */
    .wl-stock-list {
      max-height: 2000px;
      overflow: hidden;
      transition: max-height 0.4s ease, opacity 0.3s ease;
    }

    .wl-stock-list.collapsed {
      max-height: 0;
      opacity: 0;
    }

    .wl-stock-row {
      display: grid;
      grid-template-columns: 1fr 80px auto 24px;
      align-items: center;
      gap: 12px;
      padding: 16px 0;
      border-bottom: 1px solid var(--border-light);
      transition: background 0.2s;
      position: relative;
      cursor: pointer;
    }

    .wl-stock-row:active {
      background: var(--bg-card-hover);
    }

    .wl-stock-row:last-child {
      border-bottom: none;
    }

    .wl-stock-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .wl-stock-symbol {
      font-weight: 600;
      font-size: 16px;
      color: var(--text-primary);
      letter-spacing: -0.3px;
    }

    .wl-stock-name {
      font-size: 13px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .wl-stock-sparkline {
      width: 80px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .wl-stock-price-col {
      text-align: right;
      min-width: 80px;
    }

    .wl-stock-price {
      font-weight: 600;
      font-size: 16px;
      color: var(--text-primary);
    }

    .wl-stock-change {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .wl-stock-change.up {
      color: var(--color-up);
    }

    .wl-stock-change.down {
      color: var(--color-down);
    }

    /* Remove button */
    .wl-remove-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      opacity: 0.3;
      transition: all 0.2s;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .wl-stock-row:hover .wl-remove-btn {
      opacity: 1;
    }

    .wl-remove-btn:hover {
      color: var(--color-down);
    }

    /* ============================================
       EMPTY STATE
       ============================================ */
    .wl-empty {
      padding: 60px 24px;
      text-align: center;
      color: var(--text-muted);
    }

    .wl-empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    .wl-empty h3 {
      font-size: 18px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-weight: 500;
    }

    .wl-empty p {
      font-size: 14px;
      color: var(--text-muted);
    }

    /* ============================================
       TOAST
       ============================================ */
    .wl-toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--bg-card);
      color: var(--text-primary);
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      z-index: 1000;
      opacity: 0;
      transition: all 0.3s ease;
    }

    .wl-toast.visible {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .wl-toast.success {
      border-left: 3px solid var(--color-up);
    }

    .wl-toast.removed {
      border-left: 3px solid #ff4757;
    }

    /* ============================================
       MODAL
       ============================================ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      padding: 20px;
    }

    .modal-overlay.visible {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: var(--card-bg);
      border-radius: 20px;
      width: calc(100% - 32px);
      max-width: 380px;
      padding: 20px 16px;
      transform: scale(0.9) translateY(20px);
      transition: transform 0.3s ease;
      border: 1px solid var(--border-color);
      box-sizing: border-box;
    }

    .modal-overlay.visible .modal-content {
      transform: scale(1) translateY(0);
    }

    .modal-handle {
      display: none;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 24px;
    }

    .modal-stock-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .modal-symbol {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .modal-name {
      font-size: 14px;
      color: var(--text-muted);
    }

    .modal-price-info {
      text-align: right;
    }

    .modal-current-price {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .modal-price-change {
      font-size: 14px;
      font-weight: 600;
    }

    .modal-price-change.up {
      color: var(--color-up);
    }

    .modal-price-change.down {
      color: var(--color-down);
    }

    .modal-form {
      display: flex;
      flex-direction: column;
      gap: 16px;
      align-items: center;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      width: 100%;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-width: 0;
    }

    .form-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      text-align: center;
    }

    .form-input {
      background: var(--input-bg);
      border: none;
      border-radius: 8px;
      padding: 8px 6px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      outline: none;
      transition: all 0.2s;
      text-align: center;
      width: 100%;
      min-width: 0;
      box-sizing: border-box;
    }

    .form-input::placeholder {
      color: var(--text-muted);
    }

    .form-input:focus {
      background: var(--bg-card-hover);
      box-shadow: 0 0 0 2px var(--accent-glow);
    }

    .form-display {
      background: var(--input-bg);
      border: none;
      border-radius: 8px;
      padding: 8px 4px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      text-align: center;
      opacity: 0.7;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    .position-summary {
      width: 100%;
    }

    .modal-buttons {
      width: 100%;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .position-summary {
      background: var(--input-bg);
      border-radius: 12px;
      padding: 16px;
      margin-top: 8px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
    }

    .summary-row:not(:last-child) {
      border-bottom: 1px solid var(--border-light);
    }

    .summary-label {
      font-size: 14px;
      color: var(--text-muted);
    }

    .summary-value {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .summary-value.gain {
      color: var(--color-up);
    }

    .summary-value.loss {
      color: var(--color-down);
    }

    .modal-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .modal-btn {
      flex: 1;
      min-width: calc(50% - 4px);
      padding: 12px 16px;
      background: var(--bg-card);
      border: 2px solid transparent;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-btn-cancel {
      background: var(--input-bg);
      border-color: var(--border-color);
      color: var(--text-secondary);
    }

    .modal-btn-cancel:hover {
      background: var(--bg-card-hover);
      border-color: var(--text-muted);
      color: var(--text-primary);
    }

    .modal-btn-save {
      background: rgba(168, 85, 247, 0.1);
      border-color: #a855f7;
      color: #a855f7;
      box-shadow: 0 0 12px rgba(168, 85, 247, 0.3), inset 0 0 8px rgba(168, 85, 247, 0.1);
    }

    .modal-btn-save:hover {
      background: rgba(168, 85, 247, 0.2);
      box-shadow: 0 0 16px rgba(168, 85, 247, 0.5), inset 0 0 12px rgba(168, 85, 247, 0.15);
    }

    .modal-btn-add {
      background: rgba(0, 215, 117, 0.1);
      border-color: var(--color-up);
      color: var(--color-up);
      box-shadow: 0 0 12px rgba(0, 215, 117, 0.3), inset 0 0 8px rgba(0, 215, 117, 0.1);
    }

    .modal-btn-add:hover {
      background: rgba(0, 215, 117, 0.2);
      box-shadow: 0 0 16px rgba(0, 215, 117, 0.5), inset 0 0 12px rgba(0, 215, 117, 0.15);
    }

    .modal-btn-remove {
      background: rgba(255, 71, 87, 0.1);
      border-color: var(--color-down);
      color: var(--color-down);
      box-shadow: 0 0 12px rgba(255, 71, 87, 0.3), inset 0 0 8px rgba(255, 71, 87, 0.1);
    }

    .modal-btn-remove:hover {
      background: rgba(255, 71, 87, 0.2);
      box-shadow: 0 0 16px rgba(255, 71, 87, 0.5), inset 0 0 12px rgba(255, 71, 87, 0.15);
    }

    /* Modal buttons container - removed duplicate conflicting styles */

    /* ============================================
       CONFETTI CELEBRATION
       ============================================ */
    .confetti-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10000;
      overflow: hidden;
    }

    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      top: -10px;
      animation: confetti-fall linear forwards;
    }

    .confetti.square {
      border-radius: 2px;
    }

    .confetti.circle {
      border-radius: 50%;
    }

    .confetti.strip {
      width: 4px;
      height: 16px;
      border-radius: 2px;
    }

    @keyframes confetti-fall {
      0% {
        transform: translateY(0) rotate(0deg) scale(1);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(720deg) scale(0.5);
        opacity: 0;
      }
    }

    /* ============================================
       BOTTOM NAV
       ============================================ */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-primary);
      border-top: 1px solid rgba(255, 255, 255, 0.6);
      display: flex;
      justify-content: space-around;
      padding: 12px 0 28px;
      max-width: 500px;
      margin: 0 auto;
      z-index: 1000;
      width: 100%;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      color: var(--text-muted);
      text-decoration: none;
      font-size: 11px;
      transition: color 0.2s;
    }

    .nav-item.active {
      color: rgba(168, 85, 247, 0.55);
    }

    .nav-item svg {
      width: 24px;
      height: 24px;
    }

    /* Predictions Tab Styles */
    .nav-item.predictions .nav-icon-wrapper {
      position: relative;
    }
    .nav-item.predictions .nav-icon {
      font-size: 20px;
    }
    .nav-live-dot {
      position: absolute;
      top: -2px;
      right: -6px;
      width: 8px;
      height: 8px;
      background: #10b981;
      border-radius: 50%;
      border: 2px solid #0a0a0f;
      animation: live-pulse 2s ease-in-out infinite;
    }
    @keyframes live-pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.2); }
    }
    .nav-item.predictions.active {
      color: #a855f7;
    }
    .nav-item.predictions.active .nav-icon {
      filter: drop-shadow(0 0 8px rgba(168, 85, 247, 0.6));
    }

    /* ============================================
       SCROLLBAR
       ============================================ */
    ::-webkit-scrollbar {
      width: 4px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

        ::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 2px;
    }

    /* Safe area for iOS */
    @supports (padding-bottom: env(safe-area-inset-bottom)) {
      .dashboard-container {
        padding-bottom: calc(140px + env(safe-area-inset-bottom));
      }
      .bottom-nav {
        padding-bottom: calc(12px + env(safe-area-inset-bottom));
      }
    }

    /* ============================================
       AVATAR SELECTOR
       ============================================ */
    .avatar-edit-wrapper {
      position: relative;
      cursor: pointer;
    }

    .avatar-edit-overlay {
      position: absolute;
      bottom: -2px;
      right: -2px;
      width: 22px;
      height: 22px;
      background: #22c55e;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      border: 2px solid var(--bg-primary);
      transition: transform 0.2s;
    }

    .avatar-edit-wrapper:hover .avatar-edit-overlay {
      transform: scale(1.1);
    }

    .profile-avatar.has-image {
      padding: 0;
      overflow: hidden;
    }

    .profile-avatar.has-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .avatar-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index: 10001;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .avatar-modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .avatar-modal {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-primary);
      border-radius: 24px 24px 0 0;
      padding: 24px 20px 40px;
      z-index: 10002;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      max-height: 70vh;
      overflow-y: auto;
    }

    .avatar-modal-overlay.active .avatar-modal {
      transform: translateY(0);
    }

    .avatar-modal-handle {
      width: 40px;
      height: 4px;
      background: var(--border-color);
      border-radius: 2px;
      margin: 0 auto 20px;
    }

    .avatar-modal-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      text-align: center;
      margin-bottom: 24px;
    }

    .avatar-upload-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      width: 100%;
      padding: 16px;
      background: rgba(34, 197, 94, 0.1);
      border: 2px dashed rgba(34, 197, 94, 0.4);
      border-radius: 16px;
      color: #22c55e;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 20px;
    }

    .avatar-upload-btn:hover {
      background: rgba(34, 197, 94, 0.15);
      border-color: #22c55e;
    }

    .avatar-upload-btn input {
      display: none;
    }

    .avatar-divider {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
    }

    .avatar-divider-line {
      flex: 1;
      height: 1px;
      background: var(--border-color);
    }

    .avatar-divider-text {
      color: var(--text-muted);
      font-size: 13px;
    }

    .avatar-styles-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
    }

    .avatar-styles-scroll {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      padding-bottom: 12px;
      margin-bottom: 16px;
      -webkit-overflow-scrolling: touch;
    }

    .avatar-styles-scroll::-webkit-scrollbar {
      height: 4px;
    }

    .avatar-styles-scroll::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 2px;
    }

    .avatar-style-card {
      flex-shrink: 0;
      width: 80px;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
      background: var(--bg-card);
      border: 2px solid transparent;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .avatar-style-card:hover {
      background: var(--bg-card-hover);
    }

    .avatar-style-card.selected {
      border-color: #22c55e;
      background: rgba(34, 197, 94, 0.1);
    }

    .avatar-style-preview {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      margin-bottom: 6px;
      background: var(--bg-primary);
    }

    .avatar-style-name {
      font-size: 11px;
      color: var(--text-muted);
      text-align: center;
    }

    .avatar-variations-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .avatar-shuffle-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      color: var(--text-primary);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .avatar-shuffle-btn:hover {
      background: var(--bg-card-hover);
      border-color: #22c55e;
    }

    .avatar-variations-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    .avatar-variation {
      aspect-ratio: 1;
      border-radius: 12px;
      border: 2px solid transparent;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--bg-card);
    }

    .avatar-variation:hover {
      transform: scale(1.05);
    }

    .avatar-variation.selected {
      border-color: #22c55e;
      box-shadow: 0 0 12px rgba(34, 197, 94, 0.4);
    }

    .avatar-custom-input {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .avatar-custom-input input {
      flex: 1;
      padding: 12px 16px;
      background: var(--input-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      color: var(--text-primary);
      font-size: 14px;
      outline: none;
    }

    .avatar-custom-input input:focus {
      border-color: #a855f7;
    }

    .avatar-custom-input input::placeholder {
      color: var(--text-muted);
    }

    .avatar-custom-btn {
      padding: 12px 20px;
      background: linear-gradient(135deg, #a855f7 0%, #6366f1 100%);
      border: none;
      border-radius: 12px;
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .avatar-custom-btn:hover {
      transform: scale(1.02);
    }

    .avatar-presets {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 16px;
    }

    .avatar-preset-tag {
      padding: 6px 12px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      color: var(--text-secondary);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .avatar-preset-tag:hover {
      background: rgba(168, 85, 247, 0.15);
      border-color: #a855f7;
      color: #a855f7;
    }

    .avatar-variation img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .avatar-cancel-btn {
      width: 100%;
      padding: 14px;
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      color: var(--text-muted);
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .avatar-cancel-btn:hover {
      background: var(--bg-card);
      color: var(--text-primary);
    }
  </style>
  <script src="data-sync.js"></script>
</head>
<body>
  <div class="dashboard-container">
    
    <!-- Top Bar -->
    <div class="top-bar">
      <a href="/landing.html" class="apehub-logo" id="apehubLogo" style="text-decoration: none;">Ape<span>Hub</span></a>
      <div class="welcome" onclick="openProfile()">Welcome, <span id="userName">User</span> <svg class="welcome-arrow" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></div>
    </div>

    <!-- Countdown Timer -->
    <div class="clock-section">
      <div class="market-row">
        <span class="countdown" id="countdown">00:00:00</span>
        <span class="countdown-label" id="countdownLabel">until open</span>
      </div>
    </div>

    <!-- Futures Cards -->
    <div class="futures-container" id="futuresContainer">
      <div class="futures-card">
        <div class="futures-name" id="name-es">S&P Futures</div>
        <div class="futures-chart" id="chart-es"></div>
        <div class="futures-price" id="price-es">5,996.50</div>
        <div class="futures-change up" id="change-es">+0.32%</div>
      </div>
      <div class="futures-card">
        <div class="futures-name" id="name-ym">Dow Futures</div>
        <div class="futures-chart" id="chart-ym"></div>
        <div class="futures-price" id="price-ym">43,520.00</div>
        <div class="futures-change up" id="change-ym">+0.18%</div>
      </div>
      <div class="futures-card">
        <div class="futures-name" id="name-nq">Nasdaq Futures</div>
        <div class="futures-chart" id="chart-nq"></div>
        <div class="futures-price" id="price-nq">21,285.75</div>
        <div class="futures-change up" id="change-nq">+0.45%</div>
      </div>
      <div class="futures-card">
        <div class="futures-name" id="name-rty">Russell 2000</div>
        <div class="futures-chart" id="chart-rty"></div>
        <div class="futures-price" id="price-rty">2,025.60</div>
        <div class="futures-change up" id="change-rty">+0.22%</div>
      </div>
    </div>

    <!-- User Profile Panel -->
    <div class="profile-overlay" id="profileOverlay" onclick="closeProfile()"></div>
    <div class="profile-panel" id="profilePanel">
      <div class="profile-content">
        <div class="profile-avatar-section">
          <div class="avatar-edit-wrapper" onclick="openAvatarSelector()">
            <div class="profile-avatar" id="profileAvatar">U</div>
            <div class="avatar-edit-overlay">‚úèÔ∏è</div>
          </div>
          <div class="profile-user-info">
            <div class="profile-name" id="profileName">User</div>
          </div>
          <button class="profile-close" onclick="closeProfile()">√ó</button>
        </div>
        
        <div class="profile-info-section">
          <div class="profile-info-title">Account Information</div>
          <div class="profile-info-item">
            <div class="profile-info-icon">üë§</div>
            <div class="profile-info-content">
              <div class="profile-info-label">Full Name</div>
              <div class="profile-info-value" id="infoName">User</div>
            </div>
          </div>
          <div class="profile-info-item">
            <div class="profile-info-icon">‚úâÔ∏è</div>
            <div class="profile-info-content">
              <div class="profile-info-label">Email Address</div>
              <div class="profile-info-value" id="infoEmail">user@example.com</div>
            </div>
          </div>
          <div class="profile-info-item">
            <div class="profile-info-icon">üìÖ</div>
            <div class="profile-info-content">
              <div class="profile-info-label">Member Since</div>
              <div class="profile-info-value" id="infoJoined">January 12, 2026</div>
            </div>
          </div>
        </div>

        <div class="theme-section">
          <div class="profile-info-title">Appearance</div>
          <div class="theme-toggle-row">
            <div class="theme-toggle-left">
              <div class="theme-toggle-icon">üé®</div>
              <div>
                <div class="theme-toggle-label">Theme</div>
                <div class="theme-toggle-sublabel" id="themeLabel">Dark mode</div>
              </div>
            </div>
            <div class="theme-icons">
              <span class="theme-icon-dark">üåô</span>
              <label class="theme-switch">
                <input type="checkbox" id="themeToggle" onchange="toggleTheme()">
                <span class="theme-slider"></span>
              </label>
              <span class="theme-icon-light">‚òÄÔ∏è</span>
            </div>
          </div>
        </div>

        <div class="support-section">
          <div class="support-header">
            <div class="support-icon">üí¨</div>
            <div>
              <div class="support-title">Support Chat</div>
              <div class="support-subtitle">We typically reply within minutes</div>
            </div>
          </div>
          <div class="chat-messages" id="chatMessages">
            <div class="chat-message support">
              Hi! üëã Welcome to ApeHub support. How can I help you today?
              <div class="chat-message-time">Support Team</div>
            </div>
          </div>
          <div class="chat-input-row">
            <input type="text" class="chat-input" id="chatInput" placeholder="Type your message..." onkeypress="handleChatKeypress(event)">
            <button class="chat-send" onclick="sendSupportMessage()">‚û§</button>
          </div>
        </div>

        <a href="logout.html" class="profile-logout" style="display: block; text-decoration: none; text-align: center;">Sign Out</a>
      </div>
    </div>

    <!-- Avatar Selector Modal -->
    <div class="avatar-modal-overlay" id="avatarModalOverlay" onclick="closeAvatarSelector(event)">
      <div class="avatar-modal" onclick="event.stopPropagation()">
        <div class="avatar-modal-handle"></div>
        <div class="avatar-modal-title">Choose Your Avatar</div>
        
        <label class="avatar-upload-btn">
          <span>üì∑</span>
          <span>Upload Your Own Photo</span>
          <input type="file" id="avatarFileInput" accept="image/*" onchange="handleAvatarUpload(event)">
        </label>
        
        <div class="avatar-divider">
          <div class="avatar-divider-line"></div>
          <span class="avatar-divider-text">or pick from these</span>
          <div class="avatar-divider-line"></div>
        </div>
        
        <div class="avatar-variations-header" id="variationsHeader" style="display: flex;">
          <div class="avatar-styles-title" style="margin: 0;">Pick Your Avatar</div>
          <button class="avatar-shuffle-btn" onclick="shuffleVariations()">üîÑ Shuffle</button>
        </div>
        <div class="avatar-variations-grid" id="avatarVariationsGrid">
          <!-- Populated by JavaScript -->
        </div>
        
        <button class="avatar-cancel-btn" onclick="closeAvatarSelector()">Cancel</button>
      </div>
    </div>

    <!-- Watchlist Section -->
    <div class="watchlist-section">
      <div class="wl-header">
        <div class="wl-title-section">
          <div class="wl-list-name">Portfolio</div>
          <div class="wl-total-value" onclick="toggleValueDisplay()">
            <div class="wl-value-row">
              <span class="wl-total-amount" id="watchlist-total-value">$0.00</span>
              <span class="wl-today-change" id="watchlist-change-today">+$3,914.96 (+1.59%)</span>
            </div>
            <div class="wl-divider"></div>
            <div class="wl-alltime-row">
              <span class="wl-alltime-change" id="watchlist-change-alltime">+$74,959.77 (+42.89%)</span>
              <span class="wl-change-label">All time</span>
              <a href="analytics.html" class="portfolio-tab" style="text-decoration: none; margin-left: auto; border: none;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 21H4.6c-.56 0-.84 0-1.054-.109a1 1 0 0 1-.437-.437C3 20.24 3 19.96 3 19.4V3"/>
                  <path d="m7 14 4-4 4 4 6-6"/>
                </svg>
                Analytics
              </a>
            </div>
            <div class="wl-divider"></div>
          </div>
        </div>
        <div class="wl-header-actions">
          <button class="wl-eye-btn" id="eye-btn" onclick="toggleHideValues()">
            <svg class="eye-open" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
              <circle cx="12" cy="12" r="3"/>
            </svg>
            <svg class="eye-closed" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
              <line x1="1" y1="1" x2="23" y2="23"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- Search -->
      <div class="wl-search-container">
        <svg class="wl-search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <path d="M21 21l-4.35-4.35"/>
        </svg>
        <input 
          type="text" 
          class="wl-search-input" 
          id="search-input"
          placeholder="Search"
          autocomplete="off"
        />
        <button class="wl-search-clear" id="search-clear" onclick="clearSearch()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
        
        <!-- Search Results -->
        <div class="wl-search-results" id="search-results"></div>
      </div>

      <!-- Watchlist Label with Collapse -->
      <div class="watchlist-label-row">
        <span class="watchlist-label">Watchlist</span>
        <button class="wl-collapse-btn" id="collapse-btn" onclick="toggleCollapse()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="18 15 12 9 6 15"/>
          </svg>
        </button>
      </div>

      <!-- Stock List -->
      <div class="wl-stock-list" id="watchlist-content">
        <div class="wl-empty">
          <div class="wl-empty-icon">‚≠ê</div>
          <h3>Your watchlist is empty</h3>
          <p>Search for stocks and tap the star to add them</p>
        </div>
      </div>

    </div> <!-- end watchlist-section -->

  </div>

  <!-- Bottom Nav -->
  <nav class="bottom-nav">
    <a href="dashboard.html" class="nav-item active">
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 3L2 12h3v8h6v-6h2v6h6v-8h3L12 3z"/>
      </svg>
      <span>Home</span>
    </a>
    <a href="news.html" class="nav-item">
      <svg viewBox="0 0 16 16" fill="currentColor">
        <path d="M8 0C8 4.418 4.418 8 0 8C4.418 8 8 11.582 8 16C8 11.582 11.582 8 16 8C11.582 8 8 4.418 8 0Z"/>
      </svg>
      <span>News</span>
    </a>
    <a href="predictions.html" class="nav-item predictions">
      <div class="nav-icon-wrapper">
        <span class="nav-icon">üîÆ</span>
      </div>
      <span>Predict</span>
    </a>
    <a href="charts.html" class="nav-item">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M9 5v4"/>
        <rect x="7" y="9" width="4" height="6" rx="0.5" fill="currentColor"/>
        <path d="M9 15v4"/>
        <path d="M15 3v2"/>
        <rect x="13" y="5" width="4" height="8" rx="0.5"/>
        <path d="M15 13v6"/>
      </svg>
      <span>Charts</span>
    </a>
    <a href="chat.html" class="nav-item">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2C6.48 2 2 6.48 2 12c0 1.85.5 3.58 1.36 5.08L2 22l4.92-1.36C8.42 21.5 10.15 22 12 22c5.52 0 10-4.48 10-10S17.52 2 12 2z"/>
      </svg>
      <span>Chat</span>
    </a>
  </nav>

  <!-- Toast -->
  <div class="wl-toast" id="toast"></div>

  <!-- Stock Modal -->
  <div class="modal-overlay" id="stock-modal">
    <div class="modal-content">
      <div class="modal-handle"></div>
      <div class="modal-header">
        <div class="modal-stock-info">
          <span class="modal-symbol" id="modal-symbol">AAPL</span>
          <span class="modal-name" id="modal-name">Apple Inc.</span>
        </div>
        <div class="modal-price-info">
          <div class="modal-current-price" id="modal-price">$248.13</div>
          <div class="modal-price-change up" id="modal-change">+2.34%</div>
        </div>
      </div>
      <div class="modal-form">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Add Shares</label>
            <input type="number" class="form-input" id="modal-add-shares" placeholder="0" min="0" step="any" onchange="updateModalCalculations()">
          </div>
          <div class="form-group">
            <label class="form-label">Price Paid</label>
            <input type="number" class="form-input" id="modal-cost" placeholder="$0.00" min="0" step="0.01" onchange="updateModalCalculations()">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Remove Shares</label>
            <input type="number" class="form-input" id="modal-shares" placeholder="0" min="0" step="any" onchange="updateModalCalculations()">
          </div>
          <div class="form-group">
            <label class="form-label">Price Sold</label>
            <input type="number" class="form-input" id="modal-price-sold" placeholder="$0.00" min="0" step="0.01" onchange="updateModalCalculations()">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Avg Cost</label>
            <div class="form-display" id="modal-avg-cost">$0.00</div>
          </div>
          <div class="form-group">
            <label class="form-label">Purchase Date</label>
            <input type="date" class="form-input" id="modal-purchase-date">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">First Purchase</label>
            <div class="form-display" id="modal-first-purchase">--</div>
          </div>
          <div class="form-group">
            <label class="form-label">Total Shares</label>
            <div class="form-display" id="modal-total-shares">0</div>
          </div>
        </div>
        <div class="position-summary">
          <div class="summary-row">
            <span class="summary-label">Market Value</span>
            <span class="summary-value" id="modal-market-value">$0.00</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Total Cost</span>
            <span class="summary-value" id="modal-total-cost">$0.00</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Total Return</span>
            <span class="summary-value" id="modal-return">$0.00</span>
          </div>
        </div>
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-cancel" onclick="closeModal()">Cancel</button>
          <button class="modal-btn modal-btn-save" onclick="savePosition()">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // STOCK DATABASE
    // ============================================
    const stockDatabase = [
      // Tech Giants
      { symbol: 'AAPL', name: 'Apple Inc.', price: 248.13, changePercent: 2.34, trend: 'up' },
      { symbol: 'MSFT', name: 'Microsoft Corporation', price: 438.92, changePercent: -0.87, trend: 'down' },
      { symbol: 'GOOGL', name: 'Alphabet Inc.', price: 191.24, changePercent: 1.56, trend: 'up' },
      { symbol: 'GOOG', name: 'Alphabet Inc. Class C', price: 192.85, changePercent: 1.48, trend: 'up' },
      { symbol: 'AMZN', name: 'Amazon.com Inc.', price: 225.94, changePercent: 3.21, trend: 'up' },
      { symbol: 'TSLA', name: 'Tesla Inc.', price: 394.36, changePercent: -2.15, trend: 'down' },
      { symbol: 'META', name: 'Meta Platforms Inc.', price: 617.12, changePercent: 1.89, trend: 'up' },
      { symbol: 'NVDA', name: 'NVIDIA Corporation', price: 140.14, changePercent: 4.52, trend: 'up' },
      { symbol: 'AVGO', name: 'Broadcom Inc.', price: 232.45, changePercent: 2.18, trend: 'up' },
      { symbol: 'ORCL', name: 'Oracle Corporation', price: 178.32, changePercent: 1.23, trend: 'up' },
      { symbol: 'CRM', name: 'Salesforce Inc.', price: 342.18, changePercent: -0.54, trend: 'down' },
      { symbol: 'ADBE', name: 'Adobe Inc.', price: 478.92, changePercent: 0.87, trend: 'up' },
      { symbol: 'AMD', name: 'Advanced Micro Devices', price: 124.56, changePercent: 3.42, trend: 'up' },
      { symbol: 'INTC', name: 'Intel Corporation', price: 19.84, changePercent: -1.56, trend: 'down' },
      { symbol: 'QCOM', name: 'Qualcomm Inc.', price: 158.73, changePercent: 1.92, trend: 'up' },
      { symbol: 'TXN', name: 'Texas Instruments', price: 192.45, changePercent: 0.68, trend: 'up' },
      { symbol: 'IBM', name: 'IBM Corporation', price: 224.18, changePercent: 0.34, trend: 'up' },
      { symbol: 'NOW', name: 'ServiceNow Inc.', price: 1024.56, changePercent: 2.14, trend: 'up' },
      { symbol: 'INTU', name: 'Intuit Inc.', price: 628.34, changePercent: 1.45, trend: 'up' },
      { symbol: 'CSCO', name: 'Cisco Systems Inc.', price: 58.92, changePercent: 0.23, trend: 'up' },
      { symbol: 'MU', name: 'Micron Technology', price: 87.45, changePercent: 2.87, trend: 'up' },
      { symbol: 'AMAT', name: 'Applied Materials', price: 178.23, changePercent: 1.98, trend: 'up' },
      { symbol: 'LRCX', name: 'Lam Research Corp', price: 72.34, changePercent: 2.12, trend: 'up' },
      { symbol: 'KLAC', name: 'KLA Corporation', price: 678.45, changePercent: 1.76, trend: 'up' },
      { symbol: 'SNPS', name: 'Synopsys Inc.', price: 512.34, changePercent: 0.89, trend: 'up' },
      { symbol: 'CDNS', name: 'Cadence Design Systems', price: 298.76, changePercent: 1.23, trend: 'up' },
      { symbol: 'MRVL', name: 'Marvell Technology', price: 118.45, changePercent: 3.21, trend: 'up' },
      { symbol: 'NXPI', name: 'NXP Semiconductors', price: 234.56, changePercent: 1.45, trend: 'up' },
      { symbol: 'ON', name: 'ON Semiconductor', price: 68.92, changePercent: 2.34, trend: 'up' },
      { symbol: 'MCHP', name: 'Microchip Technology', price: 58.23, changePercent: -0.87, trend: 'down' },
      
      // Financials
      { symbol: 'JPM', name: 'JPMorgan Chase & Co.', price: 252.32, changePercent: 0.76, trend: 'up' },
      { symbol: 'V', name: 'Visa Inc.', price: 318.45, changePercent: 0.45, trend: 'up' },
      { symbol: 'MA', name: 'Mastercard Inc.', price: 528.67, changePercent: 0.82, trend: 'up' },
      { symbol: 'BAC', name: 'Bank of America Corp', price: 45.23, changePercent: 2.15, trend: 'up' },
      { symbol: 'WFC', name: 'Wells Fargo & Co.', price: 72.45, changePercent: 1.23, trend: 'up' },
      { symbol: 'GS', name: 'Goldman Sachs Group', price: 612.34, changePercent: 1.87, trend: 'up' },
      { symbol: 'MS', name: 'Morgan Stanley', price: 128.45, changePercent: 1.45, trend: 'up' },
      { symbol: 'C', name: 'Citigroup Inc.', price: 78.92, changePercent: 0.98, trend: 'up' },
      { symbol: 'BLK', name: 'BlackRock Inc.', price: 1045.67, changePercent: 0.67, trend: 'up' },
      { symbol: 'SCHW', name: 'Charles Schwab Corp', price: 78.34, changePercent: 1.12, trend: 'up' },
      { symbol: 'AXP', name: 'American Express Co.', price: 298.45, changePercent: 1.34, trend: 'up' },
      { symbol: 'SPGI', name: 'S&P Global Inc.', price: 512.34, changePercent: 0.56, trend: 'up' },
      { symbol: 'CME', name: 'CME Group Inc.', price: 228.45, changePercent: 0.34, trend: 'up' },
      { symbol: 'ICE', name: 'Intercontinental Exchange', price: 156.78, changePercent: 0.45, trend: 'up' },
      { symbol: 'PNC', name: 'PNC Financial Services', price: 198.34, changePercent: 0.87, trend: 'up' },
      { symbol: 'USB', name: 'U.S. Bancorp', price: 52.45, changePercent: 0.67, trend: 'up' },
      { symbol: 'TFC', name: 'Truist Financial Corp', price: 42.34, changePercent: 0.45, trend: 'up' },
      { symbol: 'COF', name: 'Capital One Financial', price: 178.92, changePercent: 1.56, trend: 'up' },
      { symbol: 'BK', name: 'Bank of New York Mellon', price: 82.34, changePercent: 0.78, trend: 'up' },
      { symbol: 'AIG', name: 'American Intl Group', price: 78.45, changePercent: 0.56, trend: 'up' },
      { symbol: 'MET', name: 'MetLife Inc.', price: 82.34, changePercent: 0.67, trend: 'up' },
      { symbol: 'PRU', name: 'Prudential Financial', price: 118.45, changePercent: 0.89, trend: 'up' },
      { symbol: 'ALL', name: 'Allstate Corporation', price: 198.34, changePercent: 0.45, trend: 'up' },
      { symbol: 'TRV', name: 'Travelers Companies', price: 268.45, changePercent: 0.34, trend: 'up' },
      { symbol: 'CB', name: 'Chubb Limited', price: 298.34, changePercent: 0.56, trend: 'up' },
      { symbol: 'AON', name: 'Aon plc', price: 378.45, changePercent: 0.67, trend: 'up' },
      { symbol: 'MMC', name: 'Marsh McLennan Cos', price: 228.34, changePercent: 0.45, trend: 'up' },
      { symbol: 'PYPL', name: 'PayPal Holdings Inc.', price: 88.92, changePercent: 2.34, trend: 'up' },
      { symbol: 'SQ', name: 'Block Inc.', price: 92.45, changePercent: 3.12, trend: 'up' },
      { symbol: 'COIN', name: 'Coinbase Global Inc.', price: 278.34, changePercent: 5.67, trend: 'up' },
      { symbol: 'HOOD', name: 'Robinhood Markets', price: 42.34, changePercent: 4.23, trend: 'up' },
      { symbol: 'SOFI', name: 'SoFi Technologies', price: 16.78, changePercent: 3.45, trend: 'up' },
      
      // Healthcare
      { symbol: 'UNH', name: 'UnitedHealth Group', price: 502.34, changePercent: -1.24, trend: 'down' },
      { symbol: 'JNJ', name: 'Johnson & Johnson', price: 146.75, changePercent: 0.18, trend: 'up' },
      { symbol: 'LLY', name: 'Eli Lilly and Co.', price: 782.45, changePercent: 2.34, trend: 'up' },
      { symbol: 'PFE', name: 'Pfizer Inc.', price: 26.34, changePercent: -0.87, trend: 'down' },
      { symbol: 'ABBV', name: 'AbbVie Inc.', price: 178.92, changePercent: 0.67, trend: 'up' },
      { symbol: 'MRK', name: 'Merck & Co. Inc.', price: 98.45, changePercent: 0.45, trend: 'up' },
      { symbol: 'TMO', name: 'Thermo Fisher Scientific', price: 512.34, changePercent: 1.23, trend: 'up' },
      { symbol: 'ABT', name: 'Abbott Laboratories', price: 118.92, changePercent: 0.56, trend: 'up' },
      { symbol: 'DHR', name: 'Danaher Corporation', price: 248.45, changePercent: 0.78, trend: 'up' },
      { symbol: 'BMY', name: 'Bristol-Myers Squibb', price: 52.34, changePercent: -0.34, trend: 'down' },
      { symbol: 'AMGN', name: 'Amgen Inc.', price: 268.92, changePercent: 0.89, trend: 'up' },
      { symbol: 'GILD', name: 'Gilead Sciences Inc.', price: 92.45, changePercent: 0.56, trend: 'up' },
      { symbol: 'VRTX', name: 'Vertex Pharmaceuticals', price: 428.34, changePercent: 1.45, trend: 'up' },
      { symbol: 'REGN', name: 'Regeneron Pharma', price: 712.45, changePercent: 0.67, trend: 'up' },
      { symbol: 'ISRG', name: 'Intuitive Surgical', price: 578.34, changePercent: 1.89, trend: 'up' },
      { symbol: 'MDT', name: 'Medtronic plc', price: 88.92, changePercent: 0.34, trend: 'up' },
      { symbol: 'SYK', name: 'Stryker Corporation', price: 398.45, changePercent: 0.78, trend: 'up' },
      { symbol: 'BSX', name: 'Boston Scientific Corp', price: 92.34, changePercent: 1.12, trend: 'up' },
      { symbol: 'ELV', name: 'Elevance Health Inc.', price: 412.45, changePercent: -0.56, trend: 'down' },
      { symbol: 'CI', name: 'Cigna Group', price: 298.34, changePercent: 0.67, trend: 'up' },
      { symbol: 'HUM', name: 'Humana Inc.', price: 278.92, changePercent: -0.89, trend: 'down' },
      { symbol: 'CVS', name: 'CVS Health Corp.', price: 52.34, changePercent: 0.45, trend: 'up' },
      { symbol: 'MCK', name: 'McKesson Corporation', price: 578.45, changePercent: 0.67, trend: 'up' },
      { symbol: 'ZTS', name: 'Zoetis Inc.', price: 168.34, changePercent: 0.89, trend: 'up' },
      { symbol: 'MRNA', name: 'Moderna Inc.', price: 42.45, changePercent: 4.56, trend: 'up' },
      { symbol: 'BIIB', name: 'Biogen Inc.', price: 158.34, changePercent: 1.23, trend: 'up' },
      
      // Consumer
      { symbol: 'WMT', name: 'Walmart Inc.', price: 92.18, changePercent: -0.32, trend: 'down' },
      { symbol: 'PG', name: 'Procter & Gamble Co.', price: 168.92, changePercent: 0.62, trend: 'up' },
      { symbol: 'KO', name: 'Coca-Cola Company', price: 62.45, changePercent: 0.34, trend: 'up' },
      { symbol: 'PEP', name: 'PepsiCo Inc.', price: 148.92, changePercent: 0.56, trend: 'up' },
      { symbol: 'COST', name: 'Costco Wholesale Corp', price: 978.34, changePercent: 1.23, trend: 'up' },
      { symbol: 'HD', name: 'Home Depot Inc.', price: 412.56, changePercent: 1.87, trend: 'up' },
      { symbol: 'MCD', name: 'McDonald\'s Corporation', price: 298.45, changePercent: 0.67, trend: 'up' },
      { symbol: 'NKE', name: 'Nike Inc.', price: 72.34, changePercent: -1.23, trend: 'down' },
      { symbol: 'SBUX', name: 'Starbucks Corporation', price: 112.45, changePercent: 0.89, trend: 'up' },
      { symbol: 'DIS', name: 'Walt Disney Company', price: 118.92, changePercent: 1.45, trend: 'up' },
      { symbol: 'NFLX', name: 'Netflix Inc.', price: 912.34, changePercent: 2.34, trend: 'up' },
      { symbol: 'CMCSA', name: 'Comcast Corporation', price: 42.45, changePercent: 0.56, trend: 'up' },
      { symbol: 'T', name: 'AT&T Inc.', price: 22.34, changePercent: 0.34, trend: 'up' },
      { symbol: 'VZ', name: 'Verizon Communications', price: 42.92, changePercent: 0.45, trend: 'up' },
      { symbol: 'TMUS', name: 'T-Mobile US Inc.', price: 248.34, changePercent: 0.78, trend: 'up' },
      { symbol: 'LOW', name: 'Lowe\'s Companies Inc.', price: 268.45, changePercent: 1.12, trend: 'up' },
      { symbol: 'TGT', name: 'Target Corporation', price: 128.92, changePercent: 0.67, trend: 'up' },
      { symbol: 'TJX', name: 'TJX Companies Inc.', price: 122.34, changePercent: 0.89, trend: 'up' },
      { symbol: 'BKNG', name: 'Booking Holdings Inc.', price: 5124.56, changePercent: 1.56, trend: 'up' },
      { symbol: 'MAR', name: 'Marriott International', price: 278.92, changePercent: 0.78, trend: 'up' },
      { symbol: 'HLT', name: 'Hilton Worldwide', price: 258.34, changePercent: 0.67, trend: 'up' },
      { symbol: 'ABNB', name: 'Airbnb Inc.', price: 142.45, changePercent: 2.34, trend: 'up' },
      { symbol: 'UBER', name: 'Uber Technologies', price: 68.92, changePercent: 1.89, trend: 'up' },
      { symbol: 'LYFT', name: 'Lyft Inc.', price: 14.56, changePercent: 2.45, trend: 'up' },
      { symbol: 'DASH', name: 'DoorDash Inc.', price: 178.34, changePercent: 3.12, trend: 'up' },
      { symbol: 'SPOT', name: 'Spotify Technology', price: 498.92, changePercent: 2.67, trend: 'up' },
      { symbol: 'ROKU', name: 'Roku Inc.', price: 82.34, changePercent: 3.45, trend: 'up' },
      { symbol: 'FUBO', name: 'fuboTV Inc.', price: 3.45, changePercent: 4.12, trend: 'up' },
      { symbol: 'GM', name: 'General Motors Co.', price: 52.45, changePercent: 1.23, trend: 'up' },
      { symbol: 'F', name: 'Ford Motor Company', price: 10.92, changePercent: 0.89, trend: 'up' },
      { symbol: 'RIVN', name: 'Rivian Automotive', price: 12.34, changePercent: 4.56, trend: 'up' },
      { symbol: 'LCID', name: 'Lucid Group Inc.', price: 2.45, changePercent: 3.78, trend: 'up' },
      { symbol: 'YUM', name: 'Yum! Brands Inc.', price: 138.92, changePercent: 0.56, trend: 'up' },
      { symbol: 'CMG', name: 'Chipotle Mexican Grill', price: 62.34, changePercent: 1.45, trend: 'up' },
      { symbol: 'DPZ', name: 'Domino\'s Pizza Inc.', price: 478.92, changePercent: 0.89, trend: 'up' },
      { symbol: 'LULU', name: 'Lululemon Athletica', price: 398.34, changePercent: 1.23, trend: 'up' },
      { symbol: 'ROST', name: 'Ross Stores Inc.', price: 158.92, changePercent: 0.67, trend: 'up' },
      { symbol: 'DG', name: 'Dollar General Corp', price: 78.34, changePercent: -0.89, trend: 'down' },
      { symbol: 'DLTR', name: 'Dollar Tree Inc.', price: 68.92, changePercent: -0.56, trend: 'down' },
      { symbol: 'EL', name: 'Est√©e Lauder Cos', price: 68.34, changePercent: 1.23, trend: 'up' },
      { symbol: 'CL', name: 'Colgate-Palmolive Co.', price: 98.92, changePercent: 0.45, trend: 'up' },
      { symbol: 'KMB', name: 'Kimberly-Clark Corp', price: 138.34, changePercent: 0.34, trend: 'up' },
      { symbol: 'GIS', name: 'General Mills Inc.', price: 62.92, changePercent: 0.23, trend: 'up' },
      { symbol: 'K', name: 'Kellanova', price: 82.34, changePercent: 0.56, trend: 'up' },
      { symbol: 'HSY', name: 'Hershey Company', price: 168.92, changePercent: 0.67, trend: 'up' },
      { symbol: 'MDLZ', name: 'Mondelez International', price: 68.34, changePercent: 0.45, trend: 'up' },
      { symbol: 'KHC', name: 'Kraft Heinz Company', price: 32.92, changePercent: 0.34, trend: 'up' },
      { symbol: 'STZ', name: 'Constellation Brands', price: 228.34, changePercent: 0.78, trend: 'up' },
      { symbol: 'TAP', name: 'Molson Coors Beverage', price: 58.92, changePercent: 0.45, trend: 'up' },
      { symbol: 'BUD', name: 'Anheuser-Busch InBev', price: 52.34, changePercent: 0.56, trend: 'up' },
      { symbol: 'DEO', name: 'Diageo plc', price: 118.92, changePercent: 0.34, trend: 'up' },
      { symbol: 'PM', name: 'Philip Morris Intl', price: 128.34, changePercent: 0.67, trend: 'up' },
      { symbol: 'MO', name: 'Altria Group Inc.', price: 52.92, changePercent: 0.45, trend: 'up' },
      
      // Industrials
      { symbol: 'CAT', name: 'Caterpillar Inc.', price: 398.34, changePercent: 1.23, trend: 'up' },
      { symbol: 'DE', name: 'Deere & Company', price: 478.92, changePercent: 0.89, trend: 'up' },
      { symbol: 'BA', name: 'Boeing Company', price: 178.34, changePercent: -2.34, trend: 'down' },
      { symbol: 'HON', name: 'Honeywell International', price: 228.92, changePercent: 0.67, trend: 'up' },
      { symbol: 'UNP', name: 'Union Pacific Corp', price: 248.34, changePercent: 0.56, trend: 'up' },
      { symbol: 'RTX', name: 'RTX Corporation', price: 128.92, changePercent: 0.78, trend: 'up' },
      { symbol: 'LMT', name: 'Lockheed Martin Corp', price: 512.34, changePercent: 0.45, trend: 'up' },
      { symbol: 'GE', name: 'GE Aerospace', price: 192.92, changePercent: 1.56, trend: 'up' },
      { symbol: 'MMM', name: '3M Company', price: 138.34, changePercent: 0.67, trend: 'up' },
      { symbol: 'UPS', name: 'United Parcel Service', price: 128.92, changePercent: 0.45, trend: 'up' },
      { symbol: 'FDX', name: 'FedEx Corporation', price: 278.34, changePercent: 0.89, trend: 'up' },
      { symbol: 'GD', name: 'General Dynamics Corp', price: 298.92, changePercent: 0.56, trend: 'up' },
      { symbol: 'NOC', name: 'Northrop Grumman Corp', price: 478.34, changePercent: 0.67, trend: 'up' },
      { symbol: 'WM', name: 'Waste Management Inc.', price: 228.92, changePercent: 0.78, trend: 'up' },
      { symbol: 'RSG', name: 'Republic Services Inc.', price: 218.34, changePercent: 0.56, trend: 'up' },
      { symbol: 'CSX', name: 'CSX Corporation', price: 38.92, changePercent: 0.45, trend: 'up' },
      { symbol: 'NSC', name: 'Norfolk Southern Corp', price: 268.34, changePercent: 0.67, trend: 'up' },
      { symbol: 'EMR', name: 'Emerson Electric Co.', price: 128.92, changePercent: 0.78, trend: 'up' },
      { symbol: 'ETN', name: 'Eaton Corporation plc', price: 348.34, changePercent: 1.23, trend: 'up' },
      { symbol: 'ITW', name: 'Illinois Tool Works', price: 268.92, changePercent: 0.56, trend: 'up' },
      { symbol: 'PH', name: 'Parker-Hannifin Corp', price: 678.34, changePercent: 0.89, trend: 'up' },
      { symbol: 'ROK', name: 'Rockwell Automation', price: 278.92, changePercent: 0.67, trend: 'up' },
      { symbol: 'CMI', name: 'Cummins Inc.', price: 368.34, changePercent: 0.78, trend: 'up' },
      { symbol: 'PCAR', name: 'PACCAR Inc.', price: 108.92, changePercent: 0.89, trend: 'up' },
      { symbol: 'DAL', name: 'Delta Air Lines Inc.', price: 62.34, changePercent: 1.45, trend: 'up' },
      { symbol: 'UAL', name: 'United Airlines Holdings', price: 108.92, changePercent: 1.67, trend: 'up' },
      { symbol: 'AAL', name: 'American Airlines Group', price: 18.34, changePercent: 2.34, trend: 'up' },
      { symbol: 'LUV', name: 'Southwest Airlines Co.', price: 38.92, changePercent: 1.23, trend: 'up' },
      
      // Energy
      { symbol: 'XOM', name: 'Exxon Mobil Corp', price: 108.34, changePercent: 0.78, trend: 'up' },
      { symbol: 'CVX', name: 'Chevron Corporation', price: 148.92, changePercent: 0.56, trend: 'up' },
      { symbol: 'COP', name: 'ConocoPhillips', price: 98.34, changePercent: 0.89, trend: 'up' },
      { symbol: 'SLB', name: 'Schlumberger Limited', price: 42.92, changePercent: 1.23, trend: 'up' },
      { symbol: 'EOG', name: 'EOG Resources Inc.', price: 128.34, changePercent: 0.67, trend: 'up' },
      { symbol: 'PXD', name: 'Pioneer Natural Resources', price: 228.92, changePercent: 0.78, trend: 'up' },
      { symbol: 'MPC', name: 'Marathon Petroleum', price: 158.34, changePercent: 0.89, trend: 'up' },
      { symbol: 'VLO', name: 'Valero Energy Corp', price: 138.92, changePercent: 0.67, trend: 'up' },
      { symbol: 'PSX', name: 'Phillips 66', price: 128.34, changePercent: 0.56, trend: 'up' },
      { symbol: 'OXY', name: 'Occidental Petroleum', price: 48.92, changePercent: 1.45, trend: 'up' },
      { symbol: 'HAL', name: 'Halliburton Company', price: 28.34, changePercent: 1.23, trend: 'up' },
      { symbol: 'BKR', name: 'Baker Hughes Company', price: 42.92, changePercent: 0.89, trend: 'up' },
      { symbol: 'DVN', name: 'Devon Energy Corp', price: 38.34, changePercent: 1.12, trend: 'up' },
      { symbol: 'FANG', name: 'Diamondback Energy', price: 178.92, changePercent: 0.78, trend: 'up' },
      { symbol: 'HES', name: 'Hess Corporation', price: 148.34, changePercent: 0.67, trend: 'up' },
      { symbol: 'KMI', name: 'Kinder Morgan Inc.', price: 28.92, changePercent: 0.45, trend: 'up' },
      { symbol: 'WMB', name: 'Williams Companies', price: 58.34, changePercent: 0.56, trend: 'up' },
      { symbol: 'OKE', name: 'ONEOK Inc.', price: 98.92, changePercent: 0.67, trend: 'up' },
      { symbol: 'ENPH', name: 'Enphase Energy Inc.', price: 68.34, changePercent: 3.45, trend: 'up' },
      { symbol: 'FSLR', name: 'First Solar Inc.', price: 198.92, changePercent: 2.34, trend: 'up' },
      
      // Utilities & Real Estate
      { symbol: 'NEE', name: 'NextEra Energy Inc.', price: 78.34, changePercent: 0.56, trend: 'up' },
      { symbol: 'DUK', name: 'Duke Energy Corp', price: 112.92, changePercent: 0.34, trend: 'up' },
      { symbol: 'SO', name: 'Southern Company', price: 88.34, changePercent: 0.45, trend: 'up' },
      { symbol: 'D', name: 'Dominion Energy Inc.', price: 58.92, changePercent: 0.34, trend: 'up' },
      { symbol: 'AEP', name: 'American Electric Power', price: 98.34, changePercent: 0.56, trend: 'up' },
      { symbol: 'SRE', name: 'Sempra Energy', price: 88.92, changePercent: 0.45, trend: 'up' },
      { symbol: 'XEL', name: 'Xcel Energy Inc.', price: 68.34, changePercent: 0.34, trend: 'up' },
      { symbol: 'EXC', name: 'Exelon Corporation', price: 42.92, changePercent: 0.45, trend: 'up' },
      { symbol: 'PEG', name: 'Public Service Enterprise', price: 88.34, changePercent: 0.56, trend: 'up' },
      { symbol: 'ED', name: 'Consolidated Edison', price: 98.92, changePercent: 0.34, trend: 'up' },
      { symbol: 'AWK', name: 'American Water Works', price: 128.34, changePercent: 0.45, trend: 'up' },
      { symbol: 'AMT', name: 'American Tower Corp', price: 198.92, changePercent: 0.67, trend: 'up' },
      { symbol: 'CCI', name: 'Crown Castle Inc.', price: 98.34, changePercent: 0.56, trend: 'up' },
      { symbol: 'PLD', name: 'Prologis Inc.', price: 118.92, changePercent: 0.78, trend: 'up' },
      { symbol: 'EQIX', name: 'Equinix Inc.', price: 978.34, changePercent: 0.89, trend: 'up' },
      { symbol: 'SPG', name: 'Simon Property Group', price: 168.92, changePercent: 0.67, trend: 'up' },
      { symbol: 'O', name: 'Realty Income Corp', price: 58.34, changePercent: 0.45, trend: 'up' },
      { symbol: 'WELL', name: 'Welltower Inc.', price: 138.92, changePercent: 0.56, trend: 'up' },
      { symbol: 'AVB', name: 'AvalonBay Communities', price: 228.34, changePercent: 0.67, trend: 'up' },
      { symbol: 'EQR', name: 'Equity Residential', price: 72.92, changePercent: 0.45, trend: 'up' },
      { symbol: 'DLR', name: 'Digital Realty Trust', price: 178.34, changePercent: 0.89, trend: 'up' },
      { symbol: 'PSA', name: 'Public Storage', price: 338.92, changePercent: 0.56, trend: 'up' },
      { symbol: 'VICI', name: 'VICI Properties Inc.', price: 32.34, changePercent: 0.67, trend: 'up' },
      
      // Materials
      { symbol: 'LIN', name: 'Linde plc', price: 458.34, changePercent: 0.78, trend: 'up' },
      { symbol: 'APD', name: 'Air Products & Chemicals', price: 298.92, changePercent: 0.56, trend: 'up' },
      { symbol: 'SHW', name: 'Sherwin-Williams Co.', price: 348.34, changePercent: 0.89, trend: 'up' },
      { symbol: 'ECL', name: 'Ecolab Inc.', price: 248.92, changePercent: 0.67, trend: 'up' },
      { symbol: 'FCX', name: 'Freeport-McMoRan Inc.', price: 42.34, changePercent: 2.34, trend: 'up' },
      { symbol: 'NEM', name: 'Newmont Corporation', price: 42.92, changePercent: 1.56, trend: 'up' },
      { symbol: 'NUE', name: 'Nucor Corporation', price: 148.34, changePercent: 1.23, trend: 'up' },
      { symbol: 'STLD', name: 'Steel Dynamics Inc.', price: 128.92, changePercent: 1.45, trend: 'up' },
      { symbol: 'DOW', name: 'Dow Inc.', price: 48.34, changePercent: 0.89, trend: 'up' },
      { symbol: 'DD', name: 'DuPont de Nemours', price: 78.92, changePercent: 0.67, trend: 'up' },
      { symbol: 'PPG', name: 'PPG Industries Inc.', price: 128.34, changePercent: 0.56, trend: 'up' },
      { symbol: 'VMC', name: 'Vulcan Materials Co.', price: 278.92, changePercent: 0.78, trend: 'up' },
      { symbol: 'MLM', name: 'Martin Marietta Materials', price: 598.34, changePercent: 0.89, trend: 'up' },
      { symbol: 'GOLD', name: 'Barrick Gold Corp', price: 18.92, changePercent: 1.67, trend: 'up' },
      { symbol: 'AEM', name: 'Agnico Eagle Mines', price: 88.34, changePercent: 1.45, trend: 'up' },
      
      // Other Notable
      { symbol: 'BRK.B', name: 'Berkshire Hathaway B', price: 478.34, changePercent: 0.56, trend: 'up' },
      { symbol: 'SPY', name: 'SPDR S&P 500 ETF', price: 608.92, changePercent: 0.78, trend: 'up' },
      { symbol: 'QQQ', name: 'Invesco QQQ Trust', price: 528.34, changePercent: 1.23, trend: 'up' },
      { symbol: 'IWM', name: 'iShares Russell 2000', price: 228.92, changePercent: 0.89, trend: 'up' },
      { symbol: 'DIA', name: 'SPDR Dow Jones ETF', price: 438.34, changePercent: 0.45, trend: 'up' },
      { symbol: 'VTI', name: 'Vanguard Total Stock', price: 298.92, changePercent: 0.67, trend: 'up' },
      { symbol: 'VOO', name: 'Vanguard S&P 500 ETF', price: 558.34, changePercent: 0.78, trend: 'up' },
      { symbol: 'ARKK', name: 'ARK Innovation ETF', price: 58.92, changePercent: 2.34, trend: 'up' },
      { symbol: 'XLF', name: 'Financial Select SPDR', price: 48.34, changePercent: 0.89, trend: 'up' },
      { symbol: 'XLE', name: 'Energy Select SPDR', price: 88.92, changePercent: 0.67, trend: 'up' },
      { symbol: 'XLK', name: 'Technology Select SPDR', price: 238.34, changePercent: 1.12, trend: 'up' },
      { symbol: 'XLV', name: 'Health Care Select SPDR', price: 148.92, changePercent: 0.56, trend: 'up' },
      { symbol: 'PLTR', name: 'Palantir Technologies', price: 78.34, changePercent: 4.56, trend: 'up' },
      { symbol: 'SNOW', name: 'Snowflake Inc.', price: 178.92, changePercent: 2.34, trend: 'up' },
      { symbol: 'DDOG', name: 'Datadog Inc.', price: 138.34, changePercent: 1.89, trend: 'up' },
      { symbol: 'NET', name: 'Cloudflare Inc.', price: 118.92, changePercent: 2.45, trend: 'up' },
      { symbol: 'CRWD', name: 'CrowdStrike Holdings', price: 358.34, changePercent: 1.67, trend: 'up' },
      { symbol: 'ZS', name: 'Zscaler Inc.', price: 198.92, changePercent: 1.45, trend: 'up' },
      { symbol: 'PANW', name: 'Palo Alto Networks', price: 188.34, changePercent: 1.23, trend: 'up' },
      { symbol: 'FTNT', name: 'Fortinet Inc.', price: 98.92, changePercent: 1.56, trend: 'up' },
      { symbol: 'WDAY', name: 'Workday Inc.', price: 268.34, changePercent: 0.89, trend: 'up' },
      { symbol: 'VEEV', name: 'Veeva Systems Inc.', price: 218.92, changePercent: 0.78, trend: 'up' },
      { symbol: 'TTD', name: 'Trade Desk Inc.', price: 128.34, changePercent: 2.12, trend: 'up' },
      { symbol: 'TEAM', name: 'Atlassian Corporation', price: 258.92, changePercent: 1.34, trend: 'up' },
      { symbol: 'SHOP', name: 'Shopify Inc.', price: 112.34, changePercent: 2.67, trend: 'up' },
      { symbol: 'SQ', name: 'Block Inc.', price: 92.45, changePercent: 3.12, trend: 'up' },
      { symbol: 'MELI', name: 'MercadoLibre Inc.', price: 2078.34, changePercent: 1.89, trend: 'up' },
      { symbol: 'SE', name: 'Sea Limited', price: 118.92, changePercent: 3.45, trend: 'up' },
      { symbol: 'ZM', name: 'Zoom Video Comms', price: 78.34, changePercent: 1.23, trend: 'up' },
      { symbol: 'DOCU', name: 'DocuSign Inc.', price: 88.92, changePercent: 1.56, trend: 'up' },
      { symbol: 'OKTA', name: 'Okta Inc.', price: 98.34, changePercent: 1.78, trend: 'up' },
      { symbol: 'MDB', name: 'MongoDB Inc.', price: 268.92, changePercent: 2.34, trend: 'up' },
      { symbol: 'TWLO', name: 'Twilio Inc.', price: 118.34, changePercent: 2.12, trend: 'up' },
      { symbol: 'U', name: 'Unity Software Inc.', price: 28.92, changePercent: 3.56, trend: 'up' },
      { symbol: 'RBLX', name: 'Roblox Corporation', price: 58.34, changePercent: 4.23, trend: 'up' },
      { symbol: 'SNAP', name: 'Snap Inc.', price: 12.92, changePercent: 2.89, trend: 'up' },
      { symbol: 'PINS', name: 'Pinterest Inc.', price: 38.34, changePercent: 1.67, trend: 'up' },
      { symbol: 'ETSY', name: 'Etsy Inc.', price: 58.92, changePercent: 1.45, trend: 'up' },
      { symbol: 'W', name: 'Wayfair Inc.', price: 48.34, changePercent: 2.34, trend: 'up' },
      { symbol: 'CHWY', name: 'Chewy Inc.', price: 32.92, changePercent: 1.89, trend: 'up' },
      { symbol: 'PATH', name: 'UiPath Inc.', price: 14.34, changePercent: 2.12, trend: 'up' },
      { symbol: 'AI', name: 'C3.ai Inc.', price: 38.92, changePercent: 4.56, trend: 'up' },
      { symbol: 'SMCI', name: 'Super Micro Computer', price: 38.34, changePercent: 5.67, trend: 'up' },
      { symbol: 'ARM', name: 'Arm Holdings plc', price: 168.92, changePercent: 3.45, trend: 'up' },
      { symbol: 'IONQ', name: 'IonQ Inc.', price: 48.34, changePercent: 6.78, trend: 'up' },
      { symbol: 'RGTI', name: 'Rigetti Computing', price: 18.92, changePercent: 8.45, trend: 'up' },
    ];

    let watchlist = [];
    let positions = {};
    let currentEditSymbol = null;
    let priceCache = {};
    let lastPriceUpdate = 0;
    const PRICE_CACHE_DURATION = 60000; // 1 minute cache
    let currentUserEmail = null;
    
    // Load user data from server
    async function loadUserData() {
      const urlParams = new URLSearchParams(window.location.search);
      const email = urlParams.get('email') || localStorage.getItem('userEmail');
      
      if (!email) {
        console.log('No email found, using localStorage');
        watchlist = JSON.parse(localStorage.getItem('watchlist')) || [];
        positions = JSON.parse(localStorage.getItem('positions')) || {};
        return;
      }
      
      currentUserEmail = email;
      console.log('Loading user data for:', email);
      
      try {
        const response = await fetch('/api/user-data/' + encodeURIComponent(email));
        const data = await response.json();
        
        if (data.success) {
          watchlist = data.watchlist || [];
          positions = data.positions || {};
          console.log('Loaded from server - Watchlist:', watchlist.length, 'Positions:', Object.keys(positions).length);
        }
      } catch (err) {
        console.error('Failed to load user data:', err);
        // Fallback to localStorage
        watchlist = JSON.parse(localStorage.getItem('watchlist')) || [];
        positions = JSON.parse(localStorage.getItem('positions')) || {};
      }
      
      // Mark prices as needing update
      watchlist.forEach(stock => {
        stock.needsUpdate = true;
      });
      
      // Re-render with loaded data
      renderWatchlist();
    }
    
    // Save user data to server
    async function saveUserData() {
      if (!currentUserEmail) {
        // No logged in user, just save to localStorage
        DataSync.saveBoth(watchlist, positions);
        return;
      }
      
      try {
        await fetch('/api/user-data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: currentUserEmail,
            watchlist: watchlist,
            positions: positions
          })
        });
        console.log('User data saved to server');
      } catch (err) {
        console.error('Failed to save user data:', err);
      }
      
      // Also save to localStorage as backup
      DataSync.saveBoth(watchlist, positions);
    }

    // ============================================
    // FINNHUB API SERVICE
    // ============================================
    const FINNHUB_API_KEY = 'd5c3ijpr01qsbmgib7u0d5c3ijpr01qsbmgib7ug';
    const FINNHUB_BASE_URL = 'https://finnhub.io/api/v1';
    
    const StockAPI = {
      async getQuote(symbol) {
        try {
          const url = `${FINNHUB_BASE_URL}/quote?symbol=${symbol}&token=${FINNHUB_API_KEY}`;
          const response = await fetch(url);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const data = await response.json();
          
          // Finnhub returns c=0, h=0 for invalid symbols
          if (data.c === 0 && data.h === 0) return null;
          
          return {
            symbol: symbol,
            price: data.c,           // Current price
            change: data.d,          // Change
            changePercent: data.dp,  // Change percent
            previousClose: data.pc,  // Previous close
            high: data.h,
            low: data.l,
            open: data.o,
            trend: data.dp >= 0 ? 'up' : 'down'
          };
        } catch (error) {
          console.error(`Error fetching ${symbol}:`, error);
          return null;
        }
      },
      
      async getMultipleQuotes(symbols) {
        // Finnhub requires individual requests, so we batch with delays
        const results = [];
        for (let i = 0; i < symbols.length; i++) {
          // Add small delay between requests to avoid rate limiting
          if (i > 0) await new Promise(r => setTimeout(r, 100));
          try {
            const quote = await this.getQuote(symbols[i]);
            if (quote) results.push(quote);
          } catch (error) {
            console.error(`Error fetching ${symbols[i]}:`, error);
          }
        }
        return results;
      },
      
      async search(query) {
        try {
          const url = `${FINNHUB_BASE_URL}/search?q=${encodeURIComponent(query)}&token=${FINNHUB_API_KEY}`;
          const response = await fetch(url);
          const data = await response.json();
          
          if (data.result && data.result.length > 0) {
            return data.result
              .filter(r => r.type === 'Common Stock' && !r.symbol.includes('.'))
              .slice(0, 10)
              .map(r => ({
                symbol: r.symbol,
                name: r.description
              }));
          }
          return [];
        } catch (error) {
          console.error('Search error:', error);
          return [];
        }
      }
    };

    // ============================================
    // UPDATE INDICES WITH REAL DATA
    // ============================================
    async function updateIndices() {
      // Use ETFs instead of index symbols (Finnhub doesn't support ^GSPC etc)
      const indexSymbols = ['SPY', 'DIA', 'QQQ', 'IWM', 'UVXY'];
      const indexNames = ['SPY', 'DIA', 'QQQ', 'IWM', 'VIX'];
      
      try {
        const quotes = await StockAPI.getMultipleQuotes(indexSymbols);
        const indicesScroll = document.querySelector('.indices-scroll');
        
        if (quotes.length > 0 && indicesScroll) {
          indicesScroll.innerHTML = quotes.map((q, i) => {
            const isUp = q.changePercent >= 0;
            const displayValue = q.price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            const changeStr = (isUp ? '+' : '') + q.changePercent.toFixed(2) + '%';
            
            return `
              <div class="index-item">
                <div class="index-name">${indexNames[i] || q.symbol}</div>
                <div class="index-value">${displayValue}</div>
                <div class="index-change ${isUp ? 'up' : 'down'}">${changeStr}</div>
              </div>
            `;
          }).join('');
        }
      } catch (error) {
        console.error('Error updating indices:', error);
      }
    }

    // ============================================
    // UPDATE WATCHLIST WITH REAL PRICES
    // ============================================
    async function updateWatchlistPrices(force = false) {
      if (watchlist.length === 0) return;
      
      const now = Date.now();
      if (!force && now - lastPriceUpdate < PRICE_CACHE_DURATION) return;
      
      const symbols = watchlist.map(s => s.symbol);
      console.log('Fetching prices for:', symbols);
      
      try {
        const quotes = await StockAPI.getMultipleQuotes(symbols);
        console.log('Received quotes:', quotes);
        
        if (quotes.length === 0) {
          console.warn('No quotes received from API');
          return;
        }
        
        quotes.forEach(q => {
          if (q.price > 0) {
            priceCache[q.symbol] = {
              price: q.price,
              changePercent: q.changePercent,
              trend: q.trend,
              timestamp: now
            };
            
            // Update watchlist item
            const idx = watchlist.findIndex(s => s.symbol === q.symbol);
            if (idx !== -1) {
              watchlist[idx].price = q.price;
              watchlist[idx].changePercent = q.changePercent;
              watchlist[idx].trend = q.trend;
            }
          }
        });
        
        lastPriceUpdate = now;
        saveUserData();
        renderWatchlist();
        console.log('Watchlist updated with live prices');
      } catch (error) {
        console.error('Error updating watchlist prices:', error);
      }
    }

    // ============================================
    // UPDATE STOCK DATABASE WITH REAL PRICES (for search)
    // ============================================
    async function updateSearchResultPrices(symbols) {
      if (symbols.length === 0) return;
      
      try {
        const quotes = await StockAPI.getMultipleQuotes(symbols);
        
        quotes.forEach(q => {
          const idx = stockDatabase.findIndex(s => s.symbol === q.symbol);
          if (idx !== -1) {
            stockDatabase[idx].price = q.price;
            stockDatabase[idx].changePercent = q.changePercent;
            stockDatabase[idx].trend = q.trend;
          }
        });
      } catch (error) {
        console.error('Error updating search prices:', error);
      }
    }

    // ============================================
    // MODAL FUNCTIONS
    // ============================================
    function openModal(symbol) {
      const stock = watchlist.find(s => s.symbol === symbol) || stockDatabase.find(s => s.symbol === symbol);
      if (!stock) return;
      
      currentEditSymbol = symbol;
      const position = positions[symbol] || { shares: 0, avgCost: 0, history: [], firstPurchase: null };
      const isUp = stock.changePercent >= 0;
      
      document.getElementById('modal-symbol').textContent = stock.symbol;
      document.getElementById('modal-name').textContent = stock.name;
      document.getElementById('modal-price').textContent = '$' + stock.price.toFixed(2);
      
      const changeEl = document.getElementById('modal-change');
      changeEl.textContent = (isUp ? '+' : '') + stock.changePercent.toFixed(2) + '%';
      changeEl.className = 'modal-price-change ' + (isUp ? 'up' : 'down');
      
      // Show current total shares, clear all input fields
      document.getElementById('modal-total-shares').textContent = position.shares || 0;
      document.getElementById('modal-add-shares').value = '';
      document.getElementById('modal-shares').value = '';
      document.getElementById('modal-cost').value = '';
      document.getElementById('modal-price-sold').value = '';
      document.getElementById('modal-avg-cost').textContent = '$' + (position.avgCost || 0).toFixed(2);
      
      // Set default purchase date to today
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('modal-purchase-date').value = today;
      
      // Show first purchase date if exists
      const firstPurchaseEl = document.getElementById('modal-first-purchase');
      if (position.firstPurchase) {
        const fpDate = new Date(position.firstPurchase);
        firstPurchaseEl.textContent = fpDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      } else {
        firstPurchaseEl.textContent = '--';
      }
      
      updateModalCalculations();
      
      document.getElementById('stock-modal').classList.add('visible');
    }

    function closeModal() {
      document.getElementById('stock-modal').classList.remove('visible');
      currentEditSymbol = null;
    }

    function updateModalCalculations() {
      const existingShares = parseFloat(document.getElementById('modal-total-shares').textContent) || 0;
      const addShares = parseFloat(document.getElementById('modal-add-shares').value) || 0;
      const removeShares = parseFloat(document.getElementById('modal-shares').value) || 0;
      const pricePaid = parseFloat(document.getElementById('modal-cost').value) || 0;
      const priceSold = parseFloat(document.getElementById('modal-price-sold').value) || 0;
      const stock = watchlist.find(s => s.symbol === currentEditSymbol) || stockDatabase.find(s => s.symbol === currentEditSymbol);
      const existing = positions[currentEditSymbol] || { shares: 0, avgCost: 0 };
      
      if (!stock) return;
      
      // Calculate net shares after adding and removing
      const netShareChange = addShares - removeShares;
      const totalShares = existingShares + netShareChange;
      
      // Calculate total cost (add) and sale proceeds (remove)
      const addCostValue = (addShares * pricePaid);
      const removeSaleValue = (removeShares * priceSold);
      const totalCostValue = (existing.shares * existing.avgCost) + addCostValue - removeSaleValue;
      const newAvgCost = totalShares > 0 ? totalCostValue / totalShares : existing.avgCost;
      const marketValue = Math.max(0, totalShares) * stock.price;
      const totalReturn = marketValue - totalCostValue;
      const isGain = totalReturn >= 0;
      
      // Update avg cost display
      document.getElementById('modal-avg-cost').textContent = '$' + newAvgCost.toFixed(2);
      
      document.getElementById('modal-market-value').textContent = '$' + marketValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      document.getElementById('modal-total-cost').textContent = '$' + totalCostValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      
      const returnEl = document.getElementById('modal-return');
      returnEl.textContent = (isGain ? '+' : '') + '$' + totalReturn.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      returnEl.className = 'summary-value ' + (isGain ? 'gain' : 'loss');
    }

    function savePosition() {
      const existingShares = parseFloat(document.getElementById('modal-total-shares').textContent) || 0;
      const addShares = parseFloat(document.getElementById('modal-add-shares').value) || 0;
      const removeShares = parseFloat(document.getElementById('modal-shares').value) || 0;
      const pricePaid = parseFloat(document.getElementById('modal-cost').value) || 0;
      const priceSold = parseFloat(document.getElementById('modal-price-sold').value) || 0;
      const purchaseDate = document.getElementById('modal-purchase-date').value || new Date().toISOString().split('T')[0];
      const existing = positions[currentEditSymbol] || { shares: 0, avgCost: 0, history: [] };
      
      // Calculate total shares after both add and remove operations
      const totalShares = existingShares + addShares - removeShares;
      
      if (totalShares < 0) {
        showToast(`Can't remove ${removeShares} shares - only have ${existingShares}`, 'removed');
        return;
      }
      
      // Calculate new average cost
      let newAvgCost = existing.avgCost;
      if (totalShares > 0) {
        // Start with existing cost basis
        let totalCostBasis = existing.shares * existing.avgCost;
        
        // Add new purchases
        if (addShares > 0) {
          totalCostBasis += (addShares * pricePaid);
        }
        
        // Subtract sale proceeds
        if (removeShares > 0) {
          totalCostBasis -= (removeShares * priceSold);
        }
        
        newAvgCost = totalCostBasis / totalShares;
      }
      
      if (totalShares <= 0) {
        delete positions[currentEditSymbol];
        showToast(`Cleared all shares of ${currentEditSymbol}`, 'success');
      } else {
        // Initialize history array if it doesn't exist
        const history = existing.history || [];
        
        // Add new purchase to history if adding shares
        if (addShares > 0) {
          history.push({
            date: purchaseDate,
            shares: addShares,
            price: pricePaid,
            type: 'buy'
          });
        }
        
        // Add sale to history if removing shares
        if (removeShares > 0) {
          history.push({
            date: purchaseDate,
            shares: removeShares,
            price: priceSold,
            type: 'sell'
          });
        }
        
        positions[currentEditSymbol] = { 
          shares: totalShares, 
          avgCost: newAvgCost,
          history: history,
          firstPurchase: existing.firstPurchase || purchaseDate
        };
        
        // Trigger confetti if adding shares
        if (addShares > 0) {
          triggerConfetti();
        }
        
        showToast('Position saved', 'success');
      }
      
      saveUserData();
      closeModal();
      renderWatchlist();
    }

    // Confetti celebration function (Robinhood-style)
    function triggerConfetti() {
      const container = document.createElement('div');
      container.className = 'confetti-container';
      document.body.appendChild(container);

      const colors = ['#a855f7', '#00d775', '#ff4757', '#ffd700', '#00bfff', '#ff69b4', '#7c3aed'];
      const shapes = ['square', 'circle', 'strip'];
      const confettiCount = 150;

      for (let i = 0; i < confettiCount; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti ' + shapes[Math.floor(Math.random() * shapes.length)];
        
        // Random properties
        const left = Math.random() * 100;
        const delay = Math.random() * 0.5;
        const duration = 2 + Math.random() * 2;
        const size = 6 + Math.random() * 8;
        const color = colors[Math.floor(Math.random() * colors.length)];
        
        confetti.style.left = left + '%';
        confetti.style.backgroundColor = color;
        confetti.style.width = size + 'px';
        confetti.style.height = size + 'px';
        confetti.style.animationDelay = delay + 's';
        confetti.style.animationDuration = duration + 's';
        
        container.appendChild(confetti);
      }

      // Remove container after animation completes
      setTimeout(() => {
        container.remove();
      }, 4500);
    }

    // Add to existing position (averages cost)
    // Modal input listeners
    document.getElementById('modal-add-shares').addEventListener('input', updateModalCalculations);
    document.getElementById('modal-shares').addEventListener('input', updateModalCalculations);
    document.getElementById('modal-cost').addEventListener('input', updateModalCalculations);
    document.getElementById('modal-price-sold').addEventListener('input', updateModalCalculations);

    // Close modal on overlay click
    document.getElementById('stock-modal').addEventListener('click', (e) => {
      if (e.target.id === 'stock-modal') {
        closeModal();
      }
    });

    // ============================================
    // SPARKLINE GENERATOR - Real Yahoo Finance Data
    // ============================================
    
    // Cache for sparkline data to avoid excessive API calls
    const sparklineCache = new Map();
    const SPARKLINE_CACHE_TTL = 60000; // 1 minute cache
    
    async function fetchSparklineData(symbol) {
      const cacheKey = symbol.toUpperCase();
      const cached = sparklineCache.get(cacheKey);
      
      if (cached && Date.now() - cached.timestamp < SPARKLINE_CACHE_TTL) {
        return cached.prices;
      }
      
      try {
        const response = await fetch(`/api/sparkline/${encodeURIComponent(symbol)}`);
        const data = await response.json();
        
        if (data.prices && data.prices.length > 0) {
          sparklineCache.set(cacheKey, { prices: data.prices, timestamp: Date.now() });
          return data.prices;
        }
      } catch (error) {
        console.error(`Sparkline fetch error for ${symbol}:`, error);
      }
      
      return null;
    }
    
    function generateSparklineFromPrices(prices, width = 80, height = 30) {
      if (!prices || prices.length < 2) {
        return generateFallbackSparkline('up', width, height);
      }
      
      const firstPrice = prices[0];
      const lastPrice = prices[prices.length - 1];
      const trend = lastPrice >= firstPrice ? 'up' : 'down';
      
      const minPrice = Math.min(...prices);
      const maxPrice = Math.max(...prices);
      const range = maxPrice - minPrice || 1;
      
      // Normalize prices to fit in the SVG viewport
      const padding = 3;
      const effectiveHeight = height - padding * 2;
      const points = prices.map((price, i) => ({
        x: (i / (prices.length - 1)) * width,
        y: padding + effectiveHeight - ((price - minPrice) / range) * effectiveHeight
      }));
      
      const pathData = points.map((p, i) => (i === 0 ? `M ${p.x.toFixed(2)},${p.y.toFixed(2)}` : `L ${p.x.toFixed(2)},${p.y.toFixed(2)}`)).join(' ');
      const upColor = getComputedStyle(document.documentElement).getPropertyValue('--color-up').trim() || '#00d775';
      const downColor = getComputedStyle(document.documentElement).getPropertyValue('--color-down').trim() || '#ff4757';
      const color = trend === 'up' ? upColor : downColor;
      const gradientId = `grad-${trend}-${Math.random().toString(36).substr(2, 9)}`;
      
      return `
        <svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">
          <defs>
            <linearGradient id="${gradientId}" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" style="stop-color:${color};stop-opacity:0.3" />
              <stop offset="100%" style="stop-color:${color};stop-opacity:0" />
            </linearGradient>
          </defs>
          <path d="${pathData} L ${width},${height} L 0,${height} Z" fill="url(#${gradientId})" opacity="0.5"/>
          <path d="${pathData}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          <circle cx="${points[points.length-1].x.toFixed(2)}" cy="${points[points.length-1].y.toFixed(2)}" r="2.5" fill="${color}"/>
        </svg>
      `;
    }
    
    function generateFallbackSparkline(trend, width = 80, height = 30) {
      const upColor = getComputedStyle(document.documentElement).getPropertyValue('--color-up').trim() || '#00d775';
      const downColor = getComputedStyle(document.documentElement).getPropertyValue('--color-down').trim() || '#ff4757';
      const color = trend === 'up' ? upColor : downColor;
      
      // Simple flat line as fallback
      return `
        <svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">
          <line x1="0" y1="${height/2}" x2="${width}" y2="${height/2}" stroke="${color}" stroke-width="1.5" stroke-dasharray="2,2" opacity="0.4"/>
        </svg>
      `;
    }
    
    // Legacy function for backwards compatibility
    function generateSparkline(trend, width = 80, height = 30) {
      return generateFallbackSparkline(trend, width, height);
    }

    // ============================================
    // FUTURES DATA (Yahoo Finance Style)
    // ============================================
    const futuresSymbols = {
      'es': 'ES=F',   // S&P 500 Futures
      'ym': 'YM=F',   // Dow Futures
      'nq': 'NQ=F',   // Nasdaq Futures
      'rty': 'RTY=F'  // Russell 2000 Futures
    };
    
    const etfSymbols = {
      'es': 'SPY',    // S&P 500 ETF
      'ym': 'DIA',    // Dow ETF
      'nq': 'QQQ',    // Nasdaq ETF
      'rty': 'IWM'    // Russell 2000 ETF
    };
    
    const futuresNames = {
      'es': 'S&P Futures',
      'ym': 'Dow Futures',
      'nq': 'Nasdaq Futures',
      'rty': 'Russell 2000'
    };
    
    const etfNames = {
      'es': 'SPY',
      'ym': 'DIA',
      'nq': 'QQQ',
      'rty': 'IWM'
    };
    
    function isMarketOpen() {
      const now = new Date();
      const day = now.getDay();
      const hours = now.getHours();
      const minutes = now.getMinutes();
      const currentMinutes = hours * 60 + minutes;
      
      const marketOpen = 9 * 60 + 30;  // 9:30 AM
      const marketClose = 16 * 60;      // 4:00 PM
      
      // Weekends
      if (day === 0 || day === 6) return false;
      
      // Check if within market hours
      return currentMinutes >= marketOpen && currentMinutes < marketClose;
    }

    let futuresData = {};

    async function fetchFuturesData() {
      // Always use ETF symbols and fetch from Alpaca API for live data
      const symbols = etfSymbols;
      const names = etfNames;
      
      // Update the card names
      for (const key of Object.keys(names)) {
        const nameEl = document.getElementById(`name-${key}`);
        if (nameEl) nameEl.textContent = names[key];
      }
      
      // Fetch all ETF snapshots from Alpaca in one call
      const etfList = Object.values(symbols).join(',');
      try {
        const response = await fetch(`/api/market/snapshots?symbols=${etfList}`);
        const data = await response.json();
        
        if (data.success && data.snapshots) {
          for (const [key, etfSymbol] of Object.entries(symbols)) {
            const snapshot = data.snapshots[etfSymbol];
            if (snapshot) {
              const price = snapshot.price;
              const changePercent = parseFloat(snapshot.changePercent);
              const change = parseFloat(snapshot.change);
              
              futuresData[key] = {
                price: price,
                change: change,
                changePercent: changePercent,
                chartData: generateRandomChartData(changePercent >= 0)
              };
              
              updateFuturesCard(key);
            } else {
              setFallbackFuturesData(key);
            }
          }
        } else {
          // Fallback if API fails
          for (const key of Object.keys(symbols)) {
            setFallbackFuturesData(key);
          }
        }
      } catch (error) {
        console.log('Error fetching futures data from Alpaca:', error);
        // Use fallback data for all
        for (const key of Object.keys(symbols)) {
          setFallbackFuturesData(key);
        }
      }
    }

    function setFallbackFuturesData(key) {
      const fallbackData = {
        'es': { price: 5990.25, change: 21.75, changePercent: 0.36 },
        'ym': { price: 43420.00, change: 125.00, changePercent: 0.29 },
        'nq': { price: 21250.50, change: 95.25, changePercent: 0.45 },
        'rty': { price: 2015.40, change: 8.60, changePercent: 0.43 }
      };
      
      futuresData[key] = {
        ...fallbackData[key],
        chartData: generateRandomChartData(fallbackData[key].changePercent > 0)
      };
      
      updateFuturesCard(key);
    }

    function generateRandomChartData(isUp) {
      const data = [];
      let value = 100;
      for (let i = 0; i < 20; i++) {
        value += (Math.random() - (isUp ? 0.3 : 0.7)) * 2;
        data.push(value);
      }
      return data;
    }

    function updateFuturesCard(key) {
      const data = futuresData[key];
      if (!data) return;
      
      const priceEl = document.getElementById(`price-${key}`);
      const changeEl = document.getElementById(`change-${key}`);
      const chartEl = document.getElementById(`chart-${key}`);
      
      if (priceEl) {
        priceEl.textContent = data.price.toLocaleString('en-US', { 
          minimumFractionDigits: 2, 
          maximumFractionDigits: 2 
        });
      }
      
      if (changeEl) {
        const sign = data.changePercent >= 0 ? '+' : '';
        changeEl.textContent = `${sign}${data.changePercent.toFixed(2)}%`;
        changeEl.className = `futures-change ${data.changePercent >= 0 ? 'up' : 'down'}`;
      }
      
      if (chartEl && data.chartData) {
        chartEl.innerHTML = generateFuturesMiniChart(data.chartData, data.changePercent >= 0);
      }
    }

    function generateFuturesMiniChart(data, isUp) {
      const width = 100;
      const height = 30;
      const upColor = getComputedStyle(document.documentElement).getPropertyValue('--color-up').trim() || '#00d775';
      const downColor = getComputedStyle(document.documentElement).getPropertyValue('--color-down').trim() || '#ff4757';
      const color = isUp ? upColor : downColor;
      
      const min = Math.min(...data);
      const max = Math.max(...data);
      const range = max - min || 1;
      
      const points = data.map((val, i) => ({
        x: (i / (data.length - 1)) * width,
        y: height - ((val - min) / range) * (height - 4) - 2
      }));
      
      const pathData = points.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x.toFixed(1)},${p.y.toFixed(1)}`).join(' ');
      const midY = height / 2;
      
      return `
        <svg viewBox="0 0 ${width} ${height}" preserveAspectRatio="none">
          <line x1="0" y1="${midY}" x2="${width}" y2="${midY}" class="zero-line"/>
          <path d="${pathData}" class="chart-line ${isUp ? 'up' : 'down'}"/>
        </svg>
      `;
    }

    function updateMarketHeader() {
      const now = new Date();
      const day = now.getDay();
      const hours = now.getHours();
      const minutes = now.getMinutes();
      const currentMinutes = hours * 60 + minutes;
      
      const marketOpen = 9 * 60 + 30;  // 9:30 AM
      const marketClose = 16 * 60;      // 4:00 PM
      const premarketOpen = 4 * 60;     // 4:00 AM
      
      const headerIcon = document.getElementById('marketIcon');
      const headerText = document.getElementById('marketHeaderText');
      
      if (!headerIcon || !headerText) return;
      
      // Weekend
      if (day === 0 || day === 6) {
        const daysUntilMonday = day === 0 ? 1 : 2;
        const targetTime = new Date(now);
        targetTime.setDate(targetTime.getDate() + daysUntilMonday);
        targetTime.setHours(9, 30, 0, 0);
        const diff = targetTime - now;
        const hoursLeft = Math.floor(diff / (1000 * 60 * 60));
        const minsLeft = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        
        headerIcon.textContent = 'üåô';
        headerText.textContent = `U.S. MARKETS OPEN IN ${hoursLeft} HR ${minsLeft} MIN`;
        return;
      }
      
      // Market hours
      if (currentMinutes >= marketOpen && currentMinutes < marketClose) {
        headerIcon.textContent = '‚òÄÔ∏è';
        headerText.textContent = 'U.S. MARKETS ARE OPEN';
      } else if (currentMinutes >= premarketOpen && currentMinutes < marketOpen) {
        // Premarket
        const openTime = new Date(now);
        openTime.setHours(9, 30, 0, 0);
        const diff = openTime - now;
        const hoursLeft = Math.floor(diff / (1000 * 60 * 60));
        const minsLeft = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        
        headerIcon.textContent = 'üåÖ';
        headerText.textContent = `U.S. MARKETS OPEN IN ${hoursLeft} HR ${minsLeft} MIN`;
      } else {
        // After hours or before premarket
        const openTime = new Date(now);
        if (currentMinutes >= marketClose) {
          openTime.setDate(openTime.getDate() + 1);
        }
        openTime.setHours(9, 30, 0, 0);
        
        while (openTime.getDay() === 0 || openTime.getDay() === 6) {
          openTime.setDate(openTime.getDate() + 1);
        }
        
        const diff = openTime - now;
        const hoursLeft = Math.floor(diff / (1000 * 60 * 60));
        const minsLeft = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        
        headerIcon.textContent = 'üåô';
        headerText.textContent = `U.S. MARKETS OPEN IN ${hoursLeft} HR ${minsLeft} MIN`;
      }
    }

    // Initialize futures
    fetchFuturesData();
    updateMarketHeader();
    
    // Refresh futures every 30 seconds
    setInterval(fetchFuturesData, 30000);
    setInterval(updateMarketHeader, 60000);

    // ============================================
    // COUNTDOWN TIMER
    // ============================================
    function updateCountdown() {
      const now = new Date();
      updateMarketCountdown(now);
    }

    function updateMarketCountdown(now) {
      const day = now.getDay();
      const hours = now.getHours();
      const minutes = now.getMinutes();
      const currentMinutes = hours * 60 + minutes;
      
      const marketOpen = 9 * 60 + 30;  // 9:30 AM
      const marketClose = 16 * 60;      // 4:00 PM
      
      const countdown = document.getElementById('countdown');
      const countdownLabel = document.getElementById('countdownLabel');
      
      if (day === 0 || day === 6) {
        const daysUntilMonday = day === 0 ? 1 : 2;
        const targetTime = new Date(now);
        targetTime.setDate(targetTime.getDate() + daysUntilMonday);
        targetTime.setHours(9, 30, 0, 0);
        
        const diff = targetTime - now;
        countdown.textContent = formatCountdown(diff);
        countdownLabel.textContent = 'until Monday';
        return;
      }
      
      if (currentMinutes >= marketOpen && currentMinutes < marketClose) {
        // Market is OPEN
        const closeTime = new Date(now);
        closeTime.setHours(16, 0, 0, 0);
        const diff = closeTime - now;
        countdown.textContent = formatCountdown(diff);
        countdownLabel.textContent = 'until close';
      } else {
        // Market is CLOSED
        const openTime = new Date(now);
        if (currentMinutes >= marketClose) {
          openTime.setDate(openTime.getDate() + 1);
        }
        openTime.setHours(9, 30, 0, 0);
        
        while (openTime.getDay() === 0 || openTime.getDay() === 6) {
          openTime.setDate(openTime.getDate() + 1);
        }
        
        const diff = openTime - now;
        countdown.textContent = formatCountdown(diff);
        countdownLabel.textContent = 'until open';
      }
    }

    function formatCountdown(ms) {
      if (ms < 0) return '00:00:00';
      
      const totalSeconds = Math.floor(ms / 1000);
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;
      
      return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    // Start countdown timer
    updateCountdown();
    setInterval(updateCountdown, 1000);

    // ============================================
    // SEARCH
    // ============================================
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');
    const searchClear = document.getElementById('search-clear');
    let searchPricesUpdating = false;

    searchInput.addEventListener('focus', async () => {
      showSearchResults(stockDatabase);
      
      // Update prices for visible stocks when search is focused
      if (!searchPricesUpdating) {
        searchPricesUpdating = true;
        const visibleSymbols = stockDatabase.slice(0, 20).map(s => s.symbol);
        await updateSearchResultPrices(visibleSymbols);
        showSearchResults(stockDatabase);
        searchPricesUpdating = false;
      }
    });

    searchInput.addEventListener('input', async (e) => {
      const query = e.target.value.trim().toUpperCase();
      
      if (query.length > 0) {
        searchClear.classList.add('visible');
        const results = stockDatabase.filter(stock => 
          stock.symbol.includes(query) || 
          stock.name.toUpperCase().includes(query)
        );
        showSearchResults(results);
        
        // Fetch real prices for filtered results
        if (results.length > 0 && results.length <= 10) {
          const symbols = results.map(s => s.symbol);
          await updateSearchResultPrices(symbols);
          const updatedResults = stockDatabase.filter(stock => 
            stock.symbol.includes(query) || 
            stock.name.toUpperCase().includes(query)
          );
          showSearchResults(updatedResults);
        }
      } else {
        searchClear.classList.remove('visible');
        showSearchResults(stockDatabase);
      }
    });

    document.addEventListener('click', (e) => {
      if (!e.target.closest('.wl-search-container')) {
        searchResults.classList.remove('visible');
      }
    });

    function clearSearch() {
      searchInput.value = '';
      searchClear.classList.remove('visible');
      searchResults.classList.remove('visible');
      searchInput.focus();
    }

    function showSearchResults(stocks) {
      if (stocks.length === 0) {
        searchResults.innerHTML = '<div class="wl-no-results">No stocks found</div>';
      } else {
        searchResults.innerHTML = stocks.map(stock => {
          const isInWatchlist = watchlist.some(s => s.symbol === stock.symbol);
          const isUp = stock.changePercent >= 0;
          
          return `
            <div class="wl-search-result" onclick="event.stopPropagation()">
              <div class="wl-result-info">
                <span class="wl-result-symbol">${stock.symbol}</span>
                <span class="wl-result-name">${stock.name}</span>
              </div>
              <div class="wl-result-sparkline" data-symbol="${stock.symbol}">
                ${generateFallbackSparkline(stock.trend, 80, 30)}
              </div>
              <div class="wl-result-price-col">
                <div class="wl-result-price">$${stock.price.toFixed(2)}</div>
                <div class="wl-result-change ${isUp ? 'up' : 'down'}">
                  ${isUp ? '+' : ''}${stock.changePercent.toFixed(2)}%
                </div>
              </div>
              <button class="wl-star-btn ${isInWatchlist ? 'active' : ''}" onclick="toggleWatchlist('${stock.symbol}', this)">
                <svg class="star-empty" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
                <svg class="star-filled" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
              </button>
            </div>
          `;
        }).join('');
        
        // Load real sparklines for visible search results
        loadSearchSparklines(stocks.slice(0, 10));
      }
      searchResults.classList.add('visible');
    }
    
    async function loadSearchSparklines(stocks) {
      for (const stock of stocks) {
        const el = document.querySelector(`.wl-result-sparkline[data-symbol="${stock.symbol}"]`);
        if (el) {
          const prices = await fetchSparklineData(stock.symbol);
          if (prices && prices.length > 0) {
            el.innerHTML = generateSparklineFromPrices(prices, 80, 30);
          }
        }
      }
    }

    // ============================================
    // WATCHLIST
    // ============================================
    function toggleWatchlist(symbol, buttonEl) {
      const stockIndex = watchlist.findIndex(s => s.symbol === symbol);
      
      if (stockIndex > -1) {
        watchlist.splice(stockIndex, 1);
        buttonEl.classList.remove('active');
        showToast(`${symbol} removed`, 'removed');
      } else {
        const stock = stockDatabase.find(s => s.symbol === symbol);
        if (stock) {
          watchlist.push(stock);
          buttonEl.classList.add('active');
          showToast(`${symbol} added`, 'success');
          
          // Close dropdown after adding
          searchResults.classList.remove('visible');
          searchInput.value = '';
          searchInput.blur();
          searchClear.classList.remove('visible');
        }
      }
      
      saveUserData();
      renderWatchlist();
    }

    function removeFromWatchlist(symbol) {
      watchlist = watchlist.filter(s => s.symbol !== symbol);
      saveUserData();
      renderWatchlist();
      showToast(`${symbol} removed`, 'removed');
    }

    function renderWatchlist() {
      const container = document.getElementById('watchlist-content');
      
      // Guard against missing element
      if (!container) {
        console.log('Watchlist container not found, skipping render');
        return;
      }
      
      if (watchlist.length === 0) {
        container.innerHTML = `
          <div class="wl-empty">
            <div class="wl-empty-icon">‚≠ê</div>
            <h3>Your watchlist is empty</h3>
            <p>Search for stocks and tap the star to add them</p>
          </div>
        `;
        updatePortfolioTotal();
        return;
      }
      
      // Gather all symbols for Alpaca snapshots
      const symbols = watchlist.map(s => s.symbol);
      if (symbols.length === 0) {
        container.innerHTML = '';
        updatePortfolioTotal();
        return;
      }
      
      // Fetch Alpaca snapshots for all symbols
      fetch(`/api/market/snapshots?symbols=${symbols.join(',')}`)
        .then(res => res.json())
        .then(marketData => {
          container.innerHTML = watchlist.map(stock => {
            const snapshot = marketData.snapshots?.[stock.symbol] || null;
            const livePrice = snapshot?.price || stock.price;
            const liveChange = snapshot?.change || (stock.price - (stock.price / (1 + stock.changePercent / 100)));
            const liveChangePercent = snapshot?.changePercent || stock.changePercent;
            const isUp = liveChangePercent >= 0;
            const position = positions[stock.symbol];
            const hasPosition = position && position.shares > 0;
            const shares = hasPosition ? position.shares : 0;
            const sharesDisplay = valuesHidden ? '<span class="hidden-stars">‚òÖ‚òÖ‚òÖ</span>' : (shares + ' shares');
            
            return `
              <div class="wl-stock-row" onclick="openModal('${stock.symbol}')">
                <div class="wl-stock-info">
                  <span class="wl-stock-symbol">${stock.symbol}</span>
                  <span class="wl-stock-name">${hasPosition ? sharesDisplay : stock.name}</span>
                </div>
                <div class="wl-stock-sparkline" data-symbol="${stock.symbol}">
                  ${generateFallbackSparkline(stock.trend, 80, 32)}
                </div>
                <div class="wl-stock-price-col">
                  <div class="wl-stock-price">$${parseFloat(livePrice).toFixed(2)}</div>
                  <div class="wl-stock-change ${isUp ? 'up' : 'down'}">
                    ${isUp ? '+' : ''}${parseFloat(liveChangePercent).toFixed(2)}%
                  </div>
                </div>
                <button class="wl-remove-btn" onclick="event.stopPropagation(); removeFromWatchlist('${stock.symbol}')" title="Remove">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                  </svg>
                </button>
              </div>
            `;
          }).join('');
          
          // Load real sparklines asynchronously
          loadWatchlistSparklines();
          
          updatePortfolioTotal();
        })
        .catch(() => {
          // Fallback: render with cached data if API fails
          container.innerHTML = watchlist.map(stock => {
            const isUp = stock.changePercent >= 0;
            const position = positions[stock.symbol];
            const hasPosition = position && position.shares > 0;
            const shares = hasPosition ? position.shares : 0;
            const sharesDisplay = valuesHidden ? '<span class="hidden-stars">‚òÖ‚òÖ‚òÖ</span>' : (shares + ' shares');
            
            return `
              <div class="wl-stock-row" onclick="openModal('${stock.symbol}')">
                <div class="wl-stock-info">
                  <span class="wl-stock-symbol">${stock.symbol}</span>
                  <span class="wl-stock-name">${hasPosition ? sharesDisplay : stock.name}</span>
                </div>
                <div class="wl-stock-sparkline" data-symbol="${stock.symbol}">
                  ${generateFallbackSparkline(stock.trend, 80, 32)}
                </div>
                <div class="wl-stock-price-col">
                  <div class="wl-stock-price">$${stock.price.toFixed(2)}</div>
                  <div class="wl-stock-change ${isUp ? 'up' : 'down'}">
                    ${isUp ? '+' : ''}${stock.changePercent.toFixed(2)}%
                  </div>
                </div>
                <button class="wl-remove-btn" onclick="event.stopPropagation(); removeFromWatchlist('${stock.symbol}')" title="Remove">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                  </svg>
                </button>
              </div>
            `;
          }).join('');
          
          loadWatchlistSparklines();
          updatePortfolioTotal();
        });
    }
    
    async function loadWatchlistSparklines() {
      const sparklineEls = document.querySelectorAll('.wl-stock-sparkline[data-symbol]');
      
      for (const el of sparklineEls) {
        const symbol = el.dataset.symbol;
        const prices = await fetchSparklineData(symbol);
        if (prices && prices.length > 0) {
          el.innerHTML = generateSparklineFromPrices(prices, 80, 32);
        }
      }
    }

    function updatePortfolioTotal() {
      let totalMarketValue = 0;
      let totalCost = 0;
      let todayChange = 0;
      
      watchlist.forEach(stock => {
        const position = positions[stock.symbol];
        if (position && position.shares > 0) {
          const currentValue = position.shares * stock.price;
          totalMarketValue += currentValue;
          totalCost += position.shares * position.avgCost;
          // Calculate today's change based on the stock's daily change percent
          // Yesterday's price = current price / (1 + changePercent/100)
          const yesterdayPrice = stock.price / (1 + stock.changePercent / 100);
          const yesterdayValue = position.shares * yesterdayPrice;
          todayChange += currentValue - yesterdayValue;
        }
      });
      
      const totalReturn = totalMarketValue - totalCost;
      const returnPercent = totalCost > 0 ? ((totalReturn / totalCost) * 100) : 0;
      const isGain = totalReturn >= 0;
      const todayPercent = totalMarketValue > 0 ? ((todayChange / (totalMarketValue - todayChange)) * 100) : 0;
      const isTodayGain = todayChange >= 0;
      
      const valueEl = document.getElementById('watchlist-total-value');
      const changeElToday = document.getElementById('watchlist-change-today');
      const changeElAlltime = document.getElementById('watchlist-change-alltime');
      
      // Guard against missing elements
      if (!valueEl) {
        console.log('Portfolio value element not found, skipping update');
        return;
      }
      
      // If hidden, show stars with gunmetal shine
      if (valuesHidden) {
        valueEl.innerHTML = '<span class="hidden-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>';
        if (changeElToday) changeElToday.innerHTML = '<span class="hidden-stars">‚òÖ‚òÖ‚òÖ‚òÖ</span>';
        if (changeElAlltime) changeElAlltime.innerHTML = '<span class="hidden-stars">‚òÖ‚òÖ‚òÖ‚òÖ</span>';
        return;
      }
      
      // Display total market value
      valueEl.textContent = '$' + totalMarketValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      
      // Display today's change (based on daily stock movements)
      if (changeElToday) {
        const todayText = (isTodayGain ? '+' : '-') + '$' + Math.abs(todayChange).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' (' + (isTodayGain ? '+' : '') + todayPercent.toFixed(2) + '%)';
        changeElToday.textContent = todayText;
        changeElToday.className = 'wl-today-change' + (isTodayGain ? '' : ' down');
      }
      
      // Display all-time change (profit/loss from cost basis)
      if (totalCost > 0) {
        const changeText = (isGain ? '+' : '-') + '$' + Math.abs(totalReturn).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' (' + (isGain ? '+' : '') + returnPercent.toFixed(2) + '%)';
        if (changeElAlltime) {
          changeElAlltime.textContent = changeText;
          changeElAlltime.className = 'wl-alltime-change' + (isGain ? '' : ' down');
        }
      } else {
        if (changeElAlltime) {
          changeElAlltime.textContent = '+$0.00 (0.00%)';
          changeElAlltime.className = 'wl-alltime-change';
        }
      }
    }

    function toggleCollapse() {
      const stockList = document.getElementById('watchlist-content');
      const collapseBtn = document.getElementById('collapse-btn');
      
      stockList.classList.toggle('collapsed');
      collapseBtn.classList.toggle('collapsed');
    }

    // ============================================
    // HIDE VALUES (EYE TOGGLE)
    // ============================================
    let valuesHidden = localStorage.getItem('valuesHidden') === 'true';

    function toggleHideValues() {
      valuesHidden = !valuesHidden;
      localStorage.setItem('valuesHidden', valuesHidden);
      applyHiddenState();
    }

    function applyHiddenState() {
      const eyeBtn = document.getElementById('eye-btn');
      
      if (valuesHidden) {
        eyeBtn.classList.add('hidden');
      } else {
        eyeBtn.classList.remove('hidden');
      }
      
      // Re-render to apply masking
      renderWatchlist();
    }

    // ============================================
    // VALUE DISPLAY TOGGLE ($ vs %)
    // ============================================
    let showPercentage = localStorage.getItem('showPercentage') === 'true';

    function toggleValueDisplay() {
      showPercentage = !showPercentage;
      localStorage.setItem('showPercentage', showPercentage);
      updateWatchlistTotal();
    }

    // ============================================
    // MARKET SPARKLINES
    // ============================================
    function renderMarketSparklines() {
      const markets = [
        { id: 'sp500-spark', trend: 'up' },
        { id: 'dow-spark', trend: 'up' },
        { id: 'nasdaq-spark', trend: 'down' },
        { id: 'russell-spark', trend: 'up' },
        { id: 'nyse-spark', trend: 'up' }
      ];
      
      markets.forEach(market => {
        const container = document.getElementById(market.id);
        if (container) {
          container.innerHTML = generateSparkline(market.trend, 110, 30);
        }
      });
    }

    // ============================================
    // TOAST
    // ============================================
    function showToast(message, type) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'wl-toast ' + type;
      setTimeout(() => toast.classList.add('visible'), 10);
      setTimeout(() => toast.classList.remove('visible'), 2500);
    }

    // ============================================
    // USER PROFILE PANEL
    // ============================================
    const userProfile = {
      name: 'User',
      email: 'user@example.com',
      joinDate: 'January 13, 2026'
    };

    function loadUserProfile() {
      // Get email from URL first (most reliable), then localStorage
      const urlParams = new URLSearchParams(window.location.search);
      let email = urlParams.get('email');
      
      // Decode the email if it came from URL
      if (email) {
        email = decodeURIComponent(email);
        // Save to localStorage for future visits
        localStorage.setItem('userEmail', email);
        console.log('Got email from URL:', email);
      } else {
        // Try localStorage
        email = localStorage.getItem('userEmail');
        console.log('Got email from localStorage:', email);
      }
      
      // Get first and last name from URL or localStorage
      let firstName = urlParams.get('firstName');
      let lastName = urlParams.get('lastName');
      
      if (firstName) {
        firstName = decodeURIComponent(firstName);
        localStorage.setItem('userFirstName', firstName);
      } else {
        firstName = localStorage.getItem('userFirstName');
      }
      
      if (lastName) {
        lastName = decodeURIComponent(lastName);
        localStorage.setItem('userLastName', lastName);
      } else {
        lastName = localStorage.getItem('userLastName');
      }
      
      // Get or set the member since date (only set once on first signup)
      let memberSinceDate = localStorage.getItem('userMemberSince');
      if (!memberSinceDate) {
        memberSinceDate = new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
        localStorage.setItem('userMemberSince', memberSinceDate);
      }
      
      console.log('EMAIL VALUE IS:', email);
      console.log('NAME:', firstName, lastName);
      
      // If we have first and last name, use them
      if (firstName && lastName) {
        userProfile.name = firstName + ' ' + lastName;
        userProfile.email = email || 'user@example.com';
        userProfile.joinDate = memberSinceDate;
        console.log('Updated profile with full name:', userProfile.name);
        
        // Force update immediately
        setTimeout(function() {
          document.getElementById('userName').textContent = firstName;
          // Only set initial avatar if no saved avatar exists
          const savedAvatar = JSON.parse(localStorage.getItem('userAvatar') || 'null');
          if (!savedAvatar) {
            document.getElementById('profileAvatar').textContent = firstName.charAt(0).toUpperCase();
          }
          document.getElementById('profileName').textContent = firstName;
          document.getElementById('infoName').textContent = firstName + ' ' + lastName;
          if (email) document.getElementById('infoEmail').textContent = email;
          console.log('FORCED UPDATE COMPLETE');
        }, 100);
      } else if (email && email !== 'user@example.com') {
        // Fallback: extract name from email
        userProfile.email = email;
        const namePart = email.split('@')[0];
        userProfile.name = namePart
          .replace(/[._]/g, ' ')
          .split(' ')
          .map(word => word.charAt(0).toUpperCase() + word.slice(1))
          .join(' ');
        userProfile.joinDate = memberSinceDate;
        console.log('Updated profile from email - Name:', userProfile.name);
        
        // Force update immediately
        setTimeout(function() {
          document.getElementById('userName').textContent = userProfile.name;
          // Only set initial avatar if no saved avatar exists
          const savedAvatar = JSON.parse(localStorage.getItem('userAvatar') || 'null');
          if (!savedAvatar) {
            document.getElementById('profileAvatar').textContent = userProfile.name.charAt(0).toUpperCase();
          }
          document.getElementById('profileName').textContent = userProfile.name;
          document.getElementById('infoName').textContent = userProfile.name;
          document.getElementById('infoEmail').textContent = userProfile.email;
          console.log('FORCED UPDATE COMPLETE');
        }, 100);
      }
      
      // Update the display immediately
      updateProfileDisplay();
      checkSubscriptionStatus();
    }

    function checkSubscriptionStatus() {
      // For now, we'll mark user as subscribed if they just paid
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('payment') === 'success') {
        // Add subscription badge to profile
        userProfile.subscribed = true;
        localStorage.setItem('apehub_user_profile', JSON.stringify(userProfile));
      } else {
        // Check if already subscribed
        if (userProfile.subscribed) {
          console.log('User has active subscription');
        }
      }
    }

    function updateProfileDisplay() {
      console.log('Updating profile display with:', userProfile);
      const initial = userProfile.name.charAt(0).toUpperCase();
      
      // Update all profile elements
      const userNameEl = document.getElementById('userName');
      const profileAvatarEl = document.getElementById('profileAvatar');
      const profileNameEl = document.getElementById('profileName');
      const infoNameEl = document.getElementById('infoName');
      const infoEmailEl = document.getElementById('infoEmail');
      const infoJoinedEl = document.getElementById('infoJoined');
      
      if (userNameEl) userNameEl.textContent = userProfile.name;
      // Only set initial avatar if no saved avatar exists
      const savedAvatar = JSON.parse(localStorage.getItem('userAvatar') || 'null');
      if (profileAvatarEl && !savedAvatar) profileAvatarEl.textContent = initial;
      if (profileNameEl) profileNameEl.textContent = userProfile.name;
      if (infoNameEl) infoNameEl.textContent = userProfile.name;
      if (infoEmailEl) infoEmailEl.textContent = userProfile.email;
      if (infoJoinedEl) infoJoinedEl.textContent = userProfile.joinDate;
      
      console.log('Profile display updated!');
    }

    function openProfile() {
      document.getElementById('profileOverlay').classList.add('active');
      document.getElementById('profilePanel').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeProfile() {
      document.getElementById('profileOverlay').classList.remove('active');
      document.getElementById('profilePanel').classList.remove('active');
      document.body.style.overflow = '';
    }

    // ============================================
    // AVATAR SELECTOR (DICEBEAR AVATAAARS - 3D CARTOON STYLE)
    // ============================================
    let avatarVariations = [];
    let avatarShuffleSeed = Date.now();
    
    function generateAvatarUrl(seed) {
      // Using avataaars style for fun 3D cartoon characters like TradeZella
      return `https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(seed)}&size=120&backgroundColor=b6e3f4,c0aede,d1d4f9,ffd5dc,ffdfbf`;
    }
    
    function generateVariations(count = 12) {
      const variations = [];
      const userId = userProfile.email || 'user';
      for (let i = 0; i < count; i++) {
        const seed = `${userId}-${avatarShuffleSeed}-${i}`;
        variations.push({
          seed: seed,
          url: generateAvatarUrl(seed)
        });
      }
      return variations;
    }
    
    function initAvatarSelector() {
      avatarVariations = generateVariations();
      renderVariations();
    }
    
    function renderVariations() {
      const grid = document.getElementById('avatarVariationsGrid');
      const savedAvatar = JSON.parse(localStorage.getItem('userAvatar') || 'null');
      
      grid.innerHTML = avatarVariations.map(v => `
        <div class="avatar-variation ${savedAvatar?.seed === v.seed ? 'selected' : ''}" 
             onclick="selectVariation('${v.seed}', '${v.url}', event)">
          <img src="${v.url}" alt="">
        </div>
      `).join('');
    }
    
    function selectVariation(seed, url, evt) {
      const avatarData = { 
        type: 'dicebear', 
        value: url, 
        seed: seed 
      };
      localStorage.setItem('userAvatar', JSON.stringify(avatarData));
      updateAvatarDisplay(avatarData);
      
      document.querySelectorAll('.avatar-variation').forEach(v => v.classList.remove('selected'));
      if (evt) evt.target.closest('.avatar-variation')?.classList.add('selected');
      
      closeAvatarSelector();
      showToast('Avatar updated!', 'success');
    }
    
    function shuffleVariations() {
      avatarShuffleSeed = Date.now();
      avatarVariations = generateVariations();
      renderVariations();
    }
    
    function openAvatarSelector() {
      initAvatarSelector();
      document.getElementById('avatarModalOverlay').classList.add('active');
    }
    
    function closeAvatarSelector(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('avatarModalOverlay').classList.remove('active');
    }
    
    function handleAvatarUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      // Validate file type
      if (!file.type.startsWith('image/')) {
        showToast('Please select an image file', 'error');
        return;
      }
      
      // Validate file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        showToast('Image must be under 5MB', 'error');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        // Compress and resize image
        const img = new Image();
        img.onload = function() {
          const canvas = document.createElement('canvas');
          const size = 200; // Output size
          canvas.width = size;
          canvas.height = size;
          const ctx = canvas.getContext('2d');
          
          // Draw circular crop
          ctx.beginPath();
          ctx.arc(size/2, size/2, size/2, 0, Math.PI * 2);
          ctx.closePath();
          ctx.clip();
          
          // Calculate crop to center
          const minDim = Math.min(img.width, img.height);
          const sx = (img.width - minDim) / 2;
          const sy = (img.height - minDim) / 2;
          
          ctx.drawImage(img, sx, sy, minDim, minDim, 0, 0, size, size);
          
          const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.8);
          const avatarData = { type: 'image', value: compressedDataUrl };
          localStorage.setItem('userAvatar', JSON.stringify(avatarData));
          updateAvatarDisplay(avatarData);
          closeAvatarSelector();
          showToast('Avatar updated!', 'success');
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
      
      // Reset input so same file can be selected again
      event.target.value = '';
    }
    
    function updateAvatarDisplay(avatarData) {
      const profileAvatarEl = document.getElementById('profileAvatar');
      if (!profileAvatarEl) return;
      
      if (!avatarData) {
        // Show initial letter
        const initial = userProfile.name ? userProfile.name.charAt(0).toUpperCase() : 'U';
        profileAvatarEl.innerHTML = initial;
        profileAvatarEl.className = 'profile-avatar';
        return;
      }
      
      if (avatarData.type === 'image' || avatarData.type === 'boring' || avatarData.type === 'dicebear' || avatarData.type === 'trading' || avatarData.type === 'multiavatar') {
        profileAvatarEl.innerHTML = `<img src="${avatarData.value}" alt="Avatar">`;
        profileAvatarEl.className = 'profile-avatar has-image';
      }
    }
    
    function loadSavedAvatar() {
      const savedAvatar = JSON.parse(localStorage.getItem('userAvatar') || 'null');
      if (savedAvatar) {
        updateAvatarDisplay(savedAvatar);
      }
    }

    // ============================================
    // SUPPORT CHAT
    // ============================================
    let chatMessages = [];

    function loadChatMessages() {
      const saved = localStorage.getItem('apehub_support_chat');
      if (saved) {
        chatMessages = JSON.parse(saved);
        renderChatMessages();
      }
    }

    function saveChatMessages() {
      localStorage.setItem('apehub_support_chat', JSON.stringify(chatMessages));
    }

    function renderChatMessages() {
      const container = document.getElementById('chatMessages');
      container.innerHTML = `
        <div class="chat-message support">
          Hi! üëã Welcome to ApeHub support. How can I help you today?
          <div class="chat-message-time">Support Team</div>
        </div>
      `;
      
      chatMessages.forEach(msg => {
        const div = document.createElement('div');
        div.className = `chat-message ${msg.type}`;
        div.innerHTML = `
          ${msg.text}
          <div class="chat-message-time">${msg.time}</div>
        `;
        container.appendChild(div);
      });
      
      container.scrollTop = container.scrollHeight;
    }

    function sendSupportMessage() {
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      if (!text) return;

      const now = new Date();
      const time = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

      // Add user message
      chatMessages.push({ type: 'user', text, time });
      input.value = '';
      renderChatMessages();
      saveChatMessages();

      // Simulate support response after delay
      setTimeout(() => {
        const responses = [
          "Thanks for reaching out! üôå I've noted your concern and our team will look into it right away.",
          "Got it! We appreciate you taking the time to message us. Is there anything else I can help with today?",
          "Thank you for your message! Our team typically responds within 24 hours for detailed inquiries. We'll get back to you soon!",
          "I understand completely. Let me check on that for you. You'll receive an update via email shortly. üìß",
          "Thanks for letting us know! We're always working to improve ApeHub and feedback like yours helps a lot.",
          "Great question! Let me look into that for you. In the meantime, feel free to browse our FAQ section for quick answers.",
          "Appreciate you reaching out! üíú Our support team has been notified and will follow up with you shortly.",
          "Hey there! Thanks for the message. I'm forwarding this to our specialists who can better assist you.",
          "Thanks for your patience! We're currently experiencing high volume but rest assured, we'll get to your inquiry ASAP.",
          "Noted! ‚úÖ We value your input and will use it to make ApeHub even better. Anything else on your mind?"
        ];
        const response = responses[Math.floor(Math.random() * responses.length)];
        
        chatMessages.push({ type: 'support', text: response, time: 'Support Team' });
        renderChatMessages();
        saveChatMessages();
      }, 1000 + Math.random() * 1500);
    }

    function handleChatKeypress(e) {
      if (e.key === 'Enter') {
        sendSupportMessage();
      }
    }

    function handleLogout() {
      if (confirm('Are you sure you want to sign out?')) {
        closeProfile();
        window.location.href = 'landing.html';
      }
    }

    // ============================================
    // THEME SWITCHING
    // ============================================
    function loadTheme() {
      const savedTheme = localStorage.getItem('apehub_theme') || 'dark';
      document.documentElement.setAttribute('data-theme', savedTheme);
      const toggle = document.getElementById('themeToggle');
      const label = document.getElementById('themeLabel');
      if (toggle) {
        toggle.checked = savedTheme === 'light';
      }
      if (label) {
        label.textContent = savedTheme === 'light' ? 'Light mode' : 'Dark mode';
      }
    }

    function toggleTheme() {
      const toggle = document.getElementById('themeToggle');
      const newTheme = toggle.checked ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('apehub_theme', newTheme);
      document.getElementById('themeLabel').textContent = newTheme === 'light' ? 'Light mode' : 'Dark mode';
    }

    // Load saved theme from localStorage
    (function() {
      const savedTheme = localStorage.getItem('apehub_theme') || 'dark';
      document.documentElement.setAttribute('data-theme', savedTheme);
    })();

    // ============================================
    // INITIALIZE
    // ============================================
    
    // Logo click - single click goes home, 5 rapid taps goes to admin
    let logoTapCount = 0;
    let logoTapTimer = null;
    let logoClickTimer = null;
    document.getElementById('apehubLogo')?.addEventListener('click', (e) => {
      e.preventDefault();
      logoTapCount++;
      clearTimeout(logoTapTimer);
      clearTimeout(logoClickTimer);
      
      if (logoTapCount >= 5) {
        logoTapCount = 0;
        window.location.href = '/admin/admin.html';
        return;
      }
      
      // Wait a moment to see if more taps are coming
      logoClickTimer = setTimeout(() => {
        if (logoTapCount < 5) {
          window.location.href = '/landing.html';
        }
        logoTapCount = 0;
      }, 300);
      
      logoTapTimer = setTimeout(() => { logoTapCount = 0; }, 1500);
    });
    
    document.addEventListener('DOMContentLoaded', async function() {
      renderMarketSparklines();
      
      // Load user data from server first
      await loadUserData();
      
      renderWatchlist();
      applyHiddenState();
      loadUserProfile();
      loadSavedAvatar();
      loadChatMessages();
      loadTheme();
      
      // Fetch real-time data immediately (force update)
      updateIndices();
      updateWatchlistPrices(true); // Force update on page load
      fetchFuturesData();
      
      // Update popular stocks in search database
      const popularStocks = ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'TSLA', 'META', 'NVDA', 'SPY', 'QQQ', 'AMD'];
      updateSearchResultPrices(popularStocks);
      
      // Auto-refresh every 5 seconds
      setInterval(() => {
        updateIndices();
        updateWatchlistPrices(true);
        fetchFuturesData();
      }, 60000);
    });
  </script>
</body>
</html>